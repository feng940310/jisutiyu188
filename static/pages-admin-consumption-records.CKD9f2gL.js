import{t as a,k as t,c as e,R as l,I as s,K as u,V as n,M as o,S as c}from"./uni.CnKTWU0K.js";import{o as d,Z as i}from"./index-C3v_m0JD.js";import{d as r,b as f,c as _,R as m,a6 as v,ad as p,a7 as g,M as h,aP as y,_ as b,u as k,aY as D,aN as C,aW as w,az as A,ak as S}from"./vendor.CqD9dFNX.js";import{_ as F}from"./_plugin-vue_export-helper.BCo6x5W8.js";const M=F(r({__name:"consumption-records",setup(r){const F=f(0),M=J(new Date),T=f(M),x=f(M),O=f([]),j=f(!0),B=f(""),U=f(1),N=f(20),V=f(!0),R=f(0),Y=f(0),$=f({totalOriginalAmount:0,totalFinalAmount:0,totalCouponDeduction:0,totalBalanceDeduction:0,couponUsageCount:0,paymentMethodStats:{}}),z=_((()=>{const a=$.value.paymentMethodStats;return a&&"object"==typeof a&&Object.keys(a).length>0}));m((()=>{I(),K(),X()})),d((()=>{K()}));const I=()=>{const t=a();F.value=t.statusBarHeight||0},K=async()=>{try{const a=t("token");if(!a)return e({title:"请先登录",icon:"none"}),void setTimeout((()=>{l()}),1500);const{result:s}=await i.callFunction({name:"user",data:{action:"checkAdminStatus",token:a}});return!(!s||0!==s.code||!s.is_admin)||(e({title:"无管理员权限",icon:"none"}),setTimeout((()=>{l()}),1500),!1)}catch(a){return console.error("检查管理员权限失败:",a),e({title:"权限检查失败",icon:"none"}),setTimeout((()=>{l()}),1500),!1}},q=async(a=!1)=>{a||(j.value=!0,U.value=1,O.value=[]);try{const s=t("token");if(!s)return e({title:"请先登录",icon:"none"}),void setTimeout((()=>{l()}),1500);const{result:u}=await i.callFunction({name:"recharge",data:{action:"getConsumptionRecords",token:s,data:{startDate:T.value,endDate:x.value,searchKeyword:B.value,page:U.value,pageSize:N.value}}});u&&0===u.code?(O.value=a?[...O.value,...u.data.records]:u.data.records,R.value=u.data.totalCount||0,Y.value=u.data.totalAmount||0,V.value=O.value.length<R.value,u.data.statistics?$.value={totalOriginalAmount:u.data.statistics.totalOriginalAmount||0,totalFinalAmount:u.data.statistics.totalFinalAmount||0,totalCouponDeduction:u.data.statistics.totalCouponDeduction||0,totalBalanceDeduction:u.data.statistics.totalBalanceDeduction||0,couponUsageCount:u.data.statistics.couponUsageCount||0,paymentMethodStats:u.data.statistics.paymentMethodStats||{}}:$.value={totalOriginalAmount:0,totalFinalAmount:0,totalCouponDeduction:0,totalBalanceDeduction:0,couponUsageCount:0,paymentMethodStats:{}}):u&&401===u.code?(e({title:"请先登录",icon:"none"}),setTimeout((()=>{l()}),1500)):u&&403===u.code?(e({title:"无管理员权限",icon:"none"}),setTimeout((()=>{l()}),1500)):e({title:(null==u?void 0:u.msg)||"获取数据失败",icon:"none"})}catch(s){console.error("获取消费记录失败:",s),e({title:"获取数据失败",icon:"none"})}finally{j.value=!1}},H=()=>{V.value&&!j.value&&(U.value++,q(!0))},P=()=>{U.value=1,q()},W=a=>{T.value=a.detail.value,new Date(T.value)>new Date(x.value)&&(x.value=T.value),q()},Z=a=>{x.value=a.detail.value,new Date(x.value)<new Date(T.value)&&(T.value=x.value),q()},E=()=>{l()};function G(a){const t="string"==typeof a?parseFloat(a):a;return isNaN(t)||null==t?"0.00":Number(t).toFixed(2)}function J(a){return`${a.getFullYear()}-${String(a.getMonth()+1).padStart(2,"0")}-${String(a.getDate()).padStart(2,"0")}`}function L(a){const t=new Date;return t.setDate(t.getDate()-a),J(t)}function Q(a){return{balance:"余额支付",wechat:"微信支付",alipay:"支付宝",free:"免费"}[a]||a}const X=()=>{T.value=M,x.value=M,q()},aa=()=>{const a=L(1);T.value=a,x.value=a,q()},ta=()=>{const a=L(((new Date).getDay()||7)-1);T.value=a,x.value=M,q()},ea=()=>{const a=new Date,t=a.getFullYear(),e=a.getMonth(),l=J(new Date(t,e,1));T.value=l,x.value=M,q()};return(a,t)=>{const e=s,l=u,d=n,i=o,r=c;return g(),v(e,{class:"consumption-records"},{default:p((()=>[h(e,{class:"page-background"}),h(e,{class:"custom-navbar",style:y({paddingTop:F.value+"px"})},{default:p((()=>[h(e,{class:"navbar-left",onClick:E},{default:p((()=>[h(e,{class:"back-icon"}),h(l,null,{default:p((()=>[b("返回")])),_:1})])),_:1}),h(e,{class:"navbar-title"},{default:p((()=>[b("消费记录管理")])),_:1}),h(e,{class:"navbar-right"})])),_:1},8,["style"]),h(e,{class:"content-container",style:y({paddingTop:F.value+64+"px"})},{default:p((()=>[h(e,{class:"filter-section"},{default:p((()=>[h(e,{class:"date-range"},{default:p((()=>[h(d,{mode:"date",value:T.value,end:k(M),onChange:W},{default:p((()=>[h(e,{class:"date-picker"},{default:p((()=>[h(l,{class:"label"},{default:p((()=>[b("开始日期")])),_:1}),h(l,{class:"value"},{default:p((()=>[b(D(T.value),1)])),_:1})])),_:1})])),_:1},8,["value","end"]),h(l,{class:"separator"},{default:p((()=>[b("至")])),_:1}),h(d,{mode:"date",value:x.value,end:k(M),onChange:Z},{default:p((()=>[h(e,{class:"date-picker"},{default:p((()=>[h(l,{class:"label"},{default:p((()=>[b("结束日期")])),_:1}),h(l,{class:"value"},{default:p((()=>[b(D(x.value),1)])),_:1})])),_:1})])),_:1},8,["value","end"])])),_:1}),h(e,{class:"search-actions"},{default:p((()=>[h(i,{class:"search-input",type:"text",modelValue:B.value,"onUpdate:modelValue":t[0]||(t[0]=a=>B.value=a),placeholder:"用户名/手机号",onConfirm:P},null,8,["modelValue"]),h(e,{class:"search-btn",onClick:P},{default:p((()=>[b("搜索")])),_:1}),h(e,{class:"refresh-btn",onClick:q},{default:p((()=>[b("刷新")])),_:1})])),_:1})])),_:1}),h(e,{class:"quick-date-filters"},{default:p((()=>[h(e,{class:"date-filter-btn",onClick:X},{default:p((()=>[b("今天")])),_:1}),h(e,{class:"date-filter-btn",onClick:aa},{default:p((()=>[b("昨天")])),_:1}),h(e,{class:"date-filter-btn",onClick:ta},{default:p((()=>[b("本周")])),_:1}),h(e,{class:"date-filter-btn",onClick:ea},{default:p((()=>[b("本月")])),_:1})])),_:1}),h(e,{class:"records-container"},{default:p((()=>[h(e,{class:"records-header"},{default:p((()=>[h(l,{class:"header-item user"},{default:p((()=>[b("用户")])),_:1}),h(l,{class:"header-item amount"},{default:p((()=>[b("金额")])),_:1}),h(l,{class:"header-item coupon"},{default:p((()=>[b("优惠券")])),_:1}),h(l,{class:"header-item payment"},{default:p((()=>[b("支付方式")])),_:1})])),_:1}),h(r,{"scroll-y":"true",class:"records-list",onScrolltolower:H},{default:p((()=>[j.value?(g(),v(e,{key:0,class:"loading"},{default:p((()=>[b("加载中...")])),_:1})):0===O.value.length?(g(),v(e,{key:1,class:"no-data"},{default:p((()=>[b("没有找到消费记录")])),_:1})):(g(!0),C(A,{key:2},S(O.value,((a,t)=>(g(),v(e,{class:"record-item",key:a._id},{default:p((()=>[h(e,{class:"item-cell user"},{default:p((()=>[h(l,{class:"nickname"},{default:p((()=>[b(D(a.user_info.nickname),1)])),_:2},1024),h(l,{class:"mobile"},{default:p((()=>{return[b(D((t=a.user_info.mobile,t?t.substring(0,3)+"****"+t.substring(7):"")),1)];var t})),_:2},1024)])),_:2},1024),h(e,{class:"item-cell amount"},{default:p((()=>[h(l,{class:"final-amount"},{default:p((()=>[b("¥"+D(G(a.final_amount||a.amount)),1)])),_:2},1024),a.original_amount&&a.original_amount>(a.final_amount||a.amount)?(g(),v(l,{key:0,class:"original-amount"},{default:p((()=>[b("原价¥"+D(G(a.original_amount)),1)])),_:2},1024)):w("",!0)])),_:2},1024),h(l,{class:"item-cell coupon"},{default:p((()=>[b(D(a.coupon_amount?"¥"+G(a.coupon_amount):"-"),1)])),_:2},1024),h(l,{class:"item-cell payment"},{default:p((()=>[b(D(Q(a.payment_method)),1)])),_:2},1024)])),_:2},1024)))),128)),!j.value&&V.value?(g(),v(e,{key:3,class:"load-more"},{default:p((()=>[h(l,{onClick:H},{default:p((()=>[b("加载更多")])),_:1})])),_:1})):w("",!0)])),_:1})])),_:1}),h(e,{class:"stats-section"},{default:p((()=>[h(e,{class:"basic-stats"},{default:p((()=>[h(e,{class:"stat-item"},{default:p((()=>[h(l,{class:"label"},{default:p((()=>[b("总记录：")])),_:1}),h(l,{class:"value"},{default:p((()=>[b(D(R.value),1)])),_:1})])),_:1}),h(e,{class:"stat-item"},{default:p((()=>[h(l,{class:"label"},{default:p((()=>[b("总金额：")])),_:1}),h(l,{class:"value"},{default:p((()=>[b("¥"+D(G(Y.value)),1)])),_:1})])),_:1})])),_:1}),h(e,{class:"detailed-stats"},{default:p((()=>[h(e,{class:"stats-title"},{default:p((()=>[b("详细统计")])),_:1}),h(e,{class:"amount-stats"},{default:p((()=>[h(e,{class:"stat-row"},{default:p((()=>[h(e,{class:"stat-item"},{default:p((()=>[h(l,{class:"label"},{default:p((()=>[b("原价总额：")])),_:1}),h(l,{class:"value"},{default:p((()=>[b("¥"+D(G($.value.totalOriginalAmount)),1)])),_:1})])),_:1}),h(e,{class:"stat-item"},{default:p((()=>[h(l,{class:"label"},{default:p((()=>[b("实付总额：")])),_:1}),h(l,{class:"value"},{default:p((()=>[b("¥"+D(G($.value.totalFinalAmount)),1)])),_:1})])),_:1})])),_:1}),h(e,{class:"stat-row"},{default:p((()=>[h(e,{class:"stat-item"},{default:p((()=>[h(l,{class:"label"},{default:p((()=>[b("余额扣减：")])),_:1}),h(l,{class:"value highlight-balance"},{default:p((()=>[b("¥"+D(G($.value.totalBalanceDeduction)),1)])),_:1})])),_:1}),h(e,{class:"stat-item"},{default:p((()=>[h(l,{class:"label"},{default:p((()=>[b("消费券扣减：")])),_:1}),h(l,{class:"value highlight-coupon"},{default:p((()=>[b("¥"+D(G($.value.totalCouponDeduction)),1)])),_:1})])),_:1})])),_:1}),h(e,{class:"stat-row"},{default:p((()=>[h(e,{class:"stat-item"},{default:p((()=>[h(l,{class:"label"},{default:p((()=>[b("消费券使用次数：")])),_:1}),h(l,{class:"value"},{default:p((()=>[b(D($.value.couponUsageCount),1)])),_:1})])),_:1}),h(e,{class:"stat-item"},{default:p((()=>[h(l,{class:"label"},{default:p((()=>[b("节省金额：")])),_:1}),h(l,{class:"value highlight-savings"},{default:p((()=>[b("¥"+D(G($.value.totalOriginalAmount-$.value.totalFinalAmount)),1)])),_:1})])),_:1})])),_:1})])),_:1}),z.value?(g(),v(e,{key:0,class:"payment-method-stats"},{default:p((()=>[h(e,{class:"stats-subtitle"},{default:p((()=>[b("支付方式统计")])),_:1}),h(e,{class:"payment-methods"},{default:p((()=>[(g(!0),C(A,null,S($.value.paymentMethodStats,((a,t)=>(g(),v(e,{class:"payment-method-item",key:t},{default:p((()=>[h(e,{class:"method-name"},{default:p((()=>[b(D(Q(t)),1)])),_:2},1024),h(e,{class:"method-stats"},{default:p((()=>[h(l,{class:"method-count"},{default:p((()=>[b(D(a.count)+"笔",1)])),_:2},1024),h(l,{class:"method-amount"},{default:p((()=>[b("¥"+D(G(a.amount)),1)])),_:2},1024)])),_:2},1024)])),_:2},1024)))),128))])),_:1})])),_:1})):w("",!0)])),_:1})])),_:1})])),_:1},8,["style"])])),_:1})}}}),[["__scopeId","data-v-9bf2fa5a"]]);export{M as default};
