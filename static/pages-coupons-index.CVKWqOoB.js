import{p as e,k as a,c as s,R as l,I as t,K as u,S as n}from"./uni.CnKTWU0K.js";import{Z as o}from"./index-C3v_m0JD.js";import{d as c,b as d,c as r,R as i,a6 as v,ad as p,aP as f,a7 as _,M as g,_ as m,aN as y,az as h,ak as k,aX as x,aW as b,aY as S}from"./vendor.CqD9dFNX.js";import{_ as w}from"./_plugin-vue_export-helper.BCo6x5W8.js";const j=w(c({__name:"index",setup(c){const w=d(20),j=d("unused"),C=d([]),T=d(!1),z=d(!1),F=d(!0),R=d(1),$=d({unused:0,used:0,expired:0}),D=r((()=>[{label:"æœªä½¿ç”¨",value:"unused",count:$.value.unused},{label:"å·²ä½¿ç”¨",value:"used",count:$.value.used},{label:"å·²è¿‡æœŸ",value:"expired",count:$.value.expired}]));i((()=>{e({success:e=>{w.value=e.statusBarHeight||20},fail:()=>{w.value=20}}),I(),L()}));const I=async(e=!1)=>{if(!T.value){e&&(R.value=1,F.value=!0,C.value=[]),T.value=!0;try{const t=a("token");if(!t)return s({title:"è¯·å…ˆç™»å½•",icon:"none"}),void setTimeout((()=>{l()}),1500);console.log("è°ƒç”¨äº‘å‡½æ•°èŽ·å–ä¼˜æƒ åˆ¸åˆ—è¡¨ï¼Œå‚æ•°:",{action:"getList",status:j.value,page:R.value,pageSize:20,token:t?t.substring(0,10)+"...":"null"});const{result:u}=await o.callFunction({name:"coupon",data:{action:"getList",status:j.value,page:R.value,pageSize:20,token:t}});if(console.log("äº‘å‡½æ•°è¿”å›žç»“æžœ:",u),u&&0===u.code){const a=u.data.list||[];e?C.value=a:C.value.push(...a),F.value=a.length>=20,F.value&&R.value++}else s({title:(null==u?void 0:u.message)||"åŠ è½½å¤±è´¥",icon:"none"})}catch(t){console.error("åŠ è½½ä¼˜æƒ åˆ¸åˆ—è¡¨å¤±è´¥:",t),s({title:"åŠ è½½å¤±è´¥",icon:"none"})}finally{T.value=!1,z.value&&(z.value=!1)}}},L=async()=>{var e,s,l;try{const t=a("token");if(!t)return void console.log("æœªæ‰¾åˆ°tokenï¼Œè·³è¿‡èŽ·å–ç»Ÿè®¡");const{result:u}=await o.callFunction({name:"coupon",data:{action:"getCount",token:t}});u&&0===u.code&&($.value={unused:(null==(e=u.data)?void 0:e.unused)||0,used:(null==(s=u.data)?void 0:s.used)||0,expired:(null==(l=u.data)?void 0:l.expired)||0})}catch(t){console.error("èŽ·å–ä¼˜æƒ åˆ¸ç»Ÿè®¡å¤±è´¥:",t)}},M=()=>{z.value=!0,I(!0),L()},Y=()=>{F.value&&!T.value&&I()},B=e=>({unused:"æœªä½¿ç”¨",used:"å·²ä½¿ç”¨",expired:"å·²è¿‡æœŸ"}[e]||""),H=e=>{const a=new Date(e);return`${a.getFullYear()}.${String(a.getMonth()+1).padStart(2,"0")}.${String(a.getDate()).padStart(2,"0")}`},K=()=>{l()};return(e,a)=>{const s=t,l=u,o=n;return _(),v(s,{class:"coupon-list-page",style:f({paddingTop:w.value+"px"})},{default:p((()=>[g(s,{class:"status-bar",style:f({height:w.value+"px"})},null,8,["style"]),g(s,{class:"nav-bar",style:f({marginTop:w.value+"px"})},{default:p((()=>[g(s,{class:"nav-left",onClick:K},{default:p((()=>[g(s,{class:"back-arrow"})])),_:1}),g(s,{class:"nav-center"},{default:p((()=>[g(l,{class:"nav-title"},{default:p((()=>[m("æˆ‘çš„ä¼˜æƒ åˆ¸")])),_:1})])),_:1}),g(s,{class:"nav-right"})])),_:1},8,["style"]),g(s,{class:"filter-tabs"},{default:p((()=>[(_(!0),y(h,null,k(D.value,(e=>(_(),v(s,{key:e.value,class:x(["filter-tab",{active:j.value===e.value}]),onClick:a=>{return s=e.value,void(j.value!==s&&(j.value=s,R.value=1,F.value=!0,C.value=[],I(!0)));var s}},{default:p((()=>[g(l,null,{default:p((()=>[m(S(e.label),1)])),_:2},1024),e.count>0?(_(),v(s,{key:0,class:"tab-badge"},{default:p((()=>[m(S(e.count),1)])),_:2},1024)):b("",!0)])),_:2},1032,["class","onClick"])))),128))])),_:1}),g(o,{class:"coupon-scroll","scroll-y":"true",onScrolltolower:Y,"lower-threshold":"100","refresher-enabled":"true",onRefresherrefresh:M,"refresher-triggered":z.value},{default:p((()=>[g(s,{class:"coupon-list"},{default:p((()=>[(_(!0),y(h,null,k(C.value,(e=>(_(),v(s,{key:e._id,class:x(["coupon-card",{expired:"expired"===e.status,used:"used"===e.status}])},{default:p((()=>[g(s,{class:"coupon-left"},{default:p((()=>[g(s,{class:"coupon-amount"},{default:p((()=>[g(l,{class:"amount-symbol"},{default:p((()=>[m("Â¥")])),_:1}),g(l,{class:"amount-number"},{default:p((()=>[m(S(e.amount),1)])),_:2},1024)])),_:2},1024),g(l,{class:"coupon-type"},{default:p((()=>{return[m(S((a=e.type,{no_threshold:"æ— é—¨æ§›åˆ¸",threshold:"æ»¡å‡åˆ¸"}[a]||"ä¼˜æƒ åˆ¸")),1)];var a})),_:2},1024)])),_:2},1024),g(s,{class:"coupon-right"},{default:p((()=>[g(s,{class:"coupon-info"},{default:p((()=>[g(l,{class:"coupon-title"},{default:p((()=>[m(S(e.title),1)])),_:2},1024),g(l,{class:"coupon-desc"},{default:p((()=>[m(S(e.description),1)])),_:2},1024),g(l,{class:"coupon-validity"},{default:p((()=>[m(" æœ‰æ•ˆæœŸè‡³ï¼š"+S(H(e.endTime)),1)])),_:2},1024)])),_:2},1024),g(s,{class:"coupon-status"},{default:p((()=>[g(l,{class:x(["status-text",{"status-unused":"unused"===e.status,"status-used":"used"===e.status,"status-expired":"expired"===e.status}])},{default:p((()=>[m(S(B(e.status)),1)])),_:2},1032,["class"])])),_:2},1024)])),_:2},1024),"unused"!==e.status?(_(),v(s,{key:0,class:"coupon-mask"},{default:p((()=>[g(l,{class:"mask-text"},{default:p((()=>[m(S(B(e.status)),1)])),_:2},1024)])),_:2},1024)):b("",!0)])),_:2},1032,["class"])))),128)),T.value||0!==C.value.length?b("",!0):(_(),v(s,{key:0,class:"empty-state"},{default:p((()=>[g(s,{class:"empty-icon"},{default:p((()=>[m("ðŸŽ«")])),_:1}),g(l,{class:"empty-text"},{default:p((()=>[m("æš‚æ— "+S(B(j.value))+"ä¼˜æƒ åˆ¸",1)])),_:1}),g(l,{class:"empty-hint"},{default:p((()=>[m("å¿«åŽ»èŽ·å–æ›´å¤šä¼˜æƒ åˆ¸å§ï½ž")])),_:1})])),_:1})),T.value?(_(),v(s,{key:1,class:"loading-more"},{default:p((()=>[g(l,null,{default:p((()=>[m("åŠ è½½ä¸­...")])),_:1})])),_:1})):!F.value&&C.value.length>0?(_(),v(s,{key:2,class:"no-more"},{default:p((()=>[g(l,null,{default:p((()=>[m("æ²¡æœ‰æ›´å¤šäº†")])),_:1})])),_:1})):b("",!0)])),_:1})])),_:1},8,["refresher-triggered"])])),_:1},8,["style"])}}}),[["__scopeId","data-v-73d2088b"]]);export{j as default};
