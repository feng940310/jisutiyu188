import{I as a,t as e,k as t,c as s,S as l,K as o,J as n,L as u,E as r,l as c,D as i}from"./uni.CnKTWU0K.js";import{o as d,Z as v}from"./index-C3v_m0JD.js";import{d as p,b as f,R as m,a6 as _,ad as g,a7 as h,M as k,aP as y,aN as b,_ as x,az as w,aW as C,ak as I,aX as S,aY as $,ai as D}from"./vendor.CqD9dFNX.js";import{C as P}from"./CustomTabBar.D3O6WTuX.js";import{_ as j}from"./_plugin-vue_export-helper.BCo6x5W8.js";const F=j(p({__name:"index",setup(p){const j=f(0),F=f(44),R=f(1),B=f(10),J=f(!0),U=f(!1),z=f(""),A=f([]),M=f(""),T=()=>{const a=t("userInfo"),e=(null==a?void 0:a.balance)||0;r({url:`/pages/profile/index?balance=${e}`})},Y=async()=>{if(U.value)try{const{result:a}=await v.callFunction({name:"chatRoom",data:{action:"getUserSubscriptions",data:{page:R.value,pageSize:B.value},token:M.value,userId:z.value}});console.log("获取用户订阅的聊天室列表",a);const e=a.data.list;if(0===a.code&&(null==e?void 0:e.length)>0){const a=await Promise.all(e.map((async a=>{const{result:e}=await v.callFunction({name:"chatRoom",data:{action:"checkUserJoin",data:{roomId:a.room_id,userId:z.value},token:M.value,userId:z.value}});return{...a,isPurchased:e.isJoined}})));1===R.value?A.value=a:A.value=[...A.value,...a],J.value=a.length===B.value}else s({title:a.msg||"获取订阅列表失败",icon:"none"})}catch(a){console.error("获取订阅列表失败:",a),s({title:"获取订阅列表失败",icon:"none"})}},E=()=>{J.value&&U.value&&(R.value++,Y())},H=()=>{i({url:"/pages/index/index"})},K=()=>{(()=>{const a=e();j.value=a.statusBarHeight||0,F.value=44})();(()=>{const a=t("userInfo");return M.value=t("token"),a&&M.value?(U.value=!0,z.value=a.user_id,!0):(U.value=!1,z.value="",!1)})()&&(R.value=1,J.value=!0,A.value=[],Y())};m((()=>{K()})),d((()=>{K()}));const L=(a,e)=>{if(!a)return"未设置";const t=a=>{if(!a)return"";const e=new Date(a);return`${e.getFullYear()}-${String(e.getMonth()+1).padStart(2,"0")}-${String(e.getDate()).padStart(2,"0")}`};return a&&e?`${t(a)} ~ ${t(e)}`:t(a)};return(e,t)=>{const i=a,d=o,v=n,p=u,f=l;return h(),_(i,{class:"page-container"},{default:g((()=>[k(i,{class:"page-background"}),k(f,{"scroll-y":"true",class:"scroll-container",style:y({paddingTop:j.value+F.value+10+"px",paddingBottom:"150rpx"}),onScrolltolower:E},{default:g((()=>[k(i,{class:"content"},{default:g((()=>[k(i,{class:"header"},{default:g((()=>[k(d,{class:"title"},{default:g((()=>[x("我的订阅室")])),_:1})])),_:1}),U.value?(h(),b(w,{key:0},[k(i,{class:"chat-room-list"},{default:g((()=>[(h(!0),b(w,null,I(A.value,((a,e)=>(h(),_(i,{class:"chat-room-item",key:e},{default:g((()=>[k(i,{class:S(["status-stamp",{"status-new":!0}])},{default:g((()=>[x(" 新聊天 ")])),_:1}),k(i,{class:"avatar-container"},{default:g((()=>[k(v,{class:"avatar",src:a.avatar||a.avatarUrl,mode:"aspectFill"},null,8,["src"]),"new"===a.status?(h(),_(i,{key:0,class:"status-badge"},{default:g((()=>[x("新")])),_:1})):C("",!0)])),_:2},1024),k(i,{class:"info-container"},{default:g((()=>[k(i,{class:"top-row"},{default:g((()=>[k(d,{class:"room-name"},{default:g((()=>{return[x($((e=a.title,e?e.length>5?e.substring(0,5)+"...":e:"")),1)];var e})),_:2},1024),k(i,{class:"time-container"},{default:g((()=>[k(i,{class:"room-status"},{default:g((()=>[k(d,{class:"room-id"},{default:g((()=>[x($(L(a.startDate,a.endDate)),1)])),_:2},1024)])),_:2},1024)])),_:2},1024)])),_:2},1024),k(i,{class:"bottom-row"},{default:g((()=>[k(d,{class:"sub-title two-line-ellipsis"},{default:g((()=>[x($(a.subtitle),1)])),_:2},1024),k(i,{class:"action-area"},{default:g((()=>[a.isPurchased?(h(),_(p,{key:0,class:"view-records-btn",onClick:D((e=>(a=>{U.value?"active"===a.type?r({url:`/packageA/pages/chat/index?id=${a.room_id}`}):s({title:"等待团购中...",icon:"none"}):s({title:"请先登录",icon:"none"})})(a)),["stop"])},{default:g((()=>[x("查看记录")])),_:2},1032,["onClick"])):(h(),_(p,{key:1,class:"cancel-btn",onClick:D((e=>(a=>{U.value?(c("sourcePageForChatRoom","group"),r({url:`/packageA/pages/chat/ChatRoomDetailsPage?id=${a.room_id}`})):s({title:"请先登录",icon:"none"})})(a)),["stop"])},{default:g((()=>[x("选择团购")])),_:2},1032,["onClick"]))])),_:2},1024)])),_:2},1024)])),_:2},1024)])),_:2},1024)))),128))])),_:1}),0===A.value.length?(h(),_(i,{key:0,class:"empty-state"},{default:g((()=>[k(d,{class:"empty-text"},{default:g((()=>[x("暂无订阅的聊天室")])),_:1}),k(p,{class:"explore-btn",onClick:H},{default:g((()=>[x("发现聊天室")])),_:1})])),_:1})):C("",!0)],64)):(h(),_(i,{key:1,class:"login-prompt"},{default:g((()=>[k(d,{class:"login-text"},{default:g((()=>[x("请先登录后查看订阅的聊天室")])),_:1}),k(p,{class:"login-btn",onClick:T},{default:g((()=>[x("去登录")])),_:1})])),_:1})),k(i,{style:{height:"120rpx"}})])),_:1})])),_:1},8,["style"]),k(P)])),_:1})}}}),[["__scopeId","data-v-7d2a3472"]]);export{F as default};
