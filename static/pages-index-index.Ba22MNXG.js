import{t as e,k as t,c as o,I as a,S as s,J as l,K as n,L as r,d as c,E as i,b as u,h as d,l as g}from"./uni.CnKTWU0K.js";import{d as m,b as f,c as p,R as v,a6 as _,ad as D,a7 as b,M as y,aP as h,aW as k,aN as S,az as x,ak as I,aX as w,_ as T,aY as R,ai as C}from"./vendor.CqD9dFNX.js";import{o as $,a as F}from"./index-C3v_m0JD.js";import{C as E}from"./CustomTabBar.D3O6WTuX.js";import{_ as J}from"./_plugin-vue_export-helper.BCo6x5W8.js";const M=J(m({__name:"index",setup(m){const J=f(20);f(0),f(0),f(0);const M=f(0),N=f(1),j=f(10),O=f(0),P=p((()=>Y.value.length>=O.value)),B=f(!1),z=f(!1),H=f(!1),Y=f([]);v((()=>{const t=e();J.value=t.statusBarHeight||0,K()})),$((()=>{console.log("页面显示，重新检查登录状态"),Z(),console.log("强制刷新数据"),W()}));const Z=()=>{try{const e=t("userInfo"),o=t("token"),a=t("tokenExpire");if(console.log("检查登录状态:",{userInfo:e,token:o,tokenExpire:a}),e&&o&&a){const t=JSON.parse(e);console.log("解析后的用户数据:",t),console.log("token过期时间:",a),a&&a>Date.now()?(console.log("用户已登录，token有效"),H.value=!0):(console.log("token已过期"),H.value=!1)}else console.log("未找到用户信息或token"),H.value=!1}catch(e){console.error("检查登录状态失败",e),H.value=!1}console.log("最终登录状态:",H.value)},A=()=>{try{const e=t("userId");if(e)return console.log("直接获取到的用户ID:",e),e;const o=t("userInfo");if(o){const e=JSON.parse(o);return console.log("从userInfo获取到的用户ID:",e.user_id),e.user_id}return null}catch(e){return console.error("获取用户ID失败",e),null}},K=async()=>{try{Z(),N.value=1,await L()}catch(e){console.error("初始化数据失败",e),o({title:"获取数据失败",icon:"none"})}},L=async(e=!0)=>{var t;try{B.value=!0,console.log("正在获取聊天室列表");const s=await F.callFunction("chatRoom",{action:"list",data:{page:N.value,pageSize:j.value,filterExpired:!0}});if(console.log("获取聊天室列表结果:",s),s&&0===s.code){const{list:o,total:l}=s.data;o&&o.length>0&&console.log("原始数据中的第一条记录:",{room_id:o[0].room_id,title:o[0].title,type:o[0].type,startDate:o[0].startDate,endDate:o[0].endDate,start_time:o[0].start_time,end_time:o[0].end_time});const n=o.map((e=>{const t=new Date;if("active"===e.type){if(e.start_time?e.startDate=new Date(e.start_time):(console.warn("进行中的聊天室没有开始时间:",e.room_id),e.startDate=t),e.end_time)e.endDate=new Date(e.end_time);else{console.warn("进行中的聊天室没有结束时间:",e.room_id);const t=new Date(e.startDate);t.setDate(t.getDate()+7),e.endDate=t}const o=e.endDate.getTime()-t.getTime(),a=Math.ceil(o/864e5);e.remainingDays=Math.max(0,a)}else{e.startDate=t;const o=new Date(t);o.setDate(o.getDate()+7),e.endDate=o,e.remainingDays=7}return e})),r=new Date,c=n.filter((e=>{if(!e.endDate)return!0;try{let t;if(e.endDate instanceof Date)t=e.endDate;else{if("string"!=typeof e.endDate)return!0;if(e.endDate.includes("ZT")){const o=e.endDate.split("T")[0]+"T"+e.endTime+":00.000Z";t=new Date(o)}else t=new Date(e.endDate)}return t.getTime()>r.getTime()}catch(t){return console.error("处理日期时出错:",t,e),!0}}));if(console.log("处理后的聊天室列表数据样例:",c.length>0?c[0]:"没有数据"),console.log(`过滤前 ${n.length} 个聊天室，过滤后 ${c.length} 个聊天室`),H.value){const e=A();if(e)try{console.log("准备获取用户订阅状态，用户ID:",e);const o=await F.callFunction("chatRoom",{action:"getUserSubscriptions",data:{userId:e}});if(console.log("获取用户订阅状态结果:",o),o&&0===o.code){const e=((null==(t=o.data)?void 0:t.list)||[]).map((e=>e.room_id));console.log("用户已订阅的房间IDs:",e),c.forEach((t=>{t.isSubscribed=e.includes(t.room_id)}))}else o&&401===o.code&&console.log("获取订阅状态返回未登录状态，可能是token已过期")}catch(a){console.error("获取用户订阅状态失败",a)}else console.log("未获取到用户ID，无法获取订阅状态")}else console.log("用户未登录，所有聊天室设为未订阅状态"),c.forEach((e=>{e.isSubscribed=!1}));Y.value=e?c:[...Y.value,...c],O.value=l}else console.error("获取聊天室列表失败:",s),o({title:(null==s?void 0:s.msg)||"获取数据失败",icon:"none"})}catch(a){console.error("获取聊天室列表失败",a),o({title:"获取数据失败",icon:"none"})}finally{B.value=!1,z.value=!1}},U=async()=>{B.value||P.value||(N.value++,await L(!1))},W=async()=>{z.value=!0,N.value=1,await L()},X=(e,t)=>{if(!e)return"未设置";const o=e=>{if(!e)return"";const t=new Date(e);return`${t.getFullYear()}-${String(t.getMonth()+1).padStart(2,"0")}-${String(t.getDate()).padStart(2,"0")}`};return e&&t?`${o(e)} ~ ${o(t)}`:o(e)},q=e=>{if(Z(),!H.value)return void c({title:"提示",content:"请先登录后再查看聊天室详情",confirmText:"去登录",success:e=>{e.confirm&&i({url:"/pages/profile/index"})}});const t=Y.value.find((t=>t.room_id===e));if(t){const e=(e=>{if("upcoming"===e.type)return e.price;const t=e.price,o=e.remainingDays||0;return Math.ceil(o/7*t)})(t);g("chatRoomPrice",e),g("chatRoomFullPrice",t.price),g("chatRoomRemainingDays",t.remainingDays||7)}g("sourcePageForChatRoom","index"),i({url:`/packageA/pages/chat/ChatRoomDetailsPage?id=${e}`})};return(e,t)=>{const g=a,m=l,f=n,p=r,v=s;return b(),_(g,{class:"page-container"},{default:D((()=>[y(g,{class:"page-background"}),y(v,{"scroll-y":"true",class:"scroll-container",style:h({paddingTop:M.value+10+"px",paddingBottom:"0rpx"}),onScrolltolower:U,"refresher-enabled":"","refresher-triggered":z.value,onRefresherrefresh:W},{default:D((()=>[y(g,{class:"content"},{default:D((()=>[y(g,{class:"card-grid"},{default:D((()=>[(b(!0),S(x,null,I(Y.value,(e=>(b(),_(g,{key:e._id,class:w(["room-card",{"active-room":"active"===e.type,"upcoming-room":"upcoming"===e.type}]),onClick:t=>q(e.room_id)},{default:D((()=>[y(g,{class:w(["status-stamp",{"status-upcoming":"upcoming"===e.type,"status-active":"active"===e.type}])},{default:D((()=>[T(R("upcoming"===e.type?"未开始":"进行中"),1)])),_:2},1032,["class"]),y(g,{class:"room-header"},{default:D((()=>[y(g,{class:"avatar-container"},{default:D((()=>[y(m,{class:"avatar",src:e.avatar,mode:"aspectFill"},null,8,["src"]),e.isHot?(b(),_(g,{key:0,class:"hot-tag"},{default:D((()=>[T("热门")])),_:1})):k("",!0)])),_:2},1024),y(g,{class:"title-container"},{default:D((()=>[y(g,{class:"room-title"},{default:D((()=>[T(R(e.title),1)])),_:2},1024),y(g,{class:"room-subtitle"},{default:D((()=>[T(R(e.subtitle),1)])),_:2},1024)])),_:2},1024)])),_:2},1024),y(g,{class:"room-time-info"},{default:D((()=>[y(g,{class:"time-row"},{default:D((()=>[y(f,{class:"time-label"},{default:D((()=>[T("时间：")])),_:1}),y(f,{class:"time-value"},{default:D((()=>[T(R(X(e.startDate,e.endDate)),1)])),_:2},1024)])),_:2},1024)])),_:2},1024),y(g,{class:"room-stats"},{default:D((()=>[y(g,{class:"stat-item"},{default:D((()=>[y(f,{class:"stat-text"},{default:D((()=>[T("剩余")])),_:1}),y(f,{class:"stat-value"},{default:D((()=>[T(R("upcoming"===e.type?"7":e.remainingDays),1)])),_:2},1024),y(f,{class:"stat-text"},{default:D((()=>[T("天")])),_:1})])),_:2},1024),y(g,{class:"stat-item"},{default:D((()=>[y(p,{class:w(["neon-btn",{"subscribed-btn":e.isSubscribed}]),onClick:C((t=>(async e=>{if(console.log("点击订阅按钮, 当前登录状态:",H.value),console.log("聊天室信息:",JSON.stringify(e)),Z(),!H.value)return console.log("用户未登录，显示登录提示"),void c({title:"提示",content:"请先登录后再进行订阅操作",confirmText:"去登录",success:e=>{e.confirm&&i({url:"/pages/profile/index"})}});if(!e||!e.room_id)return console.error("聊天室ID不存在",e),void o({title:"聊天室信息不完整",icon:"none"});const t=e.room_id.toString().trim();if(console.log("处理后的房间ID:",t),!t)return console.error("房间ID为空"),void o({title:"聊天室ID无效",icon:"none"});try{const a=e.isSubscribed?"unsubscribe":"subscribe";console.log("准备执行操作:",a,"房间ID:",t),u({title:e.isSubscribed?"取消订阅中...":"订阅中..."});const s=A();if(console.log("获取到的用户ID:",s),!s)return d(),console.log("未获取到用户ID，提示重新登录"),void c({title:"提示",content:"登录状态已失效，请重新登录",confirmText:"去登录",success:e=>{e.confirm&&i({url:"/pages/profile/index"})}});const l={roomId:t,userId:s};console.log("调用云函数前参数:",JSON.stringify(l));const n=await F.callFunction("chatRoom",{action:a,data:l});d(),console.log("订阅返回结果:",JSON.stringify(n)),n&&0===n.code?(e.isSubscribed=!e.isSubscribed,e.isSubscribed?e.subscribers=(e.subscribers||0)+1:e.subscribers=Math.max(0,(e.subscribers||0)-1),o({title:n.msg||(e.isSubscribed?"订阅成功":"已取消订阅"),icon:"success"})):401===(null==n?void 0:n.code)||-1===(null==n?void 0:n.code)&&"用户未登录"===(null==n?void 0:n.msg)?(console.log("云函数返回未登录错误"),c({title:"提示",content:"登录状态已失效，请重新登录",confirmText:"去登录",success:e=>{e.confirm&&i({url:"/pages/profile/index"})}})):o({title:(null==n?void 0:n.msg)||"操作失败",icon:"none"})}catch(a){d(),console.error("订阅操作失败",a),o({title:"操作失败，请稍后再试",icon:"none"})}})(e)),["stop"])},{default:D((()=>[T(R(e.isSubscribed?"取消订阅":"订阅"),1)])),_:2},1032,["class","onClick"])])),_:2},1024)])),_:2},1024)])),_:2},1032,["class","onClick"])))),128))])),_:1}),B.value?(b(),_(g,{key:0,class:"loading"},{default:D((()=>[T("加载中...")])),_:1})):k("",!0),y(g,{style:{height:"120rpx"}})])),_:1})])),_:1},8,["style","refresher-triggered"]),y(g,{class:"load-more-btn-container"},{default:D((()=>[y(p,{class:"load-more-btn",onClick:U,disabled:B.value},{default:D((()=>[B.value||P.value?k("",!0):(b(),_(f,{key:0},{default:D((()=>[T("更多")])),_:1})),!B.value&&P.value?(b(),_(f,{key:1},{default:D((()=>[T("无更多")])),_:1})):k("",!0),B.value?(b(),_(f,{key:2},{default:D((()=>[T("加载中")])),_:1})):k("",!0)])),_:1},8,["disabled"])])),_:1}),y(E)])),_:1})}}}),[["__scopeId","data-v-489bfe79"]]);export{M as default};
