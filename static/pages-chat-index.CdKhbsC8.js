import{$ as e,N as t,O as a,t as n,d as o,E as l,c as s,k as c,I as u,K as r,L as i,S as d,J as g,b as v,l as m,h as f}from"./uni.CnKTWU0K.js";import{d as p,b as h,R as _,Y as y,a6 as C,ad as k,a7 as b,M as w,aW as S,aP as L,_ as $,aY as D,aN as T,az as I,ak as x}from"./vendor.CqD9dFNX.js";import{o as E,c as M,a as F}from"./index-C3v_m0JD.js";import{C as A}from"./CustomTabBar.D3O6WTuX.js";import{g as j}from"./loginHelper.B8-BL7my.js";import{c as O,m as U}from"./messagePoller.DPVrTeWT.js";import{_ as N}from"./_plugin-vue_export-helper.BCo6x5W8.js";const P=N(p({__name:"index",setup(p){const N=h(!0),P=h(!1),Y=h([]),R=h(!1),z=h(0),B=h(!0);h(0);const H=h(20),J=h(44),W=h(!1),K=h(null),q=h([]),G=h(0),Q=h(0),V=h(!1);_((async()=>{await O.initialize(),X(),await le(),U.switchToChatListMode(),pe(),console.log("[ChatList] 页面初始化完成")})),E((()=>{console.log("[ChatList] 页面显示"),B.value=!0,q.value=[],G.value=0,V.value=!0,U.switchToChatListMode(),de(),pe(),oe()})),M((()=>{console.log("[ChatList] 页面隐藏"),B.value=!1,U.pausePolling("用户离开聊天列表")})),y((()=>{console.log("[ChatList] 页面卸载"),U.stop(),Z(),e("chatRoomClosed",re),e("clearChatListCache",ie)}));const X=()=>{console.log("[ChatList] 设置事件监听器"),O.on("new-message-received",ee),O.on("conversation-updated",te),O.on("unread-count-changed",ae),O.on("conversation-read",ne),t("clearChatListCache",ie)},Z=()=>{console.log("[ChatList] 清理事件监听器"),O.off("new-message-received",ee),O.off("conversation-updated",te),O.off("unread-count-changed",ae),O.off("conversation-read",ne)},ee=e=>{console.log("[ChatList] 收到新消息事件:",e);const{conversationId:t,message:a,unreadCount:n}=e,o=Y.value.findIndex((e=>e.id===t));if(-1===o)return console.log("[ChatList] 检测到新会话，重新加载列表"),void ce();{const e=Y.value[o];e.lastMessage=a,e.unreadCount=n,e.updateTime=a.send_time||(new Date).toISOString(),Y.value.sort(((e,t)=>{const a="group"===e.type,n="group"===t.type,o=a&&(e.syncEnabled||!1),l=n&&(t.syncEnabled||!1);if(o!==l)return l?1:-1;if(a!==n)return n?1:-1;const s=new Date(e.updateTime||0).getTime();return new Date(t.updateTime||0).getTime()-s}))}z.value++,oe(),console.log("[ChatList] 新消息处理完成")},te=e=>{console.log("[ChatList] 会话更新事件:",e);const{conversationId:t,data:a}=e,n=Y.value.findIndex((e=>e.id===t));-1!==n&&(Object.assign(Y.value[n],a),z.value++)},ae=e=>{console.log("[ChatList] 未读数变化事件:",e);const{conversationId:t,newCount:n,totalUnreadCount:o}=e,l=Y.value.findIndex((e=>e.id===t));-1!==l&&(Y.value[l].unreadCount=n,z.value++),a("updateUnreadCount",{count:o})},ne=e=>{console.log("[ChatList] 会话已读事件:",e);const{conversationId:t}=e,a=Y.value.findIndex((e=>e.id===t));-1!==a&&(Y.value[a].unreadCount=0,z.value++),oe()},oe=()=>{const e=O.getTotalUnreadCount();a("updateUnreadCount",{count:e})},le=async()=>{try{const e=n();H.value=e.statusBarHeight||20,await se(),Date.now()-G.value<=3e4&&q.value.length>0?(Y.value=[...q.value],N.value=!1,console.log("使用缓存的聊天列表数据")):await ce()}catch(e){console.error("初始化页面失败:",e),N.value=!1}},se=async()=>{try{const e=j();if(!e)return void o({title:"提示",content:"请先登录",confirmText:"去登录",success:e=>{e.confirm&&l({url:"/pages/profile/index"})}});const t=await F.callFunction("user",{action:"checkAdminStatus",token:e});R.value=t&&0===t.code&&t.is_admin,console.log("用户权限检查完成:",{isAdmin:R.value})}catch(e){console.error("检查用户状态失败:",e)}},ce=async()=>{try{N.value=!0;const e=j();if(!e)return N.value=!1,void console.log("未找到有效token");console.log("开始加载聊天列表，token前缀:",e.substring(0,10)+"...");const t=await F.callFunction("chat",{action:"getChatList",token:e});if(console.log("聊天列表加载结果:",t),t&&0===t.code){Y.value=t.data||[],console.log("开始排序聊天列表，排序前顺序:"),Y.value.forEach(((e,t)=>{console.log(`${t+1}. ${e.title} - 置顶:${e.isSticky} 同步:${e.syncEnabled} 未读:${e.unreadCount}`)})),Y.value.sort(((e,t)=>{const a="group"===e.type,n="group"===t.type,o=a&&(e.syncEnabled||!1),l=n&&(t.syncEnabled||!1);if(o!==l)return console.log(`同步群聊排序: ${e.title}(${o}) vs ${t.title}(${l})`),l?1:-1;if(a!==n)return console.log(`群聊排序: ${e.title}(群聊:${a}) vs ${t.title}(群聊:${n})`),n?1:-1;const s=new Date(e.updateTime||0).getTime();return new Date(t.updateTime||0).getTime()-s})),console.log("排序完成，排序后顺序:"),Y.value.forEach(((e,t)=>{console.log(`${t+1}. ${e.title} - 置顶:${e.isSticky} 同步:${e.syncEnabled} 未读:${e.unreadCount}`)})),q.value=[...Y.value],G.value=Date.now(),z.value++,console.log("聊天列表加载成功，数量:",Y.value.length,"强制更新key:",z.value);const e=Y.value.reduce(((e,t)=>e+(t.unreadCount||0)),0);a("updateUnreadCount",{count:e}),console.log("通知TabBar更新未读消息数:",e),Y.value.forEach(((e,t)=>{console.log(`聊天项 ${t+1}:`,{id:e.id,title:e.title,type:e.type,memberCount:e.memberCount,lastMessage:e.lastMessage,unreadCount:e.unreadCount,updateTime:e.updateTime,isSticky:e.isSticky,syncEnabled:e.syncEnabled})}))}else console.error("加载聊天列表失败:",null==t?void 0:t.msg),s({title:(null==t?void 0:t.msg)||"加载失败",icon:"none"})}catch(e){console.error("加载聊天列表异常:",e),s({title:"网络异常",icon:"none"})}finally{N.value=!1,P.value=!1}},ue=async()=>{P.value=!0,q.value=[],G.value=0,V.value=!0,await ce()},re=e=>{console.log("收到聊天室关闭事件:",e),console.log("聊天室已关闭，清除缓存并刷新列表"),q.value=[],G.value=0,setTimeout((()=>{ce()}),500)},ie=()=>{console.log("[ChatList] 收到清除缓存事件"),q.value=[],G.value=0,V.value=!0,ce()},de=()=>{const e=Date.now();if(e-Q.value<2e3)return void console.log("刷新间隔太短，跳过刷新");0===Y.value.length||V.value||e-G.value>3e4?(console.log("执行智能刷新"),Q.value=e,V.value=!1,ce()):console.log("无需刷新，使用现有数据")},ge=async e=>{try{const t=j();if(!t)return void console.log("[ChatList] 无token，跳过后台标记已读");console.log("[ChatList] 后台标记已读:",e);const a=await F.callFunction("chat",{action:"markAsRead",data:{conversationId:e},token:t});a&&0===a.code?console.log("[ChatList] 后台标记已读成功"):console.warn("[ChatList] 后台标记已读失败:",null==a?void 0:a.msg)}catch(t){console.error("[ChatList] 后台标记已读异常:",t)}},ve=()=>{l({url:"/pages/admin/group-management"})},me=e=>{if(!e)return"暂无消息";if("image"===e.message_type)return"[图片]";if("file"===e.message_type)return"[文件]";if("system"===e.message_type)return"[系统消息]";const t=e.content||"暂无消息";return t.startsWith('【来自聊天室"'),t},fe=e=>{if(!e)return"";const t=new Date(e),a=new Date,n=a.getTime()-t.getTime();if(n<6e4)return"刚刚";if(n<36e5)return Math.floor(n/6e4)+"分钟前";if(t.toDateString()===a.toDateString())return t.toLocaleTimeString("zh-CN",{hour:"2-digit",minute:"2-digit"});const o=new Date(a);return o.setDate(a.getDate()-1),t.toDateString()===o.toDateString()?"昨天 "+t.toLocaleTimeString("zh-CN",{hour:"2-digit",minute:"2-digit"}):t.getFullYear()===a.getFullYear()?t.getMonth()+1+"/"+t.getDate():t.getFullYear()+"/"+(t.getMonth()+1)+"/"+t.getDate()},pe=async()=>{try{console.log("开始加载公告数据...");try{const e=await F.callFunction("announcement",{action:"getCurrentAnnouncement"});if(console.log("API公告结果:",e),e&&0===e.code&&e.data&&e.data.is_active)return K.value=e.data,void console.log("成功加载API公告:",K.value)}catch(e){console.log("API调用失败，尝试本地存储:",e),e.message&&(e.message.includes("404")||e.message.includes("Not Found"))&&console.log("announcement云函数暂未部署，使用本地存储");const a=c("local_announcements");if(a)try{const e=JSON.parse(a);if(e.current&&e.current.is_active)return K.value=e.current,void console.log("从本地存储加载公告:",K.value)}catch(t){console.error("解析本地公告数据失败:",t)}}const a={_id:"test_fallback",content:'欢迎使用极速体育小程序！\n\n📢 管理员提示：announcement云函数暂未部署，当前显示为本地测试公告。\n\n如需发布真实公告，请：\n1. 进入"管理员面板" → "公告管理"\n2. 创建新公告（会保存到本地存储）\n3. 部署announcement云函数以支持多端同步',is_active:!0,create_time:(new Date).toISOString(),update_time:(new Date).toISOString()};K.value=a,console.log("使用默认测试公告（含管理员提示）:",K.value)}catch(a){console.error("加载公告失败:",a),K.value={_id:"error_fallback",content:"欢迎使用极速体育小程序！",is_active:!0,create_time:(new Date).toISOString(),update_time:(new Date).toISOString()}}},he=()=>{W.value=!0},_e=()=>{W.value=!1},ye=e=>{if(!e)return"";const t=new Date(e);return`${t.getFullYear()}-${String(t.getMonth()+1).padStart(2,"0")}-${String(t.getDate()).padStart(2,"0")} ${String(t.getHours()).padStart(2,"0")}:${String(t.getMinutes()).padStart(2,"0")}`};return(e,t)=>{const a=u,n=r,o=i,c=g,p=d;return b(),C(a,{class:"chat-page"},{default:k((()=>[w(a,{class:"page-background"}),w(a,{class:"nav-bar",style:L({paddingTop:H.value+"px",height:J.value+"px"})},{default:k((()=>[w(a,{class:"nav-content"},{default:k((()=>[w(n,{class:"nav-title"},{default:k((()=>[$("聊天")])),_:1})])),_:1})])),_:1},8,["style"]),R.value?(b(),C(a,{key:0,class:"floating-manage-btn",onClick:ve},{default:k((()=>[w(n,{class:"manage-icon"},{default:k((()=>[$("⚙️")])),_:1})])),_:1})):S("",!0),w(a,{class:"intro-btn-container"},{default:k((()=>[w(o,{class:"intro-btn",onClick:he},{default:k((()=>[w(n,{class:"intro-icon"},{default:k((()=>[$("📢")])),_:1})])),_:1})])),_:1}),W.value?(b(),C(a,{key:1,class:"announcement-modal",onClick:_e},{default:k((()=>[w(a,{class:"modal-content"},{default:k((()=>[w(a,{class:"modal-header"},{default:k((()=>[w(n,{class:"modal-title"},{default:k((()=>[$("系统公告")])),_:1}),w(a,{class:"close-btn",onClick:_e},{default:k((()=>[$("×")])),_:1})])),_:1}),w(a,{class:"modal-body"},{default:k((()=>[K.value?(b(),C(a,{key:0,class:"announcement-content"},{default:k((()=>[w(n,{class:"announcement-text"},{default:k((()=>[$(D(K.value.content),1)])),_:1}),w(a,{class:"announcement-time"},{default:k((()=>[$(" 发布时间："+D(ye(K.value.create_time)),1)])),_:1})])),_:1})):(b(),C(a,{key:1,class:"no-announcement"},{default:k((()=>[w(n,{class:"no-announcement-text"},{default:k((()=>[$("暂无公告内容")])),_:1})])),_:1}))])),_:1})])),_:1})])),_:1})):S("",!0),w(p,{class:"chat-list-container",style:L({paddingTop:J.value+H.value+"px",paddingBottom:"180rpx"}),"scroll-y":"true","refresher-enabled":"","refresher-triggered":P.value,onRefresherrefresh:ue},{default:k((()=>[N.value?(b(),C(a,{key:0,class:"loading-container"},{default:k((()=>[w(a,{class:"loading-spinner"}),w(n,{class:"loading-text"},{default:k((()=>[$("加载中...")])),_:1})])),_:1})):Y.value.length>0?(b(),C(a,{class:"chat-list",key:z.value},{default:k((()=>[(b(!0),T(I,null,x(Y.value,((e,t)=>(b(),C(a,{key:`${e.id}_${z.value}`,class:"chat-item",onClick:t=>(async e=>{console.log("[ChatList] 进入聊天:",e.title,"未读数:",e.unreadCount),e.unreadCount>0&&(console.log("[ChatList] 立即标记会话已读:",e.id),O.markAsRead(e.id),ge(e.id)),v({title:"进入中..."});try{const t={id:e.id,type:e.type,title:e.title,avatar:e.avatar,targetUserId:e.targetUserId,groupId:"group"===e.type?e.id:null};m("currentChatInfo",t),f();const a=`/pages/chat/room?id=${e.id}&type=${e.type}`;l({url:a})}catch(t){f(),console.error("[ChatList] 进入聊天失败:",t),s({title:"进入失败",icon:"none"})}})(e)},{default:k((()=>[w(a,{class:"avatar-container"},{default:k((()=>[w(a,{class:"avatar-wrapper"},{default:k((()=>[e.avatar?(b(),C(c,{key:1,class:"avatar-image",src:e.avatar,mode:"aspectFill"},null,8,["src"])):(b(),C(a,{key:0,class:"avatar-placeholder"},{default:k((()=>[w(n,{class:"avatar-text"},{default:k((()=>{return[$(D((t=e.title,t?t.charAt(0).toUpperCase():"?")),1)];var t})),_:2},1024)])),_:2},1024))])),_:2},1024),"group"===e.type?(b(),C(a,{key:0,class:"group-badge"},{default:k((()=>[$("群")])),_:1})):S("",!0),e.unreadCount>0?(b(),C(a,{key:1,class:"unread-badge"},{default:k((()=>[w(n,{class:"unread-text"},{default:k((()=>[$(D(e.unreadCount>99?"99+":e.unreadCount),1)])),_:2},1024)])),_:2},1024)):S("",!0)])),_:2},1024),w(a,{class:"chat-info"},{default:k((()=>[w(a,{class:"chat-header"},{default:k((()=>[w(n,{class:"chat-title"},{default:k((()=>[$(D(e.title),1)])),_:2},1024),w(n,{class:"chat-time"},{default:k((()=>[$(D(fe(e.updateTime)),1)])),_:2},1024)])),_:2},1024),w(a,{class:"chat-preview"},{default:k((()=>[w(n,{class:"last-message"},{default:k((()=>[$(D(me(e.lastMessage)),1)])),_:2},1024),"group"===e.type?(b(),C(n,{key:0,class:"member-count"},{default:k((()=>[$("("+D(e.memberCount)+"人)",1)])),_:2},1024)):S("",!0)])),_:2},1024)])),_:2},1024)])),_:2},1032,["onClick"])))),128))])),_:1})):(b(),C(a,{key:2,class:"empty-state"},{default:k((()=>[w(a,{class:"empty-icon"},{default:k((()=>[$("💬")])),_:1}),w(n,{class:"empty-text"},{default:k((()=>[$("暂无聊天记录")])),_:1}),w(n,{class:"empty-hint"},{default:k((()=>[$(D(R.value?"创建群聊开始沟通":"等待管理员邀请加入群聊"),1)])),_:1})])),_:1}))])),_:1},8,["style","refresher-triggered"]),w(a,{class:"tabbar-placeholder"}),w(A)])),_:1})}}}),[["__scopeId","data-v-bb59a4a8"]]);export{P as default};
