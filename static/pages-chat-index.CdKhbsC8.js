import{$ as e,N as t,O as a,t as n,d as o,E as l,c as s,k as c,I as u,K as r,L as i,S as d,J as g,b as v,l as m,h as f}from"./uni.CnKTWU0K.js";import{d as p,b as h,R as _,Y as y,a6 as C,ad as k,a7 as b,M as w,aW as S,aP as L,_ as $,aY as D,aN as T,az as I,ak as x}from"./vendor.CqD9dFNX.js";import{o as E,c as M,a as F}from"./index-C3v_m0JD.js";import{C as A}from"./CustomTabBar.D3O6WTuX.js";import{g as j}from"./loginHelper.B8-BL7my.js";import{c as O,m as U}from"./messagePoller.DPVrTeWT.js";import{_ as N}from"./_plugin-vue_export-helper.BCo6x5W8.js";const P=N(p({__name:"index",setup(p){const N=h(!0),P=h(!1),Y=h([]),R=h(!1),z=h(0),B=h(!0);h(0);const H=h(20),J=h(44),W=h(!1),K=h(null),q=h([]),G=h(0),Q=h(0),V=h(!1);_((async()=>{await O.initialize(),X(),await le(),U.switchToChatListMode(),pe(),console.log("[ChatList] é¡µé¢åˆå§‹åŒ–å®Œæˆ")})),E((()=>{console.log("[ChatList] é¡µé¢æ˜¾ç¤º"),B.value=!0,q.value=[],G.value=0,V.value=!0,U.switchToChatListMode(),de(),pe(),oe()})),M((()=>{console.log("[ChatList] é¡µé¢éšè—"),B.value=!1,U.pausePolling("ç”¨æˆ·ç¦»å¼€èŠå¤©åˆ—è¡¨")})),y((()=>{console.log("[ChatList] é¡µé¢å¸è½½"),U.stop(),Z(),e("chatRoomClosed",re),e("clearChatListCache",ie)}));const X=()=>{console.log("[ChatList] è®¾ç½®äº‹ä»¶ç›‘å¬å™¨"),O.on("new-message-received",ee),O.on("conversation-updated",te),O.on("unread-count-changed",ae),O.on("conversation-read",ne),t("clearChatListCache",ie)},Z=()=>{console.log("[ChatList] æ¸…ç†äº‹ä»¶ç›‘å¬å™¨"),O.off("new-message-received",ee),O.off("conversation-updated",te),O.off("unread-count-changed",ae),O.off("conversation-read",ne)},ee=e=>{console.log("[ChatList] æ”¶åˆ°æ–°æ¶ˆæ¯äº‹ä»¶:",e);const{conversationId:t,message:a,unreadCount:n}=e,o=Y.value.findIndex((e=>e.id===t));if(-1===o)return console.log("[ChatList] æ£€æµ‹åˆ°æ–°ä¼šè¯ï¼Œé‡æ–°åŠ è½½åˆ—è¡¨"),void ce();{const e=Y.value[o];e.lastMessage=a,e.unreadCount=n,e.updateTime=a.send_time||(new Date).toISOString(),Y.value.sort(((e,t)=>{const a="group"===e.type,n="group"===t.type,o=a&&(e.syncEnabled||!1),l=n&&(t.syncEnabled||!1);if(o!==l)return l?1:-1;if(a!==n)return n?1:-1;const s=new Date(e.updateTime||0).getTime();return new Date(t.updateTime||0).getTime()-s}))}z.value++,oe(),console.log("[ChatList] æ–°æ¶ˆæ¯å¤„ç†å®Œæˆ")},te=e=>{console.log("[ChatList] ä¼šè¯æ›´æ–°äº‹ä»¶:",e);const{conversationId:t,data:a}=e,n=Y.value.findIndex((e=>e.id===t));-1!==n&&(Object.assign(Y.value[n],a),z.value++)},ae=e=>{console.log("[ChatList] æœªè¯»æ•°å˜åŒ–äº‹ä»¶:",e);const{conversationId:t,newCount:n,totalUnreadCount:o}=e,l=Y.value.findIndex((e=>e.id===t));-1!==l&&(Y.value[l].unreadCount=n,z.value++),a("updateUnreadCount",{count:o})},ne=e=>{console.log("[ChatList] ä¼šè¯å·²è¯»äº‹ä»¶:",e);const{conversationId:t}=e,a=Y.value.findIndex((e=>e.id===t));-1!==a&&(Y.value[a].unreadCount=0,z.value++),oe()},oe=()=>{const e=O.getTotalUnreadCount();a("updateUnreadCount",{count:e})},le=async()=>{try{const e=n();H.value=e.statusBarHeight||20,await se(),Date.now()-G.value<=3e4&&q.value.length>0?(Y.value=[...q.value],N.value=!1,console.log("ä½¿ç”¨ç¼“å­˜çš„èŠå¤©åˆ—è¡¨æ•°æ®")):await ce()}catch(e){console.error("åˆå§‹åŒ–é¡µé¢å¤±è´¥:",e),N.value=!1}},se=async()=>{try{const e=j();if(!e)return void o({title:"æç¤º",content:"è¯·å…ˆç™»å½•",confirmText:"å»ç™»å½•",success:e=>{e.confirm&&l({url:"/pages/profile/index"})}});const t=await F.callFunction("user",{action:"checkAdminStatus",token:e});R.value=t&&0===t.code&&t.is_admin,console.log("ç”¨æˆ·æƒé™æ£€æŸ¥å®Œæˆ:",{isAdmin:R.value})}catch(e){console.error("æ£€æŸ¥ç”¨æˆ·çŠ¶æ€å¤±è´¥:",e)}},ce=async()=>{try{N.value=!0;const e=j();if(!e)return N.value=!1,void console.log("æœªæ‰¾åˆ°æœ‰æ•ˆtoken");console.log("å¼€å§‹åŠ è½½èŠå¤©åˆ—è¡¨ï¼Œtokenå‰ç¼€:",e.substring(0,10)+"...");const t=await F.callFunction("chat",{action:"getChatList",token:e});if(console.log("èŠå¤©åˆ—è¡¨åŠ è½½ç»“æœ:",t),t&&0===t.code){Y.value=t.data||[],console.log("å¼€å§‹æ’åºèŠå¤©åˆ—è¡¨ï¼Œæ’åºå‰é¡ºåº:"),Y.value.forEach(((e,t)=>{console.log(`${t+1}. ${e.title} - ç½®é¡¶:${e.isSticky} åŒæ­¥:${e.syncEnabled} æœªè¯»:${e.unreadCount}`)})),Y.value.sort(((e,t)=>{const a="group"===e.type,n="group"===t.type,o=a&&(e.syncEnabled||!1),l=n&&(t.syncEnabled||!1);if(o!==l)return console.log(`åŒæ­¥ç¾¤èŠæ’åº: ${e.title}(${o}) vs ${t.title}(${l})`),l?1:-1;if(a!==n)return console.log(`ç¾¤èŠæ’åº: ${e.title}(ç¾¤èŠ:${a}) vs ${t.title}(ç¾¤èŠ:${n})`),n?1:-1;const s=new Date(e.updateTime||0).getTime();return new Date(t.updateTime||0).getTime()-s})),console.log("æ’åºå®Œæˆï¼Œæ’åºåé¡ºåº:"),Y.value.forEach(((e,t)=>{console.log(`${t+1}. ${e.title} - ç½®é¡¶:${e.isSticky} åŒæ­¥:${e.syncEnabled} æœªè¯»:${e.unreadCount}`)})),q.value=[...Y.value],G.value=Date.now(),z.value++,console.log("èŠå¤©åˆ—è¡¨åŠ è½½æˆåŠŸï¼Œæ•°é‡:",Y.value.length,"å¼ºåˆ¶æ›´æ–°key:",z.value);const e=Y.value.reduce(((e,t)=>e+(t.unreadCount||0)),0);a("updateUnreadCount",{count:e}),console.log("é€šçŸ¥TabBaræ›´æ–°æœªè¯»æ¶ˆæ¯æ•°:",e),Y.value.forEach(((e,t)=>{console.log(`èŠå¤©é¡¹ ${t+1}:`,{id:e.id,title:e.title,type:e.type,memberCount:e.memberCount,lastMessage:e.lastMessage,unreadCount:e.unreadCount,updateTime:e.updateTime,isSticky:e.isSticky,syncEnabled:e.syncEnabled})}))}else console.error("åŠ è½½èŠå¤©åˆ—è¡¨å¤±è´¥:",null==t?void 0:t.msg),s({title:(null==t?void 0:t.msg)||"åŠ è½½å¤±è´¥",icon:"none"})}catch(e){console.error("åŠ è½½èŠå¤©åˆ—è¡¨å¼‚å¸¸:",e),s({title:"ç½‘ç»œå¼‚å¸¸",icon:"none"})}finally{N.value=!1,P.value=!1}},ue=async()=>{P.value=!0,q.value=[],G.value=0,V.value=!0,await ce()},re=e=>{console.log("æ”¶åˆ°èŠå¤©å®¤å…³é—­äº‹ä»¶:",e),console.log("èŠå¤©å®¤å·²å…³é—­ï¼Œæ¸…é™¤ç¼“å­˜å¹¶åˆ·æ–°åˆ—è¡¨"),q.value=[],G.value=0,setTimeout((()=>{ce()}),500)},ie=()=>{console.log("[ChatList] æ”¶åˆ°æ¸…é™¤ç¼“å­˜äº‹ä»¶"),q.value=[],G.value=0,V.value=!0,ce()},de=()=>{const e=Date.now();if(e-Q.value<2e3)return void console.log("åˆ·æ–°é—´éš”å¤ªçŸ­ï¼Œè·³è¿‡åˆ·æ–°");0===Y.value.length||V.value||e-G.value>3e4?(console.log("æ‰§è¡Œæ™ºèƒ½åˆ·æ–°"),Q.value=e,V.value=!1,ce()):console.log("æ— éœ€åˆ·æ–°ï¼Œä½¿ç”¨ç°æœ‰æ•°æ®")},ge=async e=>{try{const t=j();if(!t)return void console.log("[ChatList] æ— tokenï¼Œè·³è¿‡åå°æ ‡è®°å·²è¯»");console.log("[ChatList] åå°æ ‡è®°å·²è¯»:",e);const a=await F.callFunction("chat",{action:"markAsRead",data:{conversationId:e},token:t});a&&0===a.code?console.log("[ChatList] åå°æ ‡è®°å·²è¯»æˆåŠŸ"):console.warn("[ChatList] åå°æ ‡è®°å·²è¯»å¤±è´¥:",null==a?void 0:a.msg)}catch(t){console.error("[ChatList] åå°æ ‡è®°å·²è¯»å¼‚å¸¸:",t)}},ve=()=>{l({url:"/pages/admin/group-management"})},me=e=>{if(!e)return"æš‚æ— æ¶ˆæ¯";if("image"===e.message_type)return"[å›¾ç‰‡]";if("file"===e.message_type)return"[æ–‡ä»¶]";if("system"===e.message_type)return"[ç³»ç»Ÿæ¶ˆæ¯]";const t=e.content||"æš‚æ— æ¶ˆæ¯";return t.startsWith('ã€æ¥è‡ªèŠå¤©å®¤"'),t},fe=e=>{if(!e)return"";const t=new Date(e),a=new Date,n=a.getTime()-t.getTime();if(n<6e4)return"åˆšåˆš";if(n<36e5)return Math.floor(n/6e4)+"åˆ†é’Ÿå‰";if(t.toDateString()===a.toDateString())return t.toLocaleTimeString("zh-CN",{hour:"2-digit",minute:"2-digit"});const o=new Date(a);return o.setDate(a.getDate()-1),t.toDateString()===o.toDateString()?"æ˜¨å¤© "+t.toLocaleTimeString("zh-CN",{hour:"2-digit",minute:"2-digit"}):t.getFullYear()===a.getFullYear()?t.getMonth()+1+"/"+t.getDate():t.getFullYear()+"/"+(t.getMonth()+1)+"/"+t.getDate()},pe=async()=>{try{console.log("å¼€å§‹åŠ è½½å…¬å‘Šæ•°æ®...");try{const e=await F.callFunction("announcement",{action:"getCurrentAnnouncement"});if(console.log("APIå…¬å‘Šç»“æœ:",e),e&&0===e.code&&e.data&&e.data.is_active)return K.value=e.data,void console.log("æˆåŠŸåŠ è½½APIå…¬å‘Š:",K.value)}catch(e){console.log("APIè°ƒç”¨å¤±è´¥ï¼Œå°è¯•æœ¬åœ°å­˜å‚¨:",e),e.message&&(e.message.includes("404")||e.message.includes("Not Found"))&&console.log("announcementäº‘å‡½æ•°æš‚æœªéƒ¨ç½²ï¼Œä½¿ç”¨æœ¬åœ°å­˜å‚¨");const a=c("local_announcements");if(a)try{const e=JSON.parse(a);if(e.current&&e.current.is_active)return K.value=e.current,void console.log("ä»æœ¬åœ°å­˜å‚¨åŠ è½½å…¬å‘Š:",K.value)}catch(t){console.error("è§£ææœ¬åœ°å…¬å‘Šæ•°æ®å¤±è´¥:",t)}}const a={_id:"test_fallback",content:'æ¬¢è¿ä½¿ç”¨æé€Ÿä½“è‚²å°ç¨‹åºï¼\n\nğŸ“¢ ç®¡ç†å‘˜æç¤ºï¼šannouncementäº‘å‡½æ•°æš‚æœªéƒ¨ç½²ï¼Œå½“å‰æ˜¾ç¤ºä¸ºæœ¬åœ°æµ‹è¯•å…¬å‘Šã€‚\n\nå¦‚éœ€å‘å¸ƒçœŸå®å…¬å‘Šï¼Œè¯·ï¼š\n1. è¿›å…¥"ç®¡ç†å‘˜é¢æ¿" â†’ "å…¬å‘Šç®¡ç†"\n2. åˆ›å»ºæ–°å…¬å‘Šï¼ˆä¼šä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨ï¼‰\n3. éƒ¨ç½²announcementäº‘å‡½æ•°ä»¥æ”¯æŒå¤šç«¯åŒæ­¥',is_active:!0,create_time:(new Date).toISOString(),update_time:(new Date).toISOString()};K.value=a,console.log("ä½¿ç”¨é»˜è®¤æµ‹è¯•å…¬å‘Šï¼ˆå«ç®¡ç†å‘˜æç¤ºï¼‰:",K.value)}catch(a){console.error("åŠ è½½å…¬å‘Šå¤±è´¥:",a),K.value={_id:"error_fallback",content:"æ¬¢è¿ä½¿ç”¨æé€Ÿä½“è‚²å°ç¨‹åºï¼",is_active:!0,create_time:(new Date).toISOString(),update_time:(new Date).toISOString()}}},he=()=>{W.value=!0},_e=()=>{W.value=!1},ye=e=>{if(!e)return"";const t=new Date(e);return`${t.getFullYear()}-${String(t.getMonth()+1).padStart(2,"0")}-${String(t.getDate()).padStart(2,"0")} ${String(t.getHours()).padStart(2,"0")}:${String(t.getMinutes()).padStart(2,"0")}`};return(e,t)=>{const a=u,n=r,o=i,c=g,p=d;return b(),C(a,{class:"chat-page"},{default:k((()=>[w(a,{class:"page-background"}),w(a,{class:"nav-bar",style:L({paddingTop:H.value+"px",height:J.value+"px"})},{default:k((()=>[w(a,{class:"nav-content"},{default:k((()=>[w(n,{class:"nav-title"},{default:k((()=>[$("èŠå¤©")])),_:1})])),_:1})])),_:1},8,["style"]),R.value?(b(),C(a,{key:0,class:"floating-manage-btn",onClick:ve},{default:k((()=>[w(n,{class:"manage-icon"},{default:k((()=>[$("âš™ï¸")])),_:1})])),_:1})):S("",!0),w(a,{class:"intro-btn-container"},{default:k((()=>[w(o,{class:"intro-btn",onClick:he},{default:k((()=>[w(n,{class:"intro-icon"},{default:k((()=>[$("ğŸ“¢")])),_:1})])),_:1})])),_:1}),W.value?(b(),C(a,{key:1,class:"announcement-modal",onClick:_e},{default:k((()=>[w(a,{class:"modal-content"},{default:k((()=>[w(a,{class:"modal-header"},{default:k((()=>[w(n,{class:"modal-title"},{default:k((()=>[$("ç³»ç»Ÿå…¬å‘Š")])),_:1}),w(a,{class:"close-btn",onClick:_e},{default:k((()=>[$("Ã—")])),_:1})])),_:1}),w(a,{class:"modal-body"},{default:k((()=>[K.value?(b(),C(a,{key:0,class:"announcement-content"},{default:k((()=>[w(n,{class:"announcement-text"},{default:k((()=>[$(D(K.value.content),1)])),_:1}),w(a,{class:"announcement-time"},{default:k((()=>[$(" å‘å¸ƒæ—¶é—´ï¼š"+D(ye(K.value.create_time)),1)])),_:1})])),_:1})):(b(),C(a,{key:1,class:"no-announcement"},{default:k((()=>[w(n,{class:"no-announcement-text"},{default:k((()=>[$("æš‚æ— å…¬å‘Šå†…å®¹")])),_:1})])),_:1}))])),_:1})])),_:1})])),_:1})):S("",!0),w(p,{class:"chat-list-container",style:L({paddingTop:J.value+H.value+"px",paddingBottom:"180rpx"}),"scroll-y":"true","refresher-enabled":"","refresher-triggered":P.value,onRefresherrefresh:ue},{default:k((()=>[N.value?(b(),C(a,{key:0,class:"loading-container"},{default:k((()=>[w(a,{class:"loading-spinner"}),w(n,{class:"loading-text"},{default:k((()=>[$("åŠ è½½ä¸­...")])),_:1})])),_:1})):Y.value.length>0?(b(),C(a,{class:"chat-list",key:z.value},{default:k((()=>[(b(!0),T(I,null,x(Y.value,((e,t)=>(b(),C(a,{key:`${e.id}_${z.value}`,class:"chat-item",onClick:t=>(async e=>{console.log("[ChatList] è¿›å…¥èŠå¤©:",e.title,"æœªè¯»æ•°:",e.unreadCount),e.unreadCount>0&&(console.log("[ChatList] ç«‹å³æ ‡è®°ä¼šè¯å·²è¯»:",e.id),O.markAsRead(e.id),ge(e.id)),v({title:"è¿›å…¥ä¸­..."});try{const t={id:e.id,type:e.type,title:e.title,avatar:e.avatar,targetUserId:e.targetUserId,groupId:"group"===e.type?e.id:null};m("currentChatInfo",t),f();const a=`/pages/chat/room?id=${e.id}&type=${e.type}`;l({url:a})}catch(t){f(),console.error("[ChatList] è¿›å…¥èŠå¤©å¤±è´¥:",t),s({title:"è¿›å…¥å¤±è´¥",icon:"none"})}})(e)},{default:k((()=>[w(a,{class:"avatar-container"},{default:k((()=>[w(a,{class:"avatar-wrapper"},{default:k((()=>[e.avatar?(b(),C(c,{key:1,class:"avatar-image",src:e.avatar,mode:"aspectFill"},null,8,["src"])):(b(),C(a,{key:0,class:"avatar-placeholder"},{default:k((()=>[w(n,{class:"avatar-text"},{default:k((()=>{return[$(D((t=e.title,t?t.charAt(0).toUpperCase():"?")),1)];var t})),_:2},1024)])),_:2},1024))])),_:2},1024),"group"===e.type?(b(),C(a,{key:0,class:"group-badge"},{default:k((()=>[$("ç¾¤")])),_:1})):S("",!0),e.unreadCount>0?(b(),C(a,{key:1,class:"unread-badge"},{default:k((()=>[w(n,{class:"unread-text"},{default:k((()=>[$(D(e.unreadCount>99?"99+":e.unreadCount),1)])),_:2},1024)])),_:2},1024)):S("",!0)])),_:2},1024),w(a,{class:"chat-info"},{default:k((()=>[w(a,{class:"chat-header"},{default:k((()=>[w(n,{class:"chat-title"},{default:k((()=>[$(D(e.title),1)])),_:2},1024),w(n,{class:"chat-time"},{default:k((()=>[$(D(fe(e.updateTime)),1)])),_:2},1024)])),_:2},1024),w(a,{class:"chat-preview"},{default:k((()=>[w(n,{class:"last-message"},{default:k((()=>[$(D(me(e.lastMessage)),1)])),_:2},1024),"group"===e.type?(b(),C(n,{key:0,class:"member-count"},{default:k((()=>[$("("+D(e.memberCount)+"äºº)",1)])),_:2},1024)):S("",!0)])),_:2},1024)])),_:2},1024)])),_:2},1032,["onClick"])))),128))])),_:1})):(b(),C(a,{key:2,class:"empty-state"},{default:k((()=>[w(a,{class:"empty-icon"},{default:k((()=>[$("ğŸ’¬")])),_:1}),w(n,{class:"empty-text"},{default:k((()=>[$("æš‚æ— èŠå¤©è®°å½•")])),_:1}),w(n,{class:"empty-hint"},{default:k((()=>[$(D(R.value?"åˆ›å»ºç¾¤èŠå¼€å§‹æ²Ÿé€š":"ç­‰å¾…ç®¡ç†å‘˜é‚€è¯·åŠ å…¥ç¾¤èŠ"),1)])),_:1})])),_:1}))])),_:1},8,["style","refresher-triggered"]),w(a,{class:"tabbar-placeholder"}),w(A)])),_:1})}}}),[["__scopeId","data-v-bb59a4a8"]]);export{P as default};
