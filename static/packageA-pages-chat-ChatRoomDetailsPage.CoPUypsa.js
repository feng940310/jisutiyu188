import{t as e,d as a,l as t,E as l,c as o,b as s,h as n,k as c,z as i,R as u,C as r,I as d,K as v,J as f,L as p}from"./uni.CnKTWU0K.js";import{b as m,Z as g,a as _}from"./index-C3v_m0JD.js";import{d as y,b as h,r as b,c as D,w as k,a6 as w,ad as x,a7 as I,M as P,aW as C,aP as N,_ as R,aY as j,aX as A,T as F,V as M,aN as S,az as B,ak as H}from"./vendor.CqD9dFNX.js";import{g as J}from"./loginHelper.B8-BL7my.js";import{_ as T}from"./_plugin-vue_export-helper.BCo6x5W8.js";const $=T(y({__name:"ChatRoomDetailsPage",setup(y){const T=h(0),$=h(44),U=h(0);h(10);const O=h(""),z=b({roomId:"",title:"",subtitle:"",avatar:"",avatarUrl:"",mainAvatarUrl:"",startDate:new Date,endDate:new Date,price:0,originalPrice:0,joinedCount:0,type:"upcoming",remainingDays:7}),E=h(0),L=h(!1),Y=h(0),K=D((()=>"active"===z.type&&Y.value>=3&&!L.value?2:Y.value)),V=D((()=>{if("active"!==z.type)return z.price;if("active"===z.type&&!L.value){const e=7;z.originalPrice||0===z.originalPrice||(z.originalPrice=z.price);const a=z.originalPrice/e,t=Math.round(a*z.remainingDays);return console.log("价格计算：",{"原价":z.originalPrice,"每天价格":a,"剩余天数":z.remainingDays,"计算价格":t}),t>0?t:z.price}return z.price})),W=D((()=>{const e=V.value;if(q.value){const a=Math.min(q.value.amount,e);return Math.max(0,e-a)}return e})),X=h(!1),Z=h([]),q=h(null),G=h(!1),Q=h(!1),ee=h(!1),ae=h(""),te=()=>{ee.value=!1,setTimeout((()=>{ae.value=L.value&&Y.value>=3?"enter":L.value&&Y.value<3?"wait":"join",ee.value=!0}),2e3)};k([L,Y,()=>z.type],(()=>{te()}),{immediate:!0}),m((e=>{if(console.log("页面加载参数:",e),le(),e&&e.id){O.value=e.id,console.log("设置roomId:",O.value);J()?(oe(),se(),ne()):(console.log("用户未登录，提示登录"),a({title:"提示",content:"您需要先登录才能查看聊天室详情",confirmText:"去登录",success:e=>{e.confirm?(t("loginRedirect",`/packageA/pages/chat/ChatRoomDetailsPage?id=${O.value}`),l({url:"/pages/profile/user"})):pe()}}))}else console.error("缺少聊天室ID参数"),o({title:"缺少聊天室ID参数",icon:"none"})}));const le=()=>{try{const a=function(){var a;const t=e(),l=t.statusBarHeight||0;let o=44;const s=(null==(a=t.safeAreaInsets)?void 0:a.bottom)||0,n=t.platform||"";o=44,"undefined"!=typeof window&&window.navigator&&window.navigator.userAgent.includes("MicroMessenger")&&(o=50);return{statusBarHeight:l,capsuleHeight:o,safeAreaBottom:s,platform:n}}();T.value=a.statusBarHeight,$.value=a.capsuleHeight,U.value=a.safeAreaBottom,console.log("系统信息获取成功:",{statusBarHeight:T.value,capsuleHeight:$.value,safeAreaBottom:U.value,platform:a.platform})}catch(a){console.error("获取系统信息失败:",a),T.value=0,$.value=44,U.value=0}},oe=async()=>{try{s({title:"加载中..."});const e=J();if(console.log("请求聊天室详情, roomId:",O.value),!O.value)throw new Error("聊天室ID不能为空");const{result:a}=await g.callFunction({name:"chatRoom",data:{action:"getRoomDetails",data:{roomId:O.value},token:e}});if(console.log("聊天室详情结果:",a),a&&0===a.code&&a.data){const e=a.data;Object.assign(z,e),!z.avatar&&e.avatarUrl&&(z.avatar=e.avatarUrl),z.originalPrice||(e.originalPrice?z.originalPrice=e.originalPrice:(z.type,z.originalPrice=z.price),console.log("设置原价:",z.originalPrice));const t=new Date;if("active"===e.type){if(e.start_time?z.startDate=new Date(e.start_time):(console.warn("进行中的聊天室没有开始时间:",O.value),z.startDate=t),e.end_time)z.endDate=new Date(e.end_time);else{console.warn("进行中的聊天室没有结束时间:",O.value);const e=new Date(z.startDate);e.setDate(e.getDate()+7),z.endDate=e}const a=z.endDate.getTime()-t.getTime();z.remainingDays=Math.max(0,Math.ceil(a/864e5))}else{z.startDate=t;const e=new Date(t);e.setDate(e.getDate()+7),z.endDate=e,z.remainingDays=7}Y.value=e.joinedCount||0}else a&&401===a.code?console.log("用户未登录，无法获取完整的聊天室详情"):o({title:(null==a?void 0:a.message)||"获取聊天室详情失败",icon:"none"});Q.value=!0,te()}catch(e){console.error("获取聊天室详情失败",e),o({title:"获取聊天室详情失败",icon:"none"})}finally{n()}},se=async()=>{try{const a=J();let t="";try{const e=c("userInfo");if(e){const a=JSON.parse(e);t=a.user_id||a.userId||a._id||"",console.log("checkUserJoinStatus - 获取到的用户ID:",t)}}catch(e){console.error("获取用户信息失败",e)}if(!t)return void console.error("用户ID不存在，无法检查参与状态");const{result:l}=await g.callFunction({name:"chatRoom",data:{action:"checkUserJoin",data:{roomId:O.value,userId:t},token:a}});console.log("检查用户参与状态结果:",l),l&&0===l.code&&(L.value=l.isJoined)}catch(a){console.error("检查用户团购状态失败",a)}},ne=async()=>{try{const e=J(),{result:a}=await g.callFunction({name:"user",data:{action:"getBalance",token:e}});a&&0===a.code&&(E.value=a.balance)}catch(e){console.error("获取用户余额失败",e)}},ce=()=>{G.value=!G.value,G.value&&0===Z.value.length&&(async()=>{try{const e=J();if(!e)return;const{result:a}=await g.callFunction({name:"coupon",data:{action:"getList",status:"unused",token:e}});a&&0===a.code&&(Z.value=(a.data.list||[]).filter((e=>e.amount<=V.value)))}catch(e){console.error("加载优惠券失败:",e)}})()},ie=e=>{e&&e.amount>V.value?o({title:"优惠券金额超出商品价格",icon:"none"}):(q.value=e,G.value=!1)},ue=()=>{J()?X.value=!0:a({title:"提示",content:"您需要先登录才能参与团购",confirmText:"去登录",success:e=>{e.confirm&&(t("loginRedirect",`/packageA/pages/chat/ChatRoomDetailsPage?id=${O.value}`),l({url:"/pages/profile/user"}))}})},re=()=>{X.value&&(X.value=!1,q.value=null,G.value=!1)},de=async()=>{try{s({title:"处理中..."}),console.log("开始处理支付流程..."),await ne(),console.log("当前用户余额:",E.value),console.log("聊天室价格:",z.price);const n=Number(V.value);if(isNaN(n)||n<=0)return console.error("无效的价格:",V.value),void o({title:"价格无效，请联系客服",icon:"none"});console.log("处理后的价格(数值类型):",n);const i=W.value;if(console.log("最终支付金额:",i),console.log("选中的优惠券:",q.value),E.value<i)return void o({title:"余额不足，请先充值",icon:"none"});const u=J();console.log("获取到的token:",u?"已获取":"未获取");let r="";try{const e=c("userInfo");if(e){const a=JSON.parse(e);r=a.user_id||a.userId||a._id||"",console.log("获取到的用户ID:",r)}}catch(e){console.error("获取用户信息失败",e)}if(!r)return void o({title:"用户信息不完整，请重新登录",icon:"none"});console.log("准备调用joinChatRoom，用户ID:",r,"价格:",n);const d={action:"joinChatRoom",data:{roomId:O.value,originalPrice:n,finalPrice:i,userId:r,coupon:q.value?{couponId:q.value._id,amount:q.value.amount}:null},token:u};console.log("准备调用chatRoom云函数，参数:",JSON.stringify(d));const v=await _.callFunction("chatRoom",d);console.log("云函数返回结果:",JSON.stringify(v)),v&&0===v.code?(v.orderNo&&(t("lastChatRoomOrderNo",v.orderNo),console.log("保存订单号成功:",v.orderNo)),o({title:"参与成功",icon:"success"}),L.value=!0,Y.value=v.joinedCount||Y.value+1,E.value-=i,re(),a({title:"支付成功",content:"您已成功参与此聊天室，是否查看订单详情？",confirmText:"查看订单",cancelText:"继续浏览",success:e=>{e.confirm&&l({url:`/pages/order/index?orderNo=${v.orderNo}`})}})):(console.error("参与失败:",v),o({title:(null==v?void 0:v.message)||"参与失败",icon:"none"}))}catch(i){console.error("参与团购失败",i),o({title:"参与失败，请稍后重试",icon:"none"})}finally{n()}},ve=()=>{l({url:`/packageA/pages/chat/index?id=${O.value}&mode=history`})},fe=e=>{if(!e)return"--";try{const a=new Date(e),t=a.getFullYear(),l=String(a.getMonth()+1).padStart(2,"0");return`${t}/${l}/${String(a.getDate()).padStart(2,"0")}`}catch(a){return"--"}},pe=()=>{try{const e=i();if(console.log("当前页面栈:",e.length),e.length>1)u();else{const e=c("sourcePageForChatRoom")||"";r("index"===e?{url:"/pages/index/index"}:"group"===e?{url:"/pages/group/index"}:"order"===e?{url:"/pages/order/index"}:{url:"/pages/index/index"})}}catch(e){console.error("返回出错:",e),r({url:"/pages/index/index"})}};return(e,a)=>{const t=d,l=v,o=f,s=p;return I(),w(t,{class:"chat-detail-container"},{default:x((()=>[P(t,{class:"background-layer"}),P(t,{class:"content-layer"},{default:x((()=>[P(t,{class:"status-bar",style:N({height:T.value+"px"})},null,8,["style"]),P(t,{class:"capsule-placeholder",style:N({height:$.value+"px"})},{default:x((()=>[P(t,{class:"left-btn",onClick:pe},{default:x((()=>[P(t,{class:"icon-back"})])),_:1}),P(t,{class:"title-box"},{default:x((()=>[P(l,{class:"title"},{default:x((()=>[R("聊天室详情")])),_:1})])),_:1})])),_:1},8,["style"]),P(t,{class:"header"},{default:x((()=>[P(t,{class:"room-info"},{default:x((()=>[P(t,{class:"room-avatar"},{default:x((()=>[z.avatar?(I(),w(o,{key:0,class:"avatar-image",src:z.avatar,mode:"aspectFill"},null,8,["src"])):(I(),w(l,{key:1,class:"avatar-text"},{default:x((()=>[R(j(z.title?z.title.substring(0,1):"U"),1)])),_:1}))])),_:1}),P(t,{class:"room-title-box"},{default:x((()=>[P(l,{class:"room-title multiline-ellipsis"},{default:x((()=>[R(j(z.title),1)])),_:1})])),_:1})])),_:1}),P(t,{class:"room-info"},{default:x((()=>[P(t,{class:"room-title-box full-width"},{default:x((()=>[P(l,{class:"room-subtitle multiline-ellipsis"},{default:x((()=>[R(j(z.subtitle),1)])),_:1})])),_:1})])),_:1}),P(t,{class:"info-action"},{default:x((()=>[P(l,{class:"create-time"},{default:x((()=>[R("时间："+j(fe(z.startDate))+" - "+j(fe(z.endDate)),1)])),_:1})])),_:1}),P(t,{class:"room-status"},{default:x((()=>[P(l,{class:A(["status-tag",{"status-active":"active"===z.type,"status-upcoming":"upcoming"===z.type}])},{default:x((()=>[R(j("active"===z.type?"进行中":"未开始"),1)])),_:1},8,["class"]),"active"===z.type?(I(),w(l,{key:0,class:"remaining-days"},{default:x((()=>[R("剩余 "+j(z.remainingDays)+" 天",1)])),_:1})):C("",!0)])),_:1})])),_:1}),P(t,{class:"members-container"}),P(t,{class:"bottom-action"},{default:x((()=>[P(t,{class:"price-info"},{default:x((()=>[P(t,{class:"price-label"},{default:x((()=>[R(j("active"===z.type?`剩余${z.remainingDays}天价格`:"团购价(3人开团)"),1)])),_:1}),P(t,{class:"price-value"},{default:x((()=>[R("¥"+j(V.value),1)])),_:1})])),_:1}),F(P(t,{class:"action-btns"},{default:x((()=>["enter"===ae.value?(I(),w(s,{key:0,class:"back-btn btn",onClick:ve},{default:x((()=>[R("进入聊天")])),_:1})):C("",!0),"wait"===ae.value?(I(),w(s,{key:1,class:"wait-btn btn",disabled:""},{default:x((()=>[R("等待团购中... "+j(K.value)+"/3",1)])),_:1})):C("",!0),"join"===ae.value?(I(),w(s,{key:2,class:"back-btn btn",onClick:ue},{default:x((()=>[R(j("active"===z.type?"参与聊天":"参与团购")+" "+j(K.value)+"/3",1)])),_:1})):C("",!0)])),_:1},512),[[M,ee.value]])])),_:1}),X.value?(I(),w(t,{key:0,class:"payment-popup-container"},{default:x((()=>[P(t,{class:"payment-popup"},{default:x((()=>[P(t,{class:"popup-header"},{default:x((()=>[P(l,{class:"popup-title"},{default:x((()=>[R("支付确认")])),_:1})])),_:1}),P(t,{class:"popup-content"},{default:x((()=>[P(t,{class:"payment-info"},{default:x((()=>[P(l,{class:"payment-label"},{default:x((()=>[R("支付项目")])),_:1}),P(l,{class:"payment-value"},{default:x((()=>[R(j(z.title)+" "+j("active"===z.type?"聊天":"团购"),1)])),_:1})])),_:1}),P(t,{class:"payment-info"},{default:x((()=>[P(l,{class:"payment-label"},{default:x((()=>[R("支付金额")])),_:1}),P(l,{class:"payment-value"},{default:x((()=>[R("¥"+j(V.value),1)])),_:1})])),_:1}),"active"===z.type&&z.originalPrice?(I(),w(t,{key:0,class:"payment-info"},{default:x((()=>[P(l,{class:"payment-label"},{default:x((()=>[R("原始价格")])),_:1}),P(l,{class:"payment-value"},{default:x((()=>[R("¥"+j(z.originalPrice),1)])),_:1})])),_:1})):C("",!0),"active"===z.type?(I(),w(t,{key:1,class:"payment-info"},{default:x((()=>[P(l,{class:"payment-label"},{default:x((()=>[R("剩余天数")])),_:1}),P(l,{class:"payment-value"},{default:x((()=>[R(j(z.remainingDays)+"天",1)])),_:1})])),_:1})):C("",!0),P(t,{class:"payment-info"},{default:x((()=>[P(l,{class:"payment-label"},{default:x((()=>[R("账户余额")])),_:1}),P(l,{class:"payment-value"},{default:x((()=>{return[R("¥"+j((e=E.value,Number(e).toFixed(2))),1)];var e})),_:1})])),_:1}),P(t,{class:"coupon-section"},{default:x((()=>[P(t,{class:"coupon-header",onClick:ce},{default:x((()=>[P(l,{class:"coupon-label"},{default:x((()=>[R("选择优惠券")])),_:1}),P(t,{class:"coupon-selected"},{default:x((()=>[q.value?(I(),w(l,{key:0,class:"selected-coupon-text"},{default:x((()=>[R("-¥"+j(q.value.amount),1)])),_:1})):(I(),w(l,{key:1,class:"no-coupon-text"},{default:x((()=>[R("暂不使用")])),_:1})),P(l,{class:A(["arrow-icon",{"arrow-up":G.value}])},{default:x((()=>[R("›")])),_:1},8,["class"])])),_:1})])),_:1}),F(P(t,{class:"coupon-list"},{default:x((()=>[P(t,{class:A(["coupon-item no-coupon",{active:!q.value}]),onClick:a[0]||(a[0]=e=>ie(null))},{default:x((()=>[P(l,{class:"coupon-text"},{default:x((()=>[R("暂不使用优惠券")])),_:1})])),_:1},8,["class"]),(I(!0),S(B,null,H(Z.value,(e=>(I(),w(t,{key:e._id,class:A(["coupon-item",{active:q.value&&q.value._id===e._id,disabled:e.amount>V.value}]),onClick:a=>ie(e)},{default:x((()=>[P(t,{class:"coupon-info"},{default:x((()=>[P(l,{class:"coupon-amount"},{default:x((()=>[R("¥"+j(e.amount),1)])),_:2},1024),P(l,{class:"coupon-title"},{default:x((()=>[R(j(e.title),1)])),_:2},1024)])),_:2},1024),e.amount>V.value?(I(),w(l,{key:0,class:"coupon-disabled"},{default:x((()=>[R("金额超出")])),_:1})):C("",!0)])),_:2},1032,["class","onClick"])))),128)),0===Z.value.length?(I(),w(t,{key:0,class:"no-coupons"},{default:x((()=>[P(l,null,{default:x((()=>[R("暂无可用优惠券")])),_:1})])),_:1})):C("",!0)])),_:1},512),[[M,G.value]])])),_:1}),P(t,{class:"payment-info final-amount"},{default:x((()=>[P(l,{class:"payment-label"},{default:x((()=>[R("实付金额")])),_:1}),P(l,{class:"payment-value final-price"},{default:x((()=>[R("¥"+j(W.value),1)])),_:1})])),_:1})])),_:1}),P(t,{class:"popup-actions"},{default:x((()=>[P(s,{class:"cancel-btn",onClick:re},{default:x((()=>[R("取消")])),_:1}),P(s,{class:"confirm-btn",onClick:de,disabled:E.value<W.value},{default:x((()=>[R("确认支付")])),_:1},8,["disabled"])])),_:1})])),_:1})])),_:1})):C("",!0)])),_:1})])),_:1})}}}),[["__scopeId","data-v-d3941894"]]);export{$ as default};
