import{k as e,d as a,R as l,b as t,t as o,h as s,c as n,E as c,l as u,I as r,S as i,J as d,K as v}from"./uni.CnKTWU0K.js";import{b as f,Z as g,c as m,o as _}from"./index-C3v_m0JD.js";import{d as h,b as p,Y as y,a6 as b,ad as k,n as w,a7 as I,M as D,aW as S,aP as x,_ as $,aY as C,aN as T,az as M,ak as N,aX as R}from"./vendor.CqD9dFNX.js";import{g as j}from"./loginHelper.B8-BL7my.js";import{_ as B}from"./_plugin-vue_export-helper.BCo6x5W8.js";const F=B(h({__name:"index",setup(h){p([]);const B=p(0);p(44);const F=p("");p("");const H=p({}),Y=p([]),A=p(!1),E=p(!1),J=p(!0),z=p(1),K=p(20),O=p(""),P=p(0),U=p(!1);p(!0);const W=p(!1),X=p(""),Z=p(0);p(null);const q=p(0),G=p(0),L=p(32),Q=p(null);f(((s={})=>{console.log("聊天页面加载，参数:",s);const n=e("userId")||"";ie.value=n,O.value=n;const c=s.id||"";if(c){F.value=c,console.log("聊天室ID:",F.value),X.value=s.from||"",t({title:"加载中...",mask:!0});try{const e=o();q.value=e.statusBarHeight||0;const a=uni.getMenuButtonBoundingClientRect();G.value=a.top,L.value=a.height,console.log("状态栏高度:",q.value),console.log("胶囊按钮位置:",G.value),console.log("胶囊按钮高度:",L.value)}catch(u){console.error("获取系统信息失败:",u),q.value=20,G.value=44,L.value=32}V()}else a({title:"提示",content:"缺少房间ID参数",showCancel:!1,success:()=>{l()}})}));const V=async()=>{try{const t=j(),o=e("userId")||"";console.log("开始验证聊天室访问权限, 聊天室ID:",F.value),console.log("当前token:",t?"有效":"无效","本地存储的用户ID:",o||"无");const{result:c}=await g.callFunction({name:"chatRoom",data:{action:"validateChatRoomAccess",data:{roomId:F.value,room_id:F.value,userId:o},token:t}});console.log("验证结果:",c),s(),c&&0===c.code?(console.log("验证成功，用户可以访问聊天室"),A.value=!0,c.room&&(H.value=c.room),await(async()=>{try{await me()}catch(e){console.error("初始化消息和设置轮询失败:",e)}})(),c.wasAdded&&n({title:"欢迎加入聊天室",icon:"success"})):c&&401===c.code?(console.error("用户未登录或登录已过期"),fe()):c&&403===c.code?(console.error("用户未购买此聊天室"),ge()):c&&404===c.code?(console.error("聊天室不存在"),a({title:"提示",content:"聊天室不存在或已删除",showCancel:!1,success:()=>{l()}})):(console.error("验证失败:",c),a({title:"提示",content:(null==c?void 0:c.message)||"验证权限失败",showCancel:!1,success:()=>{l()}}))}catch(t){console.error("验证聊天室访问权限出错:",t),s(),a({title:"错误",content:"验证权限时出错，请重试",showCancel:!1,success:()=>{l()}})}};y((()=>{console.log("聊天页面卸载"),Q.value&&(clearInterval(Q.value),Q.value=null)})),m((()=>{console.log("页面隐藏，暂停监听")})),_((()=>{console.log("页面显示，恢复轮询"),!Q.value&&A.value?(console.log("重新启动轮询"),me()):console.log("轮询已存在，无需重新启动")}));const ee=async(e=!0)=>{if(!E.value){E.value=!0,console.log("开始加载消息, refresh:",e,"page:",z.value,"聊天室ID:",F.value);try{e&&(z.value=1,Y.value=[]);const a=g.database();if(!F.value)return console.error("聊天室ID为空，无法查询消息"),void(E.value=!1);console.log("使用简单查询方式");const l=a.collection("chat_messages").where({room_id:F.value}).orderBy("create_time","desc");e?l.limit(K.value):l.skip((z.value-1)*K.value).limit(K.value);const t=await l.get(),o=t.result||t;if(console.log("查询结果:",o),o.data&&o.data.length>0){if(e)Y.value=o.data;else{const e=Y.value.map((e=>e._id)),a=o.data.filter((a=>!e.includes(a._id)));a.length>0?(Y.value=[...Y.value,...a],console.log("添加新消息，数量:",a.length)):console.log("没有新的唯一消息可添加")}console.log("设置消息成功，总数量:",Y.value.length),w((()=>{P.value=0===P.value?1:0})),J.value=o.data.length>=K.value,J.value&&z.value++}else{console.log("未查询到消息数据，尝试备用查询");const l=a.command.or([{room_id:F.value},{roomId:F.value}]),t=await a.collection("chat_messages").where(l).orderBy("create_time","desc").limit(K.value).get(),o=t.result||t;if(console.log("备用查询结果:",o),o.data&&o.data.length>0){if(e)Y.value=o.data;else{const e=Y.value.map((e=>e._id)),a=o.data.filter((a=>!e.includes(a._id)));a.length>0&&(Y.value=[...Y.value,...a])}console.log("备用查询成功，消息数量:",Y.value.length),J.value=o.data.length>=K.value,J.value&&z.value++}else console.log("所有查询方法都未返回数据")}}catch(a){console.error("获取聊天消息失败",a),n({title:"获取聊天消息失败",icon:"none"})}finally{E.value=!1,W.value=!1}}},ae=()=>{J.value&&!E.value&&ee(!1)},le=e=>{if(!e)return!1;try{let a;if(a="number"==typeof e?e:"string"==typeof e?e.match(/^\d+$/)?parseInt(e):new Date(e).getTime():e.getTime(),isNaN(a))return console.error("无效的时间格式:",e),!1;const l=(new Date).getTime();return l-a<=36e5}catch(a){return console.error("判断新消息时间出错:",a,e),!1}},te=()=>{l()},oe=()=>{console.log("点击查看按钮，显示聊天室信息"),H.value&&H.value.title?(console.log("直接显示已加载的聊天室信息:",H.value),U.value=!0):(console.log("聊天室信息为空，尝试加载"),ce().then((()=>{U.value=!0})))},se=()=>{U.value=!1},ne=async()=>{console.log("刷新聊天室信息");const e=await ce();n(e?{title:"刷新成功",icon:"success"}:{title:"刷新失败",icon:"none"})},ce=async()=>{var e;if(console.log("加载聊天室信息, 聊天室ID:",F.value),!F.value)return console.error("聊天室ID为空，无法加载信息"),n({title:"无法获取聊天室信息",icon:"none"}),!1;const a=j();try{console.log("直接查询数据库获取聊天室信息");const l=g.database(),t=await l.collection("chat_rooms").where({room_id:F.value}).limit(1).get();if(console.log("直接查询聊天室结果:",JSON.stringify(t)),t.data&&t.data.length>0)return H.value=t.data[0],console.log("通过直接查询成功获取聊天室信息:",H.value),!0;console.log("调用云函数获取聊天室详情");const o=await g.callFunction({name:"chatRoom",data:{action:"getRoomDetails",data:{roomId:F.value},token:a}});if(console.log("获取聊天室信息结果:",o),o.result&&0===o.result.code&&o.result.data){const e={...H.value};return H.value=o.result.data,!H.value.members&&e.members&&(H.value.members=e.members),console.log("成功加载聊天室信息:",H.value),!0}throw new Error((null==(e=o.result)?void 0:e.message)||"获取聊天室信息失败")}catch(l){return console.error("获取聊天室信息失败",l),n({title:"获取聊天室信息失败",icon:"none"}),!1}},ue=e=>{if(!e)return"";try{let a;if(a="number"==typeof e?new Date(e):"string"==typeof e?e.match(/^\d+$/)?new Date(parseInt(e)):new Date(e):e,isNaN(a.getTime()))return console.error("无效的日期格式:",e),String(e);const l=a.getFullYear(),t=(a.getMonth()+1).toString().padStart(2,"0"),o=a.getDate().toString().padStart(2,"0"),s=a.getHours().toString().padStart(2,"0"),n=a.getMinutes().toString().padStart(2,"0");return`${l}-${t}-${o} ${s}:${n}:${a.getSeconds().toString().padStart(2,"0")}`}catch(a){return console.error("格式化日期时间出错:",a,e),String(e)}},re=async()=>{console.log("手动刷新消息"),W.value=!0,t({title:"刷新中..."});try{await ee(!0),s(),n({title:"刷新成功",icon:"success"})}catch(e){console.error("刷新消息失败:",e),s(),n({title:"刷新失败",icon:"none"})}finally{W.value=!1}},ie=p(""),de=()=>{switch(H.value.type){case"pending":return"待开始";case"active":return"进行中";case"ended":return"已结束";default:return"未知状态"}},ve=()=>{if(!H.value.end_time)return"";const e=new Date,a=new Date(H.value.end_time).getTime()-e.getTime();if(a<=0)return"即将结束";const l=Math.floor(a/864e5),t=Math.floor(a%864e5/36e5);if(l>0)return`${l}天${t}小时`;return`${t}小时${Math.floor(a%36e5/6e4)}分钟`},fe=()=>{a({title:"请先登录",content:"您需要登录后才能访问此聊天室",confirmText:"去登录",success:e=>{e.confirm?c({url:"/pages/profile/user"}):l()}})},ge=()=>{a({title:"未购买",content:"您尚未购买此聊天室",confirmText:"去购买",success:e=>{e.confirm?c({url:`/pages/goods/detail?id=${F.value}`}):l()}})},me=async()=>{try{return console.log("开始设置轮询机制"),await(async()=>{try{const a=e("userId");if(a)return ie.value=a,console.log("从本地存储获取用户ID:",a),a;const{result:l}=await g.callFunction({name:"user",data:{action:"getUserInfo"}});if(l&&0===l.code&&l.data){const e=l.data._id;return ie.value=e,u("userId",e),console.log("从云函数获取用户ID:",e),e}return console.error("获取用户信息失败:",l),""}catch(a){return console.error("获取用户ID出错:",a),""}})(),await ee(!0),_e(),!0}catch(a){return console.error("设置轮询机制失败:",a),!1}},_e=()=>{console.log("启动轮询消息机制，每30秒查询一次"),Q.value&&(clearInterval(Q.value),Q.value=null),Q.value=setInterval((()=>{A.value?(console.log("执行定时轮询，获取最新消息"),ee(!0)):(console.log("没有权限，停止轮询"),clearInterval(Q.value),Q.value=null)}),3e4)};return(e,a)=>{const l=r,t=d,o=v,s=i;return I(),b(l,{class:"chat-page"},{default:k((()=>[D(l,{class:"background-layer"}),D(l,{class:"content-layer"},{default:k((()=>[D(l,{class:"status-bar",style:x({height:B.value+"px"})},null,8,["style"]),D(l,{class:"nav-area",style:x({top:G.value+"px"})},{default:k((()=>[D(l,{class:"back-btn",onClick:te,style:{top:0}},{default:k((()=>[D(l,{class:"icon-back"})])),_:1}),D(l,{class:"page-title",style:x({height:L.value+"px",lineHeight:L.value+"px",top:0})},{default:k((()=>[$(C(H.value.title||"聊天室"),1)])),_:1},8,["style"]),D(l)])),_:1},8,["style"]),D(s,{id:"message-list",class:"chat-container",style:x({top:G.value+L.value+15+"px",height:"calc(100vh - "+(G.value+L.value+15)+"px)"}),"scroll-y":"true","scroll-top":P.value,onScrolltoupper:ae},{default:k((()=>[E.value?(I(),b(l,{key:0,class:"loading-more"},{default:k((()=>[$("加载中...")])),_:1})):S("",!0),(I(),b(l,{class:"chat-list",key:"list-"+Z.value},{default:k((()=>[(I(!0),T(M,null,N(Y.value,((e,a)=>(I(),b(l,{key:e._id||a,class:R(["chat-item",{"my-message":e.user_id===ie.value}])},{default:k((()=>[D(l,{class:"avatar-section"},{default:k((()=>[D(t,{class:"chat-avatar",src:H.value.avatar||"/static/logo.png",mode:"aspectFit"},null,8,["src"])])),_:1}),D(l,{class:"content-section"},{default:k((()=>[D(l,{class:"message-header"},{default:k((()=>[D(l,{class:"nickname-container"},{default:k((()=>[D(l,{class:"nickname"},{default:k((()=>[$(C(e.room_title),1)])),_:2},1024),le(e.create_time)?(I(),b(l,{key:0,class:"tag-container"},{default:k((()=>[D(l,{class:"slant-tag"},{default:k((()=>[$("新")])),_:1})])),_:1})):S("",!0)])),_:2},1024)])),_:2},1024),D(l,{class:"message-content"},{default:k((()=>[D(l,{class:"chat-bubble"},{default:k((()=>[D(o,null,{default:k((()=>[$(C(e.content),1)])),_:2},1024)])),_:2},1024)])),_:2},1024),D(l,{class:"time-info"},{default:k((()=>[D(o,{class:"date"},{default:k((()=>[$(C(ue(e.create_time)),1)])),_:2},1024)])),_:2},1024)])),_:2},1024)])),_:2},1032,["class"])))),128))])),_:1})),0!==Y.value.length||E.value?S("",!0):(I(),b(l,{key:1,class:"empty-tip"},{default:k((()=>[D(o,null,{default:k((()=>[$("暂无消息，开始聊天吧~")])),_:1})])),_:1}))])),_:1},8,["style","scroll-top"])])),_:1}),U.value?(I(),b(l,{key:0,class:"room-info-popup"},{default:k((()=>[D(l,{class:"info-content"},{default:k((()=>[D(l,{class:"info-header"},{default:k((()=>[D(o,{class:"info-title"},{default:k((()=>[$("聊天室详细信息")])),_:1}),D(o,{class:"close-btn",onClick:se},{default:k((()=>[$("×")])),_:1})])),_:1}),H.value._id?(I(),b(l,{key:0,class:"info-body"},{default:k((()=>[D(l,{class:"info-item"},{default:k((()=>[D(o,{class:"info-label"},{default:k((()=>[$("聊天室名称")])),_:1}),D(o,{class:"info-value"},{default:k((()=>[$(C(H.value.title||"未命名聊天室"),1)])),_:1})])),_:1}),D(l,{class:"info-item"},{default:k((()=>[D(o,{class:"info-label"},{default:k((()=>[$("聊天室ID")])),_:1}),D(o,{class:"info-value"},{default:k((()=>[$(C(H.value._id||F.value),1)])),_:1})])),_:1}),D(l,{class:"info-item"},{default:k((()=>[D(o,{class:"info-label"},{default:k((()=>[$("状态")])),_:1}),D(o,{class:"info-value"},{default:k((()=>[$(C(de()),1)])),_:1})])),_:1}),H.value.create_time||H.value.create_date?(I(),b(l,{key:0,class:"info-item"},{default:k((()=>[D(o,{class:"info-label"},{default:k((()=>[$("创建时间")])),_:1}),D(o,{class:"info-value"},{default:k((()=>[$(C(ue(H.value.create_time||H.value.create_date)),1)])),_:1})])),_:1})):S("",!0),H.value.end_time?(I(),b(l,{key:1,class:"info-item"},{default:k((()=>[D(o,{class:"info-label"},{default:k((()=>[$("结束时间")])),_:1}),D(o,{class:"info-value"},{default:k((()=>[$(C(ue(H.value.end_time)),1)])),_:1})])),_:1})):S("",!0),H.value.end_time?(I(),b(l,{key:2,class:"info-item"},{default:k((()=>[D(o,{class:"info-label"},{default:k((()=>[$("剩余时间")])),_:1}),D(o,{class:"info-value"},{default:k((()=>[$(C(ve()),1)])),_:1})])),_:1})):S("",!0),void 0!==H.value.price?(I(),b(l,{key:3,class:"info-item"},{default:k((()=>[D(o,{class:"info-label"},{default:k((()=>[$("价格")])),_:1}),D(o,{class:"info-value"},{default:k((()=>[$(C(H.value.price)+"元",1)])),_:1})])),_:1})):S("",!0),H.value.description?(I(),b(l,{key:4,class:"info-item description"},{default:k((()=>[D(o,{class:"info-label"},{default:k((()=>[$("聊天室介绍")])),_:1}),D(o,{class:"info-value"},{default:k((()=>[$(C(H.value.description),1)])),_:1})])),_:1})):S("",!0),D(l,{class:"info-item action-section"},{default:k((()=>[D(l,{class:"action-buttons"},{default:k((()=>[D(l,{class:"action-button refresh",onClick:ne},{default:k((()=>[$("刷新聊天室")])),_:1}),D(l,{class:"action-button refresh",onClick:re},{default:k((()=>[$("刷新消息")])),_:1})])),_:1})])),_:1})])),_:1})):(I(),b(l,{key:1,class:"loading-room-info"},{default:k((()=>[D(l,{class:"loading-spinner"}),D(o,{class:"loading-text"},{default:k((()=>[$("加载聊天室信息...")])),_:1})])),_:1}))])),_:1})])),_:1})):S("",!0),D(l,{class:"debug-fab",onClick:oe},{default:k((()=>[D(o,{class:"debug-text"},{default:k((()=>[$("查看")])),_:1})])),_:1})])),_:1})}}}),[["__scopeId","data-v-ed850b25"]]);export{F as default};
