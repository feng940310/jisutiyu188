import{t as e,k as a,c as t,R as l,I as s,K as o,M as n,J as i,L as c,T as u,w as d,b as r,h as m,d as f}from"./uni.CnKTWU0K.js";import{Z as v}from"./index-C3v_m0JD.js";import{d as p,b as _,r as g,c as h,R as b,a6 as y,ad as k,aP as w,a7 as C,M as T,aW as D,_ as $,aN as S,az as x,ak as R,aY as V,aX as F,ai as I}from"./vendor.CqD9dFNX.js";import{_ as M}from"./_plugin-vue_export-helper.BCo6x5W8.js";const H=M(p({__name:"chat-room-maintenance",setup(p){const M=_(20),H=_({}),P=_(1),j=_(10),L=_(1),U=_(""),Y=_([]),Z=_(!0),z=_(!1),N=_(!1),O=g({_id:"",title:"",subtitle:"",avatar:"",bgImage:"",startTime:"18:00",endTime:"22:00",startDate:oe(new Date),endDate:oe(new Date(Date.now()+6048e5)),type:"upcoming",isHot:!1,price:888,originalPrice:888}),B=_(""),E=_(!1),G=_(!1),J=_(null),K=h((()=>({height:"44px",paddingTop:"0px"}))),W=h((()=>{if(H.value&&H.value.top){const e=H.value.top-M.value;return{height:H.value.height+"px",marginTop:e+"px"}}return{}})),X=h((()=>U.value?Y.value.filter((e=>e.title.toLowerCase().includes(U.value.toLowerCase())||e.subtitle&&e.subtitle.toLowerCase().includes(U.value.toLowerCase()))):Y.value));b((()=>{const a=e();M.value=a.statusBarHeight||20,q()}));const q=async()=>{Z.value=!0;try{const e=a("token");if(!e)return t({title:"请先登录",icon:"none"}),void setTimeout((()=>{l()}),1500);console.log("开始加载聊天室列表，页码:",P.value,"页大小:",j.value);const{result:s}=await v.callFunction({name:"chatRoom",data:{action:"adminGetChatRooms",page:P.value,pageSize:j.value,keyword:U.value,token:e}});console.log("聊天室列表加载结果:",s),s&&0===s.code?(Y.value=s.data,L.value=Math.ceil(s.total/j.value),console.log("聊天室列表加载成功，数量:",s.data.length,"总页数:",L.value)):(console.error("聊天室列表加载失败:",s),t({title:(null==s?void 0:s.message)||(null==s?void 0:s.msg)||"加载失败",icon:"none"}),401!==(null==s?void 0:s.code)&&403!==(null==s?void 0:s.code)||setTimeout((()=>{l()}),1500))}catch(e){console.error("加载聊天室数据失败:",e),t({title:"加载失败",icon:"none"})}finally{Z.value=!1}},A=()=>{},Q=e=>{P.value=e,q()},ee=()=>{N.value=!0;const e=new Date,a=new Date(e.getTime()+6048e5),t=e.getHours().toString().padStart(2,"0"),l=e.getMinutes().toString().padStart(2,"0");Object.assign(O,{_id:"",title:"",subtitle:"",avatar:"",bgImage:"",startTime:`${t}:${l}`,endTime:`${t}:${l}`,startDate:oe(e),endDate:oe(a),type:"upcoming",isHot:!1,price:888,originalPrice:888}),B.value="",z.value=!0},ae=()=>{z.value=!1,B.value=""},te=async()=>{if(O.title)try{const e=a("token");if(!e)return void t({title:"请先登录",icon:"none"});if(N.value){const e=await(async e=>{try{const t=a("token");if(!t)return!1;const{result:l}=await v.callFunction({name:"chatRoom",data:{action:"checkRoomNameExists",title:e,token:t,currentId:N.value?"":O._id}});return l&&0===l.code&&l.exists}catch(t){return console.error("检查聊天室名称失败:",t),!1}})(O.title);if(e)return B.value="聊天室名称已存在",void t({title:"聊天室名称已存在",icon:"none"})}O.type="upcoming";const l=new Date,s=new Date(l.getTime()+6048e5),o=l.getHours().toString().padStart(2,"0"),n=l.getMinutes().toString().padStart(2,"0");O.startTime=`${o}:${n}`,O.endTime=`${o}:${n}`,O.startDate=oe(l),O.endDate=oe(s),O.subscribers=0,O.purchases_count=0,O.originalPrice=O.price;const i=`${O.startDate}T${O.startTime}:00.000Z`,c=`${O.endDate}T${O.endTime}:00.000Z`,u=i,d=c,r={...O,start_time:O.startTime,end_time:O.endTime,startTime:O.startTime,endTime:O.endTime,startDate:u,endDate:d},m=N.value?"adminCreateChatRoom":"adminUpdateChatRoom",{result:f}=await v.callFunction({name:"chatRoom",data:{action:m,room:r,token:e}});f&&0===f.code?(t({title:N.value?"创建成功":"更新成功",icon:"success"}),ae(),q()):(t({title:(null==f?void 0:f.message)||(null==f?void 0:f.msg)||(N.value?"创建失败":"更新失败"),icon:"none"}),401!==(null==f?void 0:f.code)&&403!==(null==f?void 0:f.code)||setTimeout((()=>{ae()}),1500))}catch(e){console.error(N.value?"创建聊天室失败:":"更新聊天室失败:",e),t({title:N.value?"创建失败":"更新失败",icon:"none"})}else t({title:"请输入聊天室名称",icon:"none"})},le=e=>{O.isHot=e.detail.value},se=e=>{switch(e){case"active":return"已开始";case"upcoming":return"未开始";case"ended":return"已结束";default:return"未知"}};function oe(e){return`${e.getFullYear()}-${String(e.getMonth()+1).padStart(2,"0")}-${String(e.getDate()).padStart(2,"0")}`}const ne=e=>{if(!e)return"未知";const a=new Date(e);return`${a.getFullYear()}-${String(a.getMonth()+1).padStart(2,"0")}-${String(a.getDate()).padStart(2,"0")}`},ie=()=>{l()},ce=()=>{G.value=!1,J.value=null},ue=async()=>{var e;if(J.value)try{const l=a("token");if(!l)return void t({title:"请先登录",icon:"none"});r({title:"删除中..."});const{result:s}=await v.callFunction({name:"chatRoom",data:{action:"adminDeleteChatRoom",roomId:J.value._id,token:l}});m(),s&&0===s.code?(console.log("删除聊天室成功:",null==(e=J.value)?void 0:e.title),t({title:"删除成功",icon:"success"}),ce(),console.log("开始重新加载聊天室列表"),P.value=1,await q()):(t({title:(null==s?void 0:s.message)||"删除失败",icon:"none"}),401!==(null==s?void 0:s.code)&&403!==(null==s?void 0:s.code)||setTimeout((()=>{ce()}),1500))}catch(l){console.error("删除聊天室失败:",l),m(),t({title:"删除失败",icon:"none"})}},de=async()=>{try{const e=a("token");if(!e)return void t({title:"请先登录",icon:"none"});f({title:"确认清理",content:"确定要清理数据库中的无效数据吗？这将删除所有缺少必要字段的聊天室记录。",success:async a=>{if(a.confirm){r({title:"清理中..."});const{result:a}=await v.callFunction({name:"chatRoom",data:{action:"adminCleanupInvalidData",token:e}});if(m(),a&&0===a.code){const e=a.data;f({title:"清理完成",content:`总聊天室: ${e.totalRooms}\n有效聊天室: ${e.validRooms}\n删除聊天室: ${e.deletedRooms}\n删除订阅: ${e.deletedSubscriptions}`,showCancel:!1}),await q()}else t({title:(null==a?void 0:a.message)||"清理失败",icon:"none"})}}})}catch(e){console.error("清理无效数据失败:",e),m(),t({title:"清理失败",icon:"none"})}};return(e,a)=>{const l=s,f=o,p=n,_=i,g=c,h=u;return C(),y(l,{class:"chat-room-maintenance",style:w({paddingTop:M.value+"px"})},{default:k((()=>[T(l,{class:"nav-bar",style:w(K.value)},{default:k((()=>[T(l,{class:"nav-left",onClick:ie,style:w(W.value)},{default:k((()=>[T(l,{class:"back-arrow"})])),_:1},8,["style"]),T(l,{class:"nav-center"},{default:k((()=>[$("聊天室维护")])),_:1}),T(l,{class:"nav-right"})])),_:1},8,["style"]),T(l,{class:"search-container"},{default:k((()=>[T(l,{class:"search-box"},{default:k((()=>[T(f,{class:"search-icon"},{default:k((()=>[$("🔍")])),_:1}),T(p,{class:"search-input",placeholder:"搜索聊天室",modelValue:U.value,"onUpdate:modelValue":a[0]||(a[0]=e=>U.value=e),onInput:A},null,8,["modelValue"])])),_:1})])),_:1}),T(l,{class:"room-list"},{default:k((()=>[Z.value?(C(),y(l,{key:0,class:"loading"},{default:k((()=>[T(f,null,{default:k((()=>[$("加载中...")])),_:1})])),_:1})):0===X.value.length?(C(),y(l,{key:1,class:"empty-state"},{default:k((()=>[T(f,null,{default:k((()=>[$("暂无聊天室数据")])),_:1})])),_:1})):(C(!0),S(x,{key:2},R(X.value,((e,a)=>(C(),y(l,{key:e._id,class:"room-item",onClick:a=>(e=>{N.value=!1,Object.assign(O,e),B.value="",z.value=!0})(e)},{default:k((()=>[T(l,{class:"room-avatar-container"},{default:k((()=>[e.avatar?(C(),y(_,{key:0,class:"room-avatar",src:e.avatar,mode:"aspectFill"},null,8,["src"])):(C(),y(l,{key:1,class:"room-avatar room-avatar-placeholder"},{default:k((()=>[T(f,null,{default:k((()=>[$(V(e.title?e.title.substring(0,1):"?"),1)])),_:2},1024)])),_:2},1024))])),_:2},1024),T(l,{class:"room-content"},{default:k((()=>[T(l,{class:"room-header"},{default:k((()=>[T(f,{class:"room-name ellipsis"},{default:k((()=>[$(V(e.title),1)])),_:2},1024),T(f,{class:F(["room-status",{"status-active":"active"===e.type,"status-upcoming":"upcoming"===e.type,"status-ended":"ended"===e.type}])},{default:k((()=>[$(V(se(e.type)),1)])),_:2},1032,["class"])])),_:2},1024),T(l,{class:"room-subtitle ellipsis"},{default:k((()=>[$(V(e.subtitle||"无副标题"),1)])),_:2},1024),T(l,{class:"room-info-row"},{default:k((()=>[T(f,{class:"room-price"},{default:k((()=>[$("¥"+V(e.price||0),1)])),_:2},1024),T(f,{class:"room-time"},{default:k((()=>[$(V(ne(e.startDate))+" "+V(e.startTime)+" - "+V(ne(e.endDate))+" "+V(e.endTime),1)])),_:2},1024)])),_:2},1024)])),_:2},1024),T(l,{class:"room-actions"},{default:k((()=>[T(l,{class:"delete-button",onClick:I((a=>(e=>{J.value=e,G.value=!0})(e)),["stop"])},{default:k((()=>[T(f,{class:"delete-icon"},{default:k((()=>[$("🗑️")])),_:1}),T(f,{class:"delete-text"},{default:k((()=>[$("删除")])),_:1})])),_:2},1032,["onClick"])])),_:2},1024)])),_:2},1032,["onClick"])))),128))])),_:1}),T(l,{class:"pagination"},{default:k((()=>[T(g,{class:"page-button",disabled:P.value<=1,onClick:a[1]||(a[1]=e=>Q(P.value-1))},{default:k((()=>[$("上一页")])),_:1},8,["disabled"]),T(f,{class:"page-info"},{default:k((()=>[$(V(P.value)+" / "+V(L.value||1),1)])),_:1}),T(g,{class:"page-button",disabled:P.value>=L.value,onClick:a[2]||(a[2]=e=>Q(P.value+1))},{default:k((()=>[$("下一页")])),_:1},8,["disabled"])])),_:1}),T(l,{class:"add-button-container"},{default:k((()=>[T(g,{class:"add-button-fixed",onClick:ee},{default:k((()=>[$("+")])),_:1}),Y.value.length>0?(C(),y(g,{key:0,class:"cleanup-button-fixed",onClick:de},{default:k((()=>[$("清理")])),_:1})):D("",!0)])),_:1}),z.value?(C(),y(l,{key:0,class:"modal"},{default:k((()=>[T(l,{class:"modal-content"},{default:k((()=>[T(l,{class:"modal-header"},{default:k((()=>[T(f,{class:"modal-title"},{default:k((()=>[$(V(N.value?"新增聊天室":"编辑聊天室"),1)])),_:1}),T(f,{class:"modal-close",onClick:ae},{default:k((()=>[$("×")])),_:1})])),_:1}),T(l,{class:"modal-body"},{default:k((()=>[T(l,{class:"form-section"},{default:k((()=>[T(l,{class:"form-item"},{default:k((()=>[T(f,{class:"form-label"},{default:k((()=>[$("聊天室名称")])),_:1}),T(l,{class:"input-container"},{default:k((()=>[T(p,{class:"form-input",modelValue:O.title,"onUpdate:modelValue":a[3]||(a[3]=e=>O.title=e),placeholder:"请输入聊天室名称"},null,8,["modelValue"])])),_:1}),B.value?(C(),y(f,{key:0,class:"error-text"},{default:k((()=>[$(V(B.value),1)])),_:1})):D("",!0)])),_:1}),T(l,{class:"form-item"},{default:k((()=>[T(f,{class:"form-label"},{default:k((()=>[$("副标题")])),_:1}),T(l,{class:"input-container"},{default:k((()=>[T(p,{class:"form-input",modelValue:O.subtitle,"onUpdate:modelValue":a[4]||(a[4]=e=>O.subtitle=e),placeholder:"请输入副标题"},null,8,["modelValue"])])),_:1})])),_:1}),T(l,{class:"form-item"},{default:k((()=>[T(f,{class:"form-label"},{default:k((()=>[$("头像图片")])),_:1}),T(l,{class:"image-upload"},{default:k((()=>[O.avatar?(C(),y(_,{key:0,class:"preview-image",src:O.avatar,mode:"aspectFill"},null,8,["src"])):(C(),y(l,{key:1,class:"preview-image empty-image"},{default:k((()=>[T(f,{class:"empty-image-text"},{default:k((()=>[$("暂无图片")])),_:1})])),_:1})),T(g,{class:"upload-button",onClick:a[5]||(a[5]=e=>(E.value=!0,void d({count:1,success:e=>{const a=e.tempFilePaths[0];r({title:"上传中..."}),v.uploadFile({filePath:a,cloudPath:`chat-room-images/${Date.now()}-${Math.random().toString(36).slice(2)}.${a.split(".").pop()}`,success:e=>{console.log("上传成功",e),O.avatar=e.fileID,O.bgImage=e.fileID,m(),t({title:"上传成功",icon:"success"})},fail:e=>{console.error("上传失败",e),m(),t({title:"上传失败",icon:"none"})},complete:()=>{E.value=!1}})}})))},{default:k((()=>[$(V(E.value?"上传中...":O.avatar?"更换图片":"上传图片"),1)])),_:1})])),_:1})])),_:1}),T(l,{class:"form-item"},{default:k((()=>[T(f,{class:"form-label"},{default:k((()=>[$("聊天室价格")])),_:1}),T(l,{class:"input-container"},{default:k((()=>[T(f,{class:"price-symbol"},{default:k((()=>[$("¥")])),_:1}),T(p,{class:"form-input price-input",modelValue:O.price,"onUpdate:modelValue":a[6]||(a[6]=e=>O.price=e),placeholder:"请输入价格",type:"number"},null,8,["modelValue"])])),_:1})])),_:1}),T(l,{class:"form-item switch-item"},{default:k((()=>[T(f,{class:"form-label"},{default:k((()=>[$("是否热门")])),_:1}),T(h,{checked:O.isHot,onChange:le,color:"#07C160"},null,8,["checked"])])),_:1})])),_:1})])),_:1}),T(l,{class:"modal-footer"},{default:k((()=>[T(g,{class:"cancel-button",onClick:ae},{default:k((()=>[$("关闭")])),_:1}),T(g,{class:"save-button",onClick:te},{default:k((()=>[$("保存")])),_:1})])),_:1})])),_:1})])),_:1})):D("",!0),G.value?(C(),y(l,{key:1,class:"modal"},{default:k((()=>[T(l,{class:"modal-content delete-modal"},{default:k((()=>[T(l,{class:"modal-header delete-header"},{default:k((()=>[T(l,{class:"delete-title-container"},{default:k((()=>[T(f,{class:"delete-title-icon"},{default:k((()=>[$("🗑️")])),_:1}),T(f,{class:"modal-title delete-title"},{default:k((()=>[$("确认删除")])),_:1})])),_:1})])),_:1}),T(l,{class:"modal-body"},{default:k((()=>[T(l,{class:"delete-message"},{default:k((()=>[T(f,null,{default:k((()=>{var e;return[$('确定要删除聊天室 "'+V(null==(e=J.value)?void 0:e.title)+'" 吗？',1)]})),_:1}),T(f,{class:"delete-warning"},{default:k((()=>[$("删除后将无法恢复，但用户的购买记录会保留。")])),_:1})])),_:1})])),_:1}),T(l,{class:"modal-footer"},{default:k((()=>[T(g,{class:"cancel-button",onClick:ce},{default:k((()=>[$("取消")])),_:1}),T(g,{class:"delete-confirm-button",onClick:ue},{default:k((()=>[$("确认删除")])),_:1})])),_:1})])),_:1})])),_:1})):D("",!0)])),_:1},8,["style"])}}}),[["__scopeId","data-v-0f75afd7"]]);export{H as default};
