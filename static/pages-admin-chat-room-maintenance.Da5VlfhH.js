import{t as e,k as a,c as t,R as l,I as s,K as o,M as n,J as i,L as c,T as u,w as d,b as r,h as m,d as f}from"./uni.CnKTWU0K.js";import{Z as v}from"./index-C3v_m0JD.js";import{d as p,b as _,r as g,c as h,R as b,a6 as y,ad as k,aP as w,a7 as C,M as T,aW as D,_ as $,aN as S,az as x,ak as R,aY as V,aX as F,ai as I}from"./vendor.CqD9dFNX.js";import{_ as M}from"./_plugin-vue_export-helper.BCo6x5W8.js";const H=M(p({__name:"chat-room-maintenance",setup(p){const M=_(20),H=_({}),P=_(1),j=_(10),L=_(1),U=_(""),Y=_([]),Z=_(!0),z=_(!1),N=_(!1),O=g({_id:"",title:"",subtitle:"",avatar:"",bgImage:"",startTime:"18:00",endTime:"22:00",startDate:oe(new Date),endDate:oe(new Date(Date.now()+6048e5)),type:"upcoming",isHot:!1,price:888,originalPrice:888}),B=_(""),E=_(!1),G=_(!1),J=_(null),K=h((()=>({height:"44px",paddingTop:"0px"}))),W=h((()=>{if(H.value&&H.value.top){const e=H.value.top-M.value;return{height:H.value.height+"px",marginTop:e+"px"}}return{}})),X=h((()=>U.value?Y.value.filter((e=>e.title.toLowerCase().includes(U.value.toLowerCase())||e.subtitle&&e.subtitle.toLowerCase().includes(U.value.toLowerCase()))):Y.value));b((()=>{const a=e();M.value=a.statusBarHeight||20,q()}));const q=async()=>{Z.value=!0;try{const e=a("token");if(!e)return t({title:"è¯·å…ˆç™»å½•",icon:"none"}),void setTimeout((()=>{l()}),1500);console.log("å¼€å§‹åŠ è½½èŠå¤©å®¤åˆ—è¡¨ï¼Œé¡µç :",P.value,"é¡µå¤§å°:",j.value);const{result:s}=await v.callFunction({name:"chatRoom",data:{action:"adminGetChatRooms",page:P.value,pageSize:j.value,keyword:U.value,token:e}});console.log("èŠå¤©å®¤åˆ—è¡¨åŠ è½½ç»“æžœ:",s),s&&0===s.code?(Y.value=s.data,L.value=Math.ceil(s.total/j.value),console.log("èŠå¤©å®¤åˆ—è¡¨åŠ è½½æˆåŠŸï¼Œæ•°é‡:",s.data.length,"æ€»é¡µæ•°:",L.value)):(console.error("èŠå¤©å®¤åˆ—è¡¨åŠ è½½å¤±è´¥:",s),t({title:(null==s?void 0:s.message)||(null==s?void 0:s.msg)||"åŠ è½½å¤±è´¥",icon:"none"}),401!==(null==s?void 0:s.code)&&403!==(null==s?void 0:s.code)||setTimeout((()=>{l()}),1500))}catch(e){console.error("åŠ è½½èŠå¤©å®¤æ•°æ®å¤±è´¥:",e),t({title:"åŠ è½½å¤±è´¥",icon:"none"})}finally{Z.value=!1}},A=()=>{},Q=e=>{P.value=e,q()},ee=()=>{N.value=!0;const e=new Date,a=new Date(e.getTime()+6048e5),t=e.getHours().toString().padStart(2,"0"),l=e.getMinutes().toString().padStart(2,"0");Object.assign(O,{_id:"",title:"",subtitle:"",avatar:"",bgImage:"",startTime:`${t}:${l}`,endTime:`${t}:${l}`,startDate:oe(e),endDate:oe(a),type:"upcoming",isHot:!1,price:888,originalPrice:888}),B.value="",z.value=!0},ae=()=>{z.value=!1,B.value=""},te=async()=>{if(O.title)try{const e=a("token");if(!e)return void t({title:"è¯·å…ˆç™»å½•",icon:"none"});if(N.value){const e=await(async e=>{try{const t=a("token");if(!t)return!1;const{result:l}=await v.callFunction({name:"chatRoom",data:{action:"checkRoomNameExists",title:e,token:t,currentId:N.value?"":O._id}});return l&&0===l.code&&l.exists}catch(t){return console.error("æ£€æŸ¥èŠå¤©å®¤åç§°å¤±è´¥:",t),!1}})(O.title);if(e)return B.value="èŠå¤©å®¤åç§°å·²å­˜åœ¨",void t({title:"èŠå¤©å®¤åç§°å·²å­˜åœ¨",icon:"none"})}O.type="upcoming";const l=new Date,s=new Date(l.getTime()+6048e5),o=l.getHours().toString().padStart(2,"0"),n=l.getMinutes().toString().padStart(2,"0");O.startTime=`${o}:${n}`,O.endTime=`${o}:${n}`,O.startDate=oe(l),O.endDate=oe(s),O.subscribers=0,O.purchases_count=0,O.originalPrice=O.price;const i=`${O.startDate}T${O.startTime}:00.000Z`,c=`${O.endDate}T${O.endTime}:00.000Z`,u=i,d=c,r={...O,start_time:O.startTime,end_time:O.endTime,startTime:O.startTime,endTime:O.endTime,startDate:u,endDate:d},m=N.value?"adminCreateChatRoom":"adminUpdateChatRoom",{result:f}=await v.callFunction({name:"chatRoom",data:{action:m,room:r,token:e}});f&&0===f.code?(t({title:N.value?"åˆ›å»ºæˆåŠŸ":"æ›´æ–°æˆåŠŸ",icon:"success"}),ae(),q()):(t({title:(null==f?void 0:f.message)||(null==f?void 0:f.msg)||(N.value?"åˆ›å»ºå¤±è´¥":"æ›´æ–°å¤±è´¥"),icon:"none"}),401!==(null==f?void 0:f.code)&&403!==(null==f?void 0:f.code)||setTimeout((()=>{ae()}),1500))}catch(e){console.error(N.value?"åˆ›å»ºèŠå¤©å®¤å¤±è´¥:":"æ›´æ–°èŠå¤©å®¤å¤±è´¥:",e),t({title:N.value?"åˆ›å»ºå¤±è´¥":"æ›´æ–°å¤±è´¥",icon:"none"})}else t({title:"è¯·è¾“å…¥èŠå¤©å®¤åç§°",icon:"none"})},le=e=>{O.isHot=e.detail.value},se=e=>{switch(e){case"active":return"å·²å¼€å§‹";case"upcoming":return"æœªå¼€å§‹";case"ended":return"å·²ç»“æŸ";default:return"æœªçŸ¥"}};function oe(e){return`${e.getFullYear()}-${String(e.getMonth()+1).padStart(2,"0")}-${String(e.getDate()).padStart(2,"0")}`}const ne=e=>{if(!e)return"æœªçŸ¥";const a=new Date(e);return`${a.getFullYear()}-${String(a.getMonth()+1).padStart(2,"0")}-${String(a.getDate()).padStart(2,"0")}`},ie=()=>{l()},ce=()=>{G.value=!1,J.value=null},ue=async()=>{var e;if(J.value)try{const l=a("token");if(!l)return void t({title:"è¯·å…ˆç™»å½•",icon:"none"});r({title:"åˆ é™¤ä¸­..."});const{result:s}=await v.callFunction({name:"chatRoom",data:{action:"adminDeleteChatRoom",roomId:J.value._id,token:l}});m(),s&&0===s.code?(console.log("åˆ é™¤èŠå¤©å®¤æˆåŠŸ:",null==(e=J.value)?void 0:e.title),t({title:"åˆ é™¤æˆåŠŸ",icon:"success"}),ce(),console.log("å¼€å§‹é‡æ–°åŠ è½½èŠå¤©å®¤åˆ—è¡¨"),P.value=1,await q()):(t({title:(null==s?void 0:s.message)||"åˆ é™¤å¤±è´¥",icon:"none"}),401!==(null==s?void 0:s.code)&&403!==(null==s?void 0:s.code)||setTimeout((()=>{ce()}),1500))}catch(l){console.error("åˆ é™¤èŠå¤©å®¤å¤±è´¥:",l),m(),t({title:"åˆ é™¤å¤±è´¥",icon:"none"})}},de=async()=>{try{const e=a("token");if(!e)return void t({title:"è¯·å…ˆç™»å½•",icon:"none"});f({title:"ç¡®è®¤æ¸…ç†",content:"ç¡®å®šè¦æ¸…ç†æ•°æ®åº“ä¸­çš„æ— æ•ˆæ•°æ®å—ï¼Ÿè¿™å°†åˆ é™¤æ‰€æœ‰ç¼ºå°‘å¿…è¦å­—æ®µçš„èŠå¤©å®¤è®°å½•ã€‚",success:async a=>{if(a.confirm){r({title:"æ¸…ç†ä¸­..."});const{result:a}=await v.callFunction({name:"chatRoom",data:{action:"adminCleanupInvalidData",token:e}});if(m(),a&&0===a.code){const e=a.data;f({title:"æ¸…ç†å®Œæˆ",content:`æ€»èŠå¤©å®¤: ${e.totalRooms}\næœ‰æ•ˆèŠå¤©å®¤: ${e.validRooms}\nåˆ é™¤èŠå¤©å®¤: ${e.deletedRooms}\nåˆ é™¤è®¢é˜…: ${e.deletedSubscriptions}`,showCancel:!1}),await q()}else t({title:(null==a?void 0:a.message)||"æ¸…ç†å¤±è´¥",icon:"none"})}}})}catch(e){console.error("æ¸…ç†æ— æ•ˆæ•°æ®å¤±è´¥:",e),m(),t({title:"æ¸…ç†å¤±è´¥",icon:"none"})}};return(e,a)=>{const l=s,f=o,p=n,_=i,g=c,h=u;return C(),y(l,{class:"chat-room-maintenance",style:w({paddingTop:M.value+"px"})},{default:k((()=>[T(l,{class:"nav-bar",style:w(K.value)},{default:k((()=>[T(l,{class:"nav-left",onClick:ie,style:w(W.value)},{default:k((()=>[T(l,{class:"back-arrow"})])),_:1},8,["style"]),T(l,{class:"nav-center"},{default:k((()=>[$("èŠå¤©å®¤ç»´æŠ¤")])),_:1}),T(l,{class:"nav-right"})])),_:1},8,["style"]),T(l,{class:"search-container"},{default:k((()=>[T(l,{class:"search-box"},{default:k((()=>[T(f,{class:"search-icon"},{default:k((()=>[$("ðŸ”")])),_:1}),T(p,{class:"search-input",placeholder:"æœç´¢èŠå¤©å®¤",modelValue:U.value,"onUpdate:modelValue":a[0]||(a[0]=e=>U.value=e),onInput:A},null,8,["modelValue"])])),_:1})])),_:1}),T(l,{class:"room-list"},{default:k((()=>[Z.value?(C(),y(l,{key:0,class:"loading"},{default:k((()=>[T(f,null,{default:k((()=>[$("åŠ è½½ä¸­...")])),_:1})])),_:1})):0===X.value.length?(C(),y(l,{key:1,class:"empty-state"},{default:k((()=>[T(f,null,{default:k((()=>[$("æš‚æ— èŠå¤©å®¤æ•°æ®")])),_:1})])),_:1})):(C(!0),S(x,{key:2},R(X.value,((e,a)=>(C(),y(l,{key:e._id,class:"room-item",onClick:a=>(e=>{N.value=!1,Object.assign(O,e),B.value="",z.value=!0})(e)},{default:k((()=>[T(l,{class:"room-avatar-container"},{default:k((()=>[e.avatar?(C(),y(_,{key:0,class:"room-avatar",src:e.avatar,mode:"aspectFill"},null,8,["src"])):(C(),y(l,{key:1,class:"room-avatar room-avatar-placeholder"},{default:k((()=>[T(f,null,{default:k((()=>[$(V(e.title?e.title.substring(0,1):"?"),1)])),_:2},1024)])),_:2},1024))])),_:2},1024),T(l,{class:"room-content"},{default:k((()=>[T(l,{class:"room-header"},{default:k((()=>[T(f,{class:"room-name ellipsis"},{default:k((()=>[$(V(e.title),1)])),_:2},1024),T(f,{class:F(["room-status",{"status-active":"active"===e.type,"status-upcoming":"upcoming"===e.type,"status-ended":"ended"===e.type}])},{default:k((()=>[$(V(se(e.type)),1)])),_:2},1032,["class"])])),_:2},1024),T(l,{class:"room-subtitle ellipsis"},{default:k((()=>[$(V(e.subtitle||"æ— å‰¯æ ‡é¢˜"),1)])),_:2},1024),T(l,{class:"room-info-row"},{default:k((()=>[T(f,{class:"room-price"},{default:k((()=>[$("Â¥"+V(e.price||0),1)])),_:2},1024),T(f,{class:"room-time"},{default:k((()=>[$(V(ne(e.startDate))+" "+V(e.startTime)+" - "+V(ne(e.endDate))+" "+V(e.endTime),1)])),_:2},1024)])),_:2},1024)])),_:2},1024),T(l,{class:"room-actions"},{default:k((()=>[T(l,{class:"delete-button",onClick:I((a=>(e=>{J.value=e,G.value=!0})(e)),["stop"])},{default:k((()=>[T(f,{class:"delete-icon"},{default:k((()=>[$("ðŸ—‘ï¸")])),_:1}),T(f,{class:"delete-text"},{default:k((()=>[$("åˆ é™¤")])),_:1})])),_:2},1032,["onClick"])])),_:2},1024)])),_:2},1032,["onClick"])))),128))])),_:1}),T(l,{class:"pagination"},{default:k((()=>[T(g,{class:"page-button",disabled:P.value<=1,onClick:a[1]||(a[1]=e=>Q(P.value-1))},{default:k((()=>[$("ä¸Šä¸€é¡µ")])),_:1},8,["disabled"]),T(f,{class:"page-info"},{default:k((()=>[$(V(P.value)+" / "+V(L.value||1),1)])),_:1}),T(g,{class:"page-button",disabled:P.value>=L.value,onClick:a[2]||(a[2]=e=>Q(P.value+1))},{default:k((()=>[$("ä¸‹ä¸€é¡µ")])),_:1},8,["disabled"])])),_:1}),T(l,{class:"add-button-container"},{default:k((()=>[T(g,{class:"add-button-fixed",onClick:ee},{default:k((()=>[$("+")])),_:1}),Y.value.length>0?(C(),y(g,{key:0,class:"cleanup-button-fixed",onClick:de},{default:k((()=>[$("æ¸…ç†")])),_:1})):D("",!0)])),_:1}),z.value?(C(),y(l,{key:0,class:"modal"},{default:k((()=>[T(l,{class:"modal-content"},{default:k((()=>[T(l,{class:"modal-header"},{default:k((()=>[T(f,{class:"modal-title"},{default:k((()=>[$(V(N.value?"æ–°å¢žèŠå¤©å®¤":"ç¼–è¾‘èŠå¤©å®¤"),1)])),_:1}),T(f,{class:"modal-close",onClick:ae},{default:k((()=>[$("Ã—")])),_:1})])),_:1}),T(l,{class:"modal-body"},{default:k((()=>[T(l,{class:"form-section"},{default:k((()=>[T(l,{class:"form-item"},{default:k((()=>[T(f,{class:"form-label"},{default:k((()=>[$("èŠå¤©å®¤åç§°")])),_:1}),T(l,{class:"input-container"},{default:k((()=>[T(p,{class:"form-input",modelValue:O.title,"onUpdate:modelValue":a[3]||(a[3]=e=>O.title=e),placeholder:"è¯·è¾“å…¥èŠå¤©å®¤åç§°"},null,8,["modelValue"])])),_:1}),B.value?(C(),y(f,{key:0,class:"error-text"},{default:k((()=>[$(V(B.value),1)])),_:1})):D("",!0)])),_:1}),T(l,{class:"form-item"},{default:k((()=>[T(f,{class:"form-label"},{default:k((()=>[$("å‰¯æ ‡é¢˜")])),_:1}),T(l,{class:"input-container"},{default:k((()=>[T(p,{class:"form-input",modelValue:O.subtitle,"onUpdate:modelValue":a[4]||(a[4]=e=>O.subtitle=e),placeholder:"è¯·è¾“å…¥å‰¯æ ‡é¢˜"},null,8,["modelValue"])])),_:1})])),_:1}),T(l,{class:"form-item"},{default:k((()=>[T(f,{class:"form-label"},{default:k((()=>[$("å¤´åƒå›¾ç‰‡")])),_:1}),T(l,{class:"image-upload"},{default:k((()=>[O.avatar?(C(),y(_,{key:0,class:"preview-image",src:O.avatar,mode:"aspectFill"},null,8,["src"])):(C(),y(l,{key:1,class:"preview-image empty-image"},{default:k((()=>[T(f,{class:"empty-image-text"},{default:k((()=>[$("æš‚æ— å›¾ç‰‡")])),_:1})])),_:1})),T(g,{class:"upload-button",onClick:a[5]||(a[5]=e=>(E.value=!0,void d({count:1,success:e=>{const a=e.tempFilePaths[0];r({title:"ä¸Šä¼ ä¸­..."}),v.uploadFile({filePath:a,cloudPath:`chat-room-images/${Date.now()}-${Math.random().toString(36).slice(2)}.${a.split(".").pop()}`,success:e=>{console.log("ä¸Šä¼ æˆåŠŸ",e),O.avatar=e.fileID,O.bgImage=e.fileID,m(),t({title:"ä¸Šä¼ æˆåŠŸ",icon:"success"})},fail:e=>{console.error("ä¸Šä¼ å¤±è´¥",e),m(),t({title:"ä¸Šä¼ å¤±è´¥",icon:"none"})},complete:()=>{E.value=!1}})}})))},{default:k((()=>[$(V(E.value?"ä¸Šä¼ ä¸­...":O.avatar?"æ›´æ¢å›¾ç‰‡":"ä¸Šä¼ å›¾ç‰‡"),1)])),_:1})])),_:1})])),_:1}),T(l,{class:"form-item"},{default:k((()=>[T(f,{class:"form-label"},{default:k((()=>[$("èŠå¤©å®¤ä»·æ ¼")])),_:1}),T(l,{class:"input-container"},{default:k((()=>[T(f,{class:"price-symbol"},{default:k((()=>[$("Â¥")])),_:1}),T(p,{class:"form-input price-input",modelValue:O.price,"onUpdate:modelValue":a[6]||(a[6]=e=>O.price=e),placeholder:"è¯·è¾“å…¥ä»·æ ¼",type:"number"},null,8,["modelValue"])])),_:1})])),_:1}),T(l,{class:"form-item switch-item"},{default:k((()=>[T(f,{class:"form-label"},{default:k((()=>[$("æ˜¯å¦çƒ­é—¨")])),_:1}),T(h,{checked:O.isHot,onChange:le,color:"#07C160"},null,8,["checked"])])),_:1})])),_:1})])),_:1}),T(l,{class:"modal-footer"},{default:k((()=>[T(g,{class:"cancel-button",onClick:ae},{default:k((()=>[$("å…³é—­")])),_:1}),T(g,{class:"save-button",onClick:te},{default:k((()=>[$("ä¿å­˜")])),_:1})])),_:1})])),_:1})])),_:1})):D("",!0),G.value?(C(),y(l,{key:1,class:"modal"},{default:k((()=>[T(l,{class:"modal-content delete-modal"},{default:k((()=>[T(l,{class:"modal-header delete-header"},{default:k((()=>[T(l,{class:"delete-title-container"},{default:k((()=>[T(f,{class:"delete-title-icon"},{default:k((()=>[$("ðŸ—‘ï¸")])),_:1}),T(f,{class:"modal-title delete-title"},{default:k((()=>[$("ç¡®è®¤åˆ é™¤")])),_:1})])),_:1})])),_:1}),T(l,{class:"modal-body"},{default:k((()=>[T(l,{class:"delete-message"},{default:k((()=>[T(f,null,{default:k((()=>{var e;return[$('ç¡®å®šè¦åˆ é™¤èŠå¤©å®¤ "'+V(null==(e=J.value)?void 0:e.title)+'" å—ï¼Ÿ',1)]})),_:1}),T(f,{class:"delete-warning"},{default:k((()=>[$("åˆ é™¤åŽå°†æ— æ³•æ¢å¤ï¼Œä½†ç”¨æˆ·çš„è´­ä¹°è®°å½•ä¼šä¿ç•™ã€‚")])),_:1})])),_:1})])),_:1}),T(l,{class:"modal-footer"},{default:k((()=>[T(g,{class:"cancel-button",onClick:ce},{default:k((()=>[$("å–æ¶ˆ")])),_:1}),T(g,{class:"delete-confirm-button",onClick:ue},{default:k((()=>[$("ç¡®è®¤åˆ é™¤")])),_:1})])),_:1})])),_:1})])),_:1})):D("",!0)])),_:1},8,["style"])}}}),[["__scopeId","data-v-0f75afd7"]]);export{H as default};
