import{t as e,k as t,I as s,K as a,L as l,R as o,E as c,c as n,d as i,j as r,b as u,h as d,X as f,r as _,B as v}from"./uni.CnKTWU0K.js";import{Z as g}from"./index-C3v_m0JD.js";import{d as m,b as p,R as h,a6 as b,ad as k,a7 as w,M as y,aP as C,_ as U,aY as x,aW as L,aX as j}from"./vendor.CqD9dFNX.js";import{r as F}from"./loginHelper.B8-BL7my.js";import{_ as P}from"./_plugin-vue_export-helper.BCo6x5W8.js";const T=P(m({__name:"setting",setup(m){const P=p(0),T=p("1.0.0"),I=p(100),R=p(!1),B=p(null),M=p("检查中..."),$=p("checking"),A=p("0.00MB"),E=p({mobile:""});h((()=>{const s=e();P.value=s.statusBarHeight||0;try{T.value="1.0.0",I.value=1,setTimeout((()=>{J()}),1e3)}catch(l){console.error("获取版本信息失败:",l),T.value="1.0.0",I.value=1,setTimeout((()=>{J()}),1e3)}const a=t("userInfo");a&&(E.value=JSON.parse(a))}));const H=()=>{o()},K=()=>{c({url:"/pages/profile/change-password"})},X=()=>{n({title:"功能开发中",icon:"none"})},z=()=>{i({title:"提示",content:"确定要清除缓存吗？",success:e=>{e.confirm&&(r(),n({title:"清除成功",icon:"success"}))}})},J=async()=>{try{console.log("检查更新，当前版本号:",I.value);const e=await g.callFunction({name:"version",data:{action:"checkUpdate",data:{current_version_code:I.value}}});if(console.log("版本检查结果:",e.result),0===e.result.code){const{hasUpdate:t,version:s,isForceUpdate:a}=e.result.data;t?(R.value=!0,B.value=s,M.value="有新版本",$.value="has-update",console.log("发现新版本:",s)):(R.value=!1,B.value=null,M.value="已是最新版本",$.value="up-to-date",console.log("已是最新版本"))}else M.value="检查失败",$.value="error",console.error("版本检查失败:",e.result.msg)}catch(e){console.error("自动检查更新失败:",e),M.value="检查失败",$.value="error"}},N=()=>{R.value&&B.value?S(B.value,B.value.is_force_update):"error"===$.value?O():i({title:"版本检查",content:"当前显示已是最新版本，是否重新检查更新？",success:e=>{e.confirm&&(M.value="检查中...",$.value="checking",J())}})},O=async()=>{u({title:"检查中..."});try{const e=await g.callFunction({name:"version",data:{action:"checkUpdate",data:{current_version_code:I.value}}});if(d(),0===e.result.code){const{hasUpdate:t,version:s,isForceUpdate:a}=e.result.data;t?S(s,a):n({title:"当前已是最新版本",icon:"none"})}else n({title:e.result.msg||"检查更新失败",icon:"none"})}catch(e){d(),console.error("检查更新失败:",e),n({title:"检查更新失败",icon:"none"})}},S=(e,t)=>{const s=`发现新版本 ${e.version_name}\n\n更新内容：\n${e.update_content||"优化体验，修复问题"}\n\n是否立即更新？`;i({title:t?"强制更新":"版本更新",content:s,showCancel:!t,confirmText:"立即更新",cancelText:"稍后更新",success:s=>{s.confirm?W(e):t&&S(e,t)}})},W=async e=>{u({title:"下载中..."});try{const t=await Y(e.apk_url);f({url:t,success:e=>{d(),200===e.statusCode?n({title:"请在APP中使用此功能",icon:"none"}):n({title:"下载失败",icon:"none"})},fail:e=>{d(),console.error("下载失败:",e),n({title:"下载失败",icon:"none"})}}).onProgressUpdate((e=>{const t=Math.round(e.progress);u({title:`下载中 ${t}%`})}))}catch(t){d(),console.error("下载APK失败:",t),n({title:"下载失败",icon:"none"})}},Y=async e=>{try{const t=await g.getTempFileURL({fileList:[e]});if(t.fileList&&t.fileList.length>0)return t.fileList[0].tempFileURL;throw new Error("获取下载链接失败")}catch(t){throw console.error("获取下载链接失败:",t),t}},Z=()=>{n({title:"功能开发中",icon:"none"})},q=()=>{n({title:"功能开发中",icon:"none"})},D=()=>{i({title:"提示",content:"确定要退出登录吗？",success:e=>{e.confirm&&(F(),_("userInfo"),v({url:"/pages/profile/index"}))}})};return(e,t)=>{const o=s,c=a,n=l;return w(),b(o,{class:"setting-container"},{default:k((()=>[y(o,{class:"modern-background"}),y(o,{class:"content-layer"},{default:k((()=>[y(o,{class:"status-bar",style:C({height:P.value+"px"})},null,8,["style"]),y(o,{class:"nav-bar"},{default:k((()=>[y(o,{class:"back-btn",onClick:H},{default:k((()=>[y(o,{class:"icon-back"})])),_:1}),y(c,{class:"page-title"},{default:k((()=>[U("设置")])),_:1})])),_:1}),y(o,{class:"settings-list"},{default:k((()=>[y(o,{class:"settings-group"},{default:k((()=>[y(o,{class:"group-title"},{default:k((()=>[U("账号安全")])),_:1}),y(o,{class:"setting-item",onClick:K},{default:k((()=>[y(c,{class:"item-label"},{default:k((()=>[U("修改密码")])),_:1}),y(o,{class:"item-right"},{default:k((()=>[y(c,{class:"iconfont icon-arrow"})])),_:1})])),_:1}),y(o,{class:"setting-item",onClick:X},{default:k((()=>[y(c,{class:"item-label"},{default:k((()=>[U("绑定手机")])),_:1}),y(o,{class:"item-right"},{default:k((()=>[y(c,{class:"phone-number"},{default:k((()=>[U(x(E.value.mobile||"未绑定"),1)])),_:1}),y(c,{class:"iconfont icon-arrow"})])),_:1})])),_:1})])),_:1}),y(o,{class:"settings-group"},{default:k((()=>[y(o,{class:"group-title"},{default:k((()=>[U("通用设置")])),_:1}),y(o,{class:"setting-item",onClick:z},{default:k((()=>[y(c,{class:"item-label"},{default:k((()=>[U("清除缓存")])),_:1}),y(o,{class:"item-right"},{default:k((()=>[y(c,{class:"cache-size"},{default:k((()=>[U(x(A.value),1)])),_:1}),y(c,{class:"iconfont icon-arrow"})])),_:1})])),_:1}),y(o,{class:"setting-item",onClick:N},{default:k((()=>[y(c,{class:"item-label"},{default:k((()=>[U("版本更新")])),_:1}),y(o,{class:"item-right"},{default:k((()=>[y(o,{class:"version-info"},{default:k((()=>[y(c,{class:"version"},{default:k((()=>[U("当前版本 "+x(T.value),1)])),_:1}),y(c,{class:j(["update-status",$.value])},{default:k((()=>[U(x(M.value),1)])),_:1},8,["class"])])),_:1}),R.value?(w(),b(c,{key:0,class:"iconfont icon-arrow"})):L("",!0)])),_:1})])),_:1})])),_:1}),y(o,{class:"settings-group"},{default:k((()=>[y(o,{class:"group-title"},{default:k((()=>[U("关于我们")])),_:1}),y(o,{class:"setting-item",onClick:Z},{default:k((()=>[y(c,{class:"item-label"},{default:k((()=>[U("隐私政策")])),_:1}),y(o,{class:"item-right"},{default:k((()=>[y(c,{class:"iconfont icon-arrow"})])),_:1})])),_:1}),y(o,{class:"setting-item",onClick:q},{default:k((()=>[y(c,{class:"item-label"},{default:k((()=>[U("用户协议")])),_:1}),y(o,{class:"item-right"},{default:k((()=>[y(c,{class:"iconfont icon-arrow"})])),_:1})])),_:1})])),_:1})])),_:1}),y(o,{class:"logout-section"},{default:k((()=>[y(n,{class:"logout-btn",onClick:D},{default:k((()=>[U("退出登录")])),_:1})])),_:1})])),_:1})])),_:1})}}}),[["__scopeId","data-v-c334ac3e"]]);export{T as default};
