import{t as e,c as a,I as l,K as t,L as s,S as o,M as n,P as u,k as i,W as c,d,R as r}from"./uni.CnKTWU0K.js";import{Z as v}from"./index-C3v_m0JD.js";import{d as m,b as _,R as f,a6 as g,ad as h,a7 as y,M as p,aW as k,aP as b,_ as S,aN as C,az as w,ak as x,aX as I,aY as M}from"./vendor.CqD9dFNX.js";import{g as F}from"./loginHelper.B8-BL7my.js";import{_ as R}from"./_plugin-vue_export-helper.BCo6x5W8.js";const V=R(m({__name:"chat-messages",setup(m){const R=_(0),V=_(44),$=_(0),j=_(!1),H=_(!0),D=_([]),L=_([]),N=_(null),z=_(""),P=_(""),U=_([]),A=_(null),T=_(!1),W=_(1),Y=_(10),B=_(1),J=()=>{if(!z.value)return void(L.value=[...D.value]);const e=z.value.toLowerCase();L.value=D.value.filter((a=>a.title&&a.title.toLowerCase().includes(e)||a.room_id&&a.room_id.toLowerCase().includes(e)))},K=async()=>{if(N.value)if(P.value.trim())try{T.value=!0;const e=F(),l=i("userInfo");let t="";if(l){const e=JSON.parse(l);t=e.user_id||e.userId||e._id||""}const{result:s}=await v.callFunction({name:"chatRoom",data:{action:"saveMessage",data:{messageId:A.value?A.value._id:"",roomId:N.value.room_id,roomTitle:N.value.title,content:P.value,userId:t,isAdminUpdate:!0},token:e}});s&&0===s.code?(a({title:"保存成功",icon:"success"}),X(),O()):a({title:(null==s?void 0:s.message)||"保存失败",icon:"none"})}catch(e){console.error("保存聊天记录失败:",e),a({title:"保存失败",icon:"none"})}finally{T.value=!1}else a({title:"请输入聊天记录内容",icon:"none"});else a({title:"请选择聊天室",icon:"none"})},O=()=>{N.value=null,P.value="",A.value=null,z.value="",L.value=[...D.value]},X=async()=>{try{const e=F(),{result:a}=await v.callFunction({name:"chatRoom",data:{action:"getMessageHistory",data:{page:W.value,pageSize:Y.value},token:e}});a&&0===a.code&&a.data?(U.value=a.data.list||[],B.value=a.data.totalPages||1):(U.value=[],B.value=1)}catch(e){console.error("获取聊天记录历史失败:",e),a({title:"获取历史记录失败",icon:"none"}),U.value=[],B.value=1}},Z=()=>{W.value>1&&(W.value--,X())},q=()=>{W.value<B.value&&(W.value++,X())},E=e=>{if(!e)return"--";const a=new Date(e);if(isNaN(a.getTime()))return"--";return`${a.getFullYear()}-${String(a.getMonth()+1).padStart(2,"0")}-${String(a.getDate()).padStart(2,"0")} ${String(a.getHours()).padStart(2,"0")}:${String(a.getMinutes()).padStart(2,"0")}:${String(a.getSeconds()).padStart(2,"0")}`},G=()=>{r()};return f((()=>{(()=>{const a=e();R.value=a.statusBarHeight||0;const l=a.windowHeight;$.value=l-R.value-V.value})(),(async()=>{try{H.value=!0;const e=F();if(!e)return j.value=!1,H.value=!1,void a({title:"请先登录",icon:"none"});const{result:l}=await v.callFunction({name:"user",data:{action:"checkAdminStatus",token:e}});l&&0===l.code?j.value=!0===l.is_admin:(j.value=!1,a({title:"权限检查失败",icon:"none"}))}catch(e){console.error("检查管理员权限失败:",e),j.value=!1}finally{H.value=!1}})(),(async()=>{try{const e=F(),{result:a}=await v.callFunction({name:"chatRoom",data:{action:"list",data:{page:1,pageSize:100},token:e}});a&&0===a.code&&a.data&&a.data.list&&(D.value=a.data.list,L.value=[...D.value])}catch(e){console.error("获取聊天室列表失败:",e),a({title:"获取聊天室列表失败",icon:"none"})}})(),X()})),(e,i)=>{const r=l,m=t,_=s,f=n,Y=u,Q=o;return y(),g(r,{class:"admin-container"},{default:h((()=>[p(r,{class:"page-background"}),p(r,{class:"content-layer"},{default:h((()=>[p(r,{class:"status-bar",style:b({height:R.value+"px"})},null,8,["style"]),p(r,{class:"nav-bar",style:b({height:V.value+"px"})},{default:h((()=>[p(r,{class:"nav-left",onClick:G},{default:h((()=>[p(r,{class:"back-icon"},{default:h((()=>[p(m,{class:"back-arrow"})])),_:1}),p(m,{class:"back-text"},{default:h((()=>[S("返回")])),_:1})])),_:1}),p(r,{class:"nav-center"},{default:h((()=>[p(m,{class:"title"},{default:h((()=>[S("聊天记录管理")])),_:1})])),_:1}),p(r,{class:"nav-right"})])),_:1},8,["style"]),H.value?(y(),g(r,{key:0,class:"auth-checking"},{default:h((()=>[p(m,null,{default:h((()=>[S("权限检查中...")])),_:1})])),_:1})):k("",!0),j.value||H.value?k("",!0):(y(),g(r,{key:1,class:"no-auth"},{default:h((()=>[p(m,{class:"warning-text"},{default:h((()=>[S("您没有权限访问此页面")])),_:1}),p(_,{class:"back-btn",onClick:G},{default:h((()=>[S("返回")])),_:1})])),_:1})),j.value?(y(),g(Q,{key:2,"scroll-y":"true",class:"admin-content",style:b({height:$.value+"px"})},{default:h((()=>[p(r,{class:"section room-select"},{default:h((()=>[p(m,{class:"section-title"},{default:h((()=>[S("选择聊天室")])),_:1}),p(r,{class:"room-search"},{default:h((()=>[p(f,{class:"search-input",placeholder:"搜索聊天室",modelValue:z.value,"onUpdate:modelValue":i[0]||(i[0]=e=>z.value=e),onInput:J},null,8,["modelValue"])])),_:1}),p(r,{class:"room-list"},{default:h((()=>[(y(!0),C(w,null,x(L.value,(e=>(y(),g(r,{key:e.room_id,class:I(["room-item",N.value&&N.value.room_id===e.room_id?"active":""]),onClick:a=>(e=>{N.value=e,A.value=null,P.value=""})(e)},{default:h((()=>[p(m,{class:"room-title"},{default:h((()=>[S(M(e.title),1)])),_:2},1024),p(m,{class:"room-id"},{default:h((()=>[S("ID: "+M(e.room_id),1)])),_:2},1024)])),_:2},1032,["class","onClick"])))),128))])),_:1})])),_:1}),N.value?(y(),g(r,{key:0,class:"section message-edit"},{default:h((()=>[p(r,{class:"selected-room-info"},{default:h((()=>[p(m,{class:"selected-room-title"},{default:h((()=>[S("当前选择: "+M(N.value.title),1)])),_:1}),p(m,{class:"selected-room-id"},{default:h((()=>[S("ID: "+M(N.value.room_id),1)])),_:1})])),_:1}),p(r,{class:"message-form"},{default:h((()=>[p(m,{class:"form-label"},{default:h((()=>[S("聊天记录内容:")])),_:1}),p(Y,{class:"message-textarea",modelValue:P.value,"onUpdate:modelValue":i[1]||(i[1]=e=>P.value=e),placeholder:"请输入聊天记录内容",maxlength:"-1","auto-height":!0},null,8,["modelValue"]),p(r,{class:"form-actions"},{default:h((()=>[p(_,{class:"reset-btn",onClick:O,disabled:T.value},{default:h((()=>[S(" 重置 ")])),_:1},8,["disabled"]),p(_,{class:"submit-btn",onClick:K,disabled:T.value},{default:h((()=>[S(M(T.value?"保存中...":"保存聊天记录"),1)])),_:1},8,["disabled"])])),_:1})])),_:1})])),_:1})):k("",!0),p(r,{class:"section history-section"},{default:h((()=>[p(m,{class:"section-title"},{default:h((()=>[S("历史记录")])),_:1}),p(r,{class:"history-list"},{default:h((()=>[(y(!0),C(w,null,x(U.value,((e,l)=>(y(),g(r,{class:"history-item",key:l},{default:h((()=>[p(r,{class:"history-header"},{default:h((()=>[p(m,{class:"history-room-title"},{default:h((()=>[S(M(e.room_title),1)])),_:2},1024),p(m,{class:"history-time"},{default:h((()=>[S(M(E(e.update_time||e.create_time)),1)])),_:2},1024)])),_:2},1024),p(r,{class:"history-content"},{default:h((()=>[p(m,{class:"history-text"},{default:h((()=>[S(M(e.content.length>100?e.content.substring(0,100)+"...":e.content),1)])),_:2},1024)])),_:2},1024),p(r,{class:"history-actions"},{default:h((()=>[p(_,{class:"edit-btn",onClick:a=>(e=>{const a=D.value.find((a=>a.room_id===e.room_id));N.value=a||{room_id:e.room_id,title:e.room_title||"未知聊天室"},P.value=e.content,A.value=e,c({selector:".message-edit",duration:300})})(e)},{default:h((()=>[S("编辑")])),_:2},1032,["onClick"]),p(_,{class:"delete-btn",onClick:l=>(async e=>{d({title:"确认删除",content:"确定要删除这条聊天记录吗？",success:async l=>{if(l.confirm)try{const l=F(),{result:t}=await v.callFunction({name:"chatRoom",data:{action:"deleteMessage",data:{messageId:e._id},token:l}});t&&0===t.code?(a({title:"删除成功",icon:"success"}),X(),A.value&&A.value._id===e._id&&(P.value="",A.value=null)):a({title:(null==t?void 0:t.message)||"删除失败",icon:"none"})}catch(t){console.error("删除聊天记录失败:",t),a({title:"删除失败",icon:"none"})}}})})(e)},{default:h((()=>[S("删除")])),_:2},1032,["onClick"])])),_:2},1024)])),_:2},1024)))),128)),0===U.value.length?(y(),g(r,{key:0,class:"no-history"},{default:h((()=>[p(m,null,{default:h((()=>[S("暂无历史记录")])),_:1})])),_:1})):k("",!0)])),_:1}),B.value>1?(y(),g(r,{key:0,class:"pagination"},{default:h((()=>[p(_,{class:"page-btn",onClick:Z,disabled:1===W.value},{default:h((()=>[S("上一页")])),_:1},8,["disabled"]),p(m,{class:"page-info"},{default:h((()=>[S(M(W.value)+" / "+M(B.value),1)])),_:1}),p(_,{class:"page-btn",onClick:q,disabled:W.value===B.value},{default:h((()=>[S("下一页")])),_:1},8,["disabled"])])),_:1})):k("",!0)])),_:1})])),_:1},8,["style"])):k("",!0)])),_:1})])),_:1})}}}),[["__scopeId","data-v-b2e58256"]]);export{V as default};
