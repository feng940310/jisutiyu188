import{t as e,c as a,I as t,K as s,M as l,L as n,P as c,R as o,d as i,b as u,h as r}from"./uni.CnKTWU0K.js";import{Z as d}from"./index-C3v_m0JD.js";import{d as _,b as f,R as v,a6 as m,ad as p,a7 as k,M as g,aW as y,aP as h,_ as b,aY as x,aX as V,aN as P,az as w,ak as S}from"./vendor.CqD9dFNX.js";import{g as $}from"./loginHelper.B8-BL7my.js";import{_ as C}from"./_plugin-vue_export-helper.BCo6x5W8.js";const F=C(_({__name:"version-management",setup(_){const C=f(0),F=f(!1),K=f(!1),A=f([]),D=f({}),I=f({version_name:"",version_code:"",apk_url:"",apk_size:0,update_content:"",is_force_update:!1}),j=f("");v((()=>{const a=e();C.value=a.statusBarHeight||0,M()}));const z=()=>{o()},M=async()=>{F.value=!0;try{const e=$(),t=await d.callFunction({name:"version",data:{action:"getVersionList",token:e}});0===t.result.code?(A.value=t.result.data.list,D.value=t.result.data.current):a({title:t.result.msg,icon:"none"})}catch(e){console.error("加载版本列表失败:",e),a({title:"加载失败",icon:"none"})}finally{F.value=!1}},T=()=>{I.value={version_name:"",version_code:"",apk_url:"",apk_size:0,update_content:"",is_force_update:!1},j.value=""},L=()=>{"undefined"!=typeof plus?plus.io.resolveLocalFileSystemURL("_doc/",(e=>{e.createReader().readEntries((e=>{i({title:"上传APK文件",content:"请将APK文件上传到云存储并输入文件ID",editable:!0,placeholderText:"输入云存储文件ID",success:e=>{e.confirm&&e.content&&(I.value.apk_url=e.content,j.value="APK文件",a({title:"文件设置成功",icon:"success"}))}})}))})):uni.chooseMessageFile({count:1,type:"file",success:async e=>{const t=e.tempFiles[0];j.value=t.name,u({title:"上传中..."});try{const e=await d.uploadFile({filePath:t.path,cloudPath:`apk/${Date.now()}_${t.name}`,fileType:"file"});I.value.apk_url=e.fileID,I.value.apk_size=t.size,r(),a({title:"上传成功",icon:"success"})}catch(s){r(),console.error("文件上传失败:",s),a({title:"上传失败",icon:"none"})}},fail:e=>{console.error("选择文件失败:",e),i({title:"上传APK文件",content:"请将APK文件上传到云存储并输入文件ID",editable:!0,placeholderText:"输入云存储文件ID",success:e=>{e.confirm&&e.content&&(I.value.apk_url=e.content,j.value="APK文件",a({title:"文件设置成功",icon:"success"}))}})}})},R=()=>{I.value.is_force_update=!I.value.is_force_update},U=async()=>{if(I.value.version_name&&I.value.version_code&&I.value.apk_url){K.value=!0;try{const e=$(),t="addVersion",s={...I.value},l=await d.callFunction({name:"version",data:{action:t,token:e,data:s}});0===l.result.code?(a({title:l.result.msg,icon:"success"}),T(),M()):a({title:l.result.msg,icon:"none"})}catch(e){console.error("提交失败:",e),a({title:"提交失败",icon:"none"})}finally{K.value=!1}}else a({title:"请填写完整信息",icon:"none"})},H=e=>{if(!e)return"";const a=new Date(e);return`${a.getFullYear()}-${String(a.getMonth()+1).padStart(2,"0")}-${String(a.getDate()).padStart(2,"0")} ${String(a.getHours()).padStart(2,"0")}:${String(a.getMinutes()).padStart(2,"0")}`};return(e,o)=>{const u=t,r=s,_=l,f=n,v=c;return k(),m(u,{class:"version-management"},{default:p((()=>[g(u,{class:"page-background"}),g(u,{class:"navbar",style:h({paddingTop:C.value+"px"})},{default:p((()=>[g(u,{class:"nav-content"},{default:p((()=>[g(u,{class:"nav-left",onClick:z},{default:p((()=>[g(r,{class:"iconfont icon-arrow-left"})])),_:1}),g(u,{class:"nav-title"},{default:p((()=>[b("版本管理")])),_:1}),g(u,{class:"nav-right"})])),_:1})])),_:1},8,["style"]),g(u,{class:"content-wrapper",style:h({marginTop:C.value+44+"px"})},{default:p((()=>[g(u,{class:"content"},{default:p((()=>[g(u,{class:"publish-form"},{default:p((()=>[g(u,{class:"section-title"},{default:p((()=>[b("发布新版本")])),_:1}),g(u,{class:"form-card"},{default:p((()=>[g(u,{class:"form-item"},{default:p((()=>[g(r,{class:"label"},{default:p((()=>[b("版本名称")])),_:1}),g(_,{class:"input",modelValue:I.value.version_name,"onUpdate:modelValue":o[0]||(o[0]=e=>I.value.version_name=e),placeholder:"如：v1.0.1"},null,8,["modelValue"])])),_:1}),g(u,{class:"form-item"},{default:p((()=>[g(r,{class:"label"},{default:p((()=>[b("版本号")])),_:1}),g(_,{class:"input",modelValue:I.value.version_code,"onUpdate:modelValue":o[1]||(o[1]=e=>I.value.version_code=e),type:"number",placeholder:"如：101"},null,8,["modelValue"])])),_:1}),g(u,{class:"form-item"},{default:p((()=>[g(r,{class:"label"},{default:p((()=>[b("APK文件")])),_:1}),g(u,{class:"file-upload"},{default:p((()=>[g(f,{class:"upload-btn",onClick:L},{default:p((()=>[b(x(I.value.apk_url?"重新选择":"选择APK文件"),1)])),_:1}),I.value.apk_url?(k(),m(r,{key:0,class:"file-name"},{default:p((()=>[b(x(j.value),1)])),_:1})):y("",!0)])),_:1})])),_:1}),g(u,{class:"form-item"},{default:p((()=>[g(r,{class:"label"},{default:p((()=>[b("更新内容")])),_:1}),g(v,{class:"textarea",modelValue:I.value.update_content,"onUpdate:modelValue":o[2]||(o[2]=e=>I.value.update_content=e),placeholder:"描述此版本的更新内容...",maxlength:"500"},null,8,["modelValue"])])),_:1}),g(u,{class:"form-item"},{default:p((()=>[g(u,{class:"checkbox-item",onClick:R},{default:p((()=>[g(r,{class:V(["checkbox",I.value.is_force_update?"checked":""])},{default:p((()=>[b(x(I.value.is_force_update?"✓":""),1)])),_:1},8,["class"]),g(r,{class:"checkbox-label"},{default:p((()=>[b("强制更新")])),_:1})])),_:1})])),_:1}),g(u,{class:"form-actions"},{default:p((()=>[g(f,{class:"btn secondary",onClick:T},{default:p((()=>[b("重置")])),_:1}),g(f,{class:"btn primary",onClick:U,disabled:K.value},{default:p((()=>[b(x(K.value?"发布中...":"发布版本"),1)])),_:1},8,["disabled"])])),_:1})])),_:1})])),_:1}),D.value._id?(k(),m(u,{key:0,class:"current-version"},{default:p((()=>[g(u,{class:"section-title"},{default:p((()=>[b("当前激活版本")])),_:1}),g(u,{class:"version-card active"},{default:p((()=>[g(u,{class:"version-header"},{default:p((()=>[g(r,{class:"version-name"},{default:p((()=>[b(x(D.value.version_name),1)])),_:1}),g(u,{class:"version-status"},{default:p((()=>[g(r,{class:"status-text active"},{default:p((()=>[b("激活中")])),_:1})])),_:1})])),_:1}),g(u,{class:"version-info"},{default:p((()=>[g(r,{class:"info-item"},{default:p((()=>[b("版本号："+x(D.value.version_code),1)])),_:1}),g(r,{class:"info-item"},{default:p((()=>[b("发布时间："+x(H(D.value.publish_time)),1)])),_:1}),g(r,{class:"info-item"},{default:p((()=>[b("下载次数："+x(D.value.download_count||0),1)])),_:1})])),_:1}),D.value.update_content?(k(),m(u,{key:0,class:"version-content"},{default:p((()=>[g(r,{class:"content-title"},{default:p((()=>[b("更新内容：")])),_:1}),g(r,{class:"content-text"},{default:p((()=>[b(x(D.value.update_content),1)])),_:1})])),_:1})):y("",!0)])),_:1})])),_:1})):y("",!0),g(u,{class:"version-list"},{default:p((()=>[g(u,{class:"section-title"},{default:p((()=>[b("所有版本")])),_:1}),(k(!0),P(w,null,S(A.value,(e=>(k(),m(u,{class:"version-card",key:e._id},{default:p((()=>[g(u,{class:"version-header"},{default:p((()=>[g(r,{class:"version-name"},{default:p((()=>[b(x(e.version_name),1)])),_:2},1024),g(u,{class:"version-status"},{default:p((()=>[g(r,{class:V(["status-text",e.is_active?"active":"inactive"])},{default:p((()=>[b(x(e.is_active?"激活中":"未激活"),1)])),_:2},1032,["class"])])),_:2},1024)])),_:2},1024),g(u,{class:"version-info"},{default:p((()=>[g(r,{class:"info-item"},{default:p((()=>[b("版本号："+x(e.version_code),1)])),_:2},1024),g(r,{class:"info-item"},{default:p((()=>[b("发布时间："+x(H(e.publish_time)),1)])),_:2},1024),g(r,{class:"info-item"},{default:p((()=>[b("下载次数："+x(e.download_count||0),1)])),_:2},1024)])),_:2},1024),e.update_content?(k(),m(u,{key:0,class:"version-content"},{default:p((()=>[g(r,{class:"content-title"},{default:p((()=>[b("更新内容：")])),_:1}),g(r,{class:"content-text"},{default:p((()=>[b(x(e.update_content),1)])),_:2},1024)])),_:2},1024)):y("",!0),g(u,{class:"version-actions"},{default:p((()=>[g(f,{class:V(["action-btn",e.is_active?"danger":"primary"]),onClick:t=>(async e=>{const t=e.is_active?"停用":"激活";i({title:"确认操作",content:`确定要${t}版本 ${e.version_name} 吗？`,success:async t=>{if(t.confirm)try{const t=$(),s=await d.callFunction({name:"version",data:{action:"toggleVersionStatus",token:t,data:{version_id:e._id,is_active:!e.is_active}}});0===s.result.code?(a({title:s.result.msg,icon:"success"}),M()):a({title:s.result.msg,icon:"none"})}catch(s){console.error("操作失败:",s),a({title:"操作失败",icon:"none"})}}})})(e)},{default:p((()=>[b(x(e.is_active?"停用":"激活"),1)])),_:2},1032,["onClick","class"]),g(f,{class:"action-btn danger",onClick:t=>(e=>{i({title:"确认删除",content:`确定要删除版本 ${e.version_name} 吗？此操作不可恢复！`,success:async t=>{if(t.confirm)try{const t=$(),s=await d.callFunction({name:"version",data:{action:"deleteVersion",token:t,data:{version_id:e._id}}});0===s.result.code?(a({title:s.result.msg,icon:"success"}),M()):a({title:s.result.msg,icon:"none"})}catch(s){console.error("删除失败:",s),a({title:"删除失败",icon:"none"})}}})})(e)},{default:p((()=>[b("删除")])),_:2},1032,["onClick"])])),_:2},1024)])),_:2},1024)))),128))])),_:1})])),_:1})])),_:1},8,["style"]),F.value?(k(),m(u,{key:0,class:"loading"},{default:p((()=>[g(r,null,{default:p((()=>[b("加载中...")])),_:1})])),_:1})):y("",!0)])),_:1})}}}),[["__scopeId","data-v-d0a37a80"]]);export{F as default};
