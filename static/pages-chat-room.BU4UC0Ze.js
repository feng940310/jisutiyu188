import{t as e,k as a,z as l,l as t,I as s,K as o,S as n,J as c,P as i,c as r,h as u,Q as d,w as g,O as m,R as v}from"./uni.CnKTWU0K.js";import{d as p,b as h,c as f,R as _,Y as y,n as I,a6 as w,ad as k,a7 as b,M as C,aW as x,aP as D,_ as A,aY as M,aN as P,az as S,ak as T,aX as F,ai as R}from"./vendor.CqD9dFNX.js";import{o as Z,c as z,a as B}from"./index-C3v_m0JD.js";import{m as W,c as j}from"./messagePoller.DPVrTeWT.js";import{_ as $}from"./_plugin-vue_export-helper.BCo6x5W8.js";const H=$(p({__name:"room",setup(p){const $=h({}),H=h(20);h({});const E=h(44),L=h(""),G=h({}),U=h(!1),N=h(!1),V=h(!0),J=h([]),Q=h(""),Y=h(0),X=h(""),K=h(!1),O=h(1),q=h(!0),ee=h(0),ae=h([]),le=h(""),te=h(!1),se=h(1),oe=h(0),ne=h(0);h(0),h(0);const ce=h(0),ie=h(0),re=h(0),ue=h(1),de=h(!1),ge=h(0),me=h(0),ve=h(0),pe=h(0),he=f((()=>({transform:`scale(${se.value}) translate(${oe.value}px, ${ne.value}px)`,transition:de.value?"none":"transform 0.3s ease"}))),fe=f((()=>!(N.value&&!U.value)&&(Q.value.trim().length>0||ae.value.length>0))),_e=f((()=>{if(V.value)return!1;return!(N.value&&!U.value)})),ye=f((()=>!V.value&&(N.value&&!U.value)));let Ie=null;_((()=>{we(),$.value.room_id&&W.switchToSingleChatMode($.value.room_id)})),Z((()=>{console.log("[ChatRoom] 页面显示"),$.value.room_id&&W.switchToSingleChatMode($.value.room_id)})),z((()=>{console.log("[ChatRoom] 页面隐藏"),W.pausePolling("用户离开聊天房间")})),y((()=>{console.log("[ChatRoom] 页面卸载"),Ie&&(clearInterval(Ie),Ie=null),W.switchToChatListMode()}));const we=async()=>{try{const t=e();H.value=t.statusBarHeight||20,E.value=44;const s=a("userId");L.value=s;const o=a("userInfo");o&&(G.value=o);const n=l(),c=n[n.length-1].options||{};let i=a("currentChatInfo");i||(i={id:c.id,type:c.type,title:c.title||"聊天",avatar:c.avatar||""}),$.value=i,console.log("聊天室信息:",$.value),console.log("聊天室头像:",$.value.avatar),console.log("使用系统原生键盘处理机制，提供更丝滑的体验"),await Be(),"group"===$.value.type&&(await ze(),await We()),await je(),V.value=!1,await ke(),ca(),setTimeout((async()=>{await $e()}),1e3)}catch(t){console.error("初始化聊天室失败:",t),V.value=!1}},ke=async()=>{try{const e=a("token");if(!e)return;if(console.log("加载消息，会话ID:",$.value.id),1===O.value){const e=a(`chat_messages_${$.value.id}`);if(e&&e.messages&&e.messages.length>0){if(Date.now()-e.cacheTime<3e5)return console.log("使用缓存消息数据"),J.value=e.messages,I((()=>{He()})),void be()}}const l=await B.callFunction("chat",{action:"getMessages",data:{conversationId:$.value.id,page:O.value,pageSize:20},token:e});if(l&&0===l.code){const e=l.data||[],a=e.filter((e=>"image"===e.message_type||"mixed"===e.message_type));a.length>0&&console.log("前端获取到的图片消息:",a.map((e=>({message_id:e.message_id,message_type:e.message_type,content:e.content,images:e.images,text_content:e.text_content})))),1===O.value?(J.value=e,t(`chat_messages_${$.value.id}`,{messages:e,cacheTime:Date.now()}),I((()=>{He()}))):J.value=[...e,...J.value],q.value=e.length>=20,console.log("消息加载成功，数量:",e.length),await $e()}else console.error("加载消息失败:",null==l?void 0:l.msg)}catch(e){console.error("加载消息异常:",e)}finally{K.value=!1}},be=async()=>{try{const e=a("token");if(!e)return;const l=await B.callFunction("chat",{action:"getMessages",data:{conversationId:$.value.id,page:1,pageSize:20},token:e});if(l&&0===l.code){const e=l.data||[];e.length>J.value.length&&(J.value=e,t(`chat_messages_${$.value.id}`,{messages:e,cacheTime:Date.now()}),I((()=>{He()}))),await $e()}}catch(e){console.log("异步加载最新消息失败:",e)}},Ce=async()=>{!K.value&&q.value&&(K.value=!0,O.value+=1,await ke())},xe=async()=>{var e;if(fe.value)if(!N.value||U.value)try{const l=Q.value,t=l.trim().length>0,s=ae.value.length>0,o=a("token");if(!t&&!s)return;let n="text",c={},i=[...ae.value];s&&t?n="mixed":s&&(n="image"),"text"===n?c.content=l:"image"===n?(c.content=null==(e=i[0])?void 0:e.url,c.images=i.map((e=>e.url))):"mixed"===n&&(c.text_content=l,c.images=i.map((e=>e.url)),c.content=l);const r={message_id:`temp_${Date.now()}`,conversation_id:$.value.id,sender_id:L.value,sender_name:"我",message_type:n,send_time:new Date,sending:!0,uploading:s,...c};J.value.push(r),I((()=>{He()}));const u=()=>{Q.value="",ae.value=[]};u(),I((()=>{u()})),s?Ae(r,i,l,n,o):De(r,l,o)}catch(l){u(),console.error("发送消息失败:",l),r({title:"网络异常",icon:"none"})}else r({title:"群聊已被禁言，只有管理员可以发言",icon:"none"})},De=async(e,a,l)=>{try{const t=await B.callFunction("chat",{action:"sendMessage",data:{conversationId:$.value.id,content:a,messageType:"text",groupId:"group"===$.value.type?$.value.id:null},token:l});Re(e.message_id,t)}catch(t){console.error("发送文字消息失败:",t),Ze(e.message_id)}},Ae=async(e,a,l,t,s)=>{var o,n,c;try{console.log("开始上传图片并发送消息:",a.length,"张图片");const i=await Me(a,e.message_id),r=J.value.findIndex((a=>a.message_id===e.message_id));-1!==r?(console.log("更新本地消息图片URL:",{messageType:t,uploadedImages:i.map((e=>{var a;return{url:(null==(a=e.url)?void 0:a.substring(0,50))+"...",originalPath:e.originalPath}})),tempIndex:r}),"image"===t?(J.value[r].content=(null==(o=i[0])?void 0:o.url)||"[图片]",J.value[r].images=i.map((e=>e.url))):"mixed"===t&&(J.value[r].images=i.map((e=>e.url))),J.value[r].uploading=!1,console.log("本地消息更新完成:",{content:null==(n=J.value[r].content)?void 0:n.substring(0,50),images:null==(c=J.value[r].images)?void 0:c.map((e=>(null==e?void 0:e.substring(0,50))+"...")),uploading:J.value[r].uploading})):console.error("未找到要更新的临时消息:",e.message_id);const u={conversationId:$.value.id,messageType:t,groupId:"group"===$.value.type?$.value.id:null};"image"===t?(u.content="[图片]",u.images=i.map((e=>e.url))):"mixed"===t&&(u.content=l,u.textContent=l,u.images=i.map((e=>e.url))),console.log("发送图片消息到服务器（含云存储URL）:",{...u,imagesCount:i.length});const d=await B.callFunction("chat",{action:"sendMessage",data:u,token:s});console.log("图片消息发送结果:",d),Re(e.message_id,d)}catch(i){console.error("发送图片消息失败:",i),Ze(e.message_id)}},Me=async(e,l)=>{const t=[];for(let o=0;o<e.length;o++){const l=e[o];try{console.log(`开始上传第${o+1}张图片:`,l.url);const e=await Pe(l.url),s=await B.callFunction("upload",{action:"uploadImage",data:{base64Data:e,fileName:`chat_image_${Date.now()}_${o}.jpg`,type:"chat"},token:a("token")});s&&0===s.code?(t.push({url:s.data.url,fileID:s.data.fileID,originalPath:l.url}),console.log(`第${o+1}张图片上传成功:`,s.data.url.substring(0,50)+"...")):(console.error(`第${o+1}张图片上传失败:`,s),r({title:`第${o+1}张图片上传失败`,icon:"none",duration:2e3}),t.push({url:"data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KICA8cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjZjBmMGYwIi8+CiAgPHRleHQgeD0iNTAlIiB5PSI1MCUiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIxNiIgZmlsbD0iIzk5OSIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9Ii4zZW0iPuS4iuS8oOWksei0pTwvdGV4dD4KPC9zdmc+",fileID:null,originalPath:l.url}))}catch(s){console.error(`第${o+1}张图片处理失败:`,s);const e=s.message||s.errMsg||"未知错误";r({title:`图片${o+1}处理失败: ${e}`,icon:"none",duration:3e3}),t.push({url:"data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KICA8cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjZjBmMGYwIi8+CiAgPHRleHQgeD0iNTAlIiB5PSI1MCUiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIxNiIgZmlsbD0iIzk5OSIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9Ii4zZW0iPuWksei0pTwvdGV4dD4KPC9zdmc+",fileID:null,originalPath:l.url,error:e})}}return t},Pe=async a=>new Promise(((l,t)=>{try{if(console.log("开始读取图片文件:",a,"当前平台:",e().platform),!a||a.length<5)throw new Error("无效的图片路径");const s=e();if("h5"===s.platform||"undefined"!=typeof window)return console.log("H5环境：使用Canvas方法读取图片"),void Fe(a).then(l).catch(t);console.log("小程序/App环境：使用文件系统API");if(("android"===s.platform||"ios"===s.platform)&&"undefined"!=typeof plus&&plus.io)return console.log("App环境：尝试使用plus.io API"),void Se(a).then(l).catch((e=>{console.warn("plus.io失败，回退到文件系统API:",e),Te(a).then(l).catch(t)}));Te(a).then(l).catch(t)}catch(s){console.error("读取图片文件异常:",s),t(s)}})),Se=async e=>new Promise(((a,l)=>{try{console.log("使用plus.io API读取图片:",e);let t=e;e.startsWith("file://")&&(t=e.replace("file://","")),plus.io.resolveLocalFileSystemURL(t,(e=>{e.file((e=>{const t=new plus.io.FileReader;t.onloadend=e=>{e.target&&e.target.result?(console.log("plus.io读取成功，数据长度:",e.target.result.length),a(e.target.result)):l(new Error("plus.io读取结果为空"))},t.onerror=e=>{console.error("plus.io FileReader错误:",e),l(new Error("plus.io FileReader读取失败"))},t.readAsDataURL(e)}),(e=>{console.error("plus.io获取文件对象失败:",e),l(new Error(`plus.io获取文件对象失败: ${e.message||"未知错误"}`))}))}),(e=>{console.error("plus.io解析文件路径失败:",e),l(new Error(`plus.io解析文件路径失败: ${e.message||"未知错误"}`))}))}catch(t){console.error("plus.io读取异常:",t),l(t)}})),Te=async e=>new Promise(((a,l)=>{try{const t=uni.getFileSystemManager();if(!t||"function"!=typeof t.readFile)return console.error("文件系统管理器不可用"),void l(new Error("文件系统管理器不可用"));t.readFile({filePath:e,encoding:"base64",success:t=>{if(t&&t.data){console.log("文件系统API读取成功，数据长度:",t.data.length);let l="image/jpeg";e.toLowerCase().includes(".png")?l="image/png":e.toLowerCase().includes(".gif")?l="image/gif":e.toLowerCase().includes(".webp")&&(l="image/webp"),a(`data:${l};base64,${t.data}`)}else console.error("读取文件返回空数据"),l(new Error("读取文件返回空数据"))},fail:s=>{console.error("文件系统API第一次读取失败:",s),t.readFile({filePath:e,success:e=>{if(e&&e.data)try{const l=d(e.data);console.log("ArrayBuffer转换成功，数据长度:",l.length),a(`data:image/jpeg;base64,${l}`)}catch(t){console.error("转换ArrayBuffer失败:",t),l(new Error(`ArrayBuffer转换失败: ${t.message}`))}else l(new Error("第二次读取文件也返回空数据"))},fail:e=>{console.error("文件系统API第二次读取也失败:",e),l(new Error(`文件系统API读取失败: ${e.errMsg||e.message||"未知错误"}`))}})}})}catch(t){console.error("文件系统API读取异常:",t),l(t)}})),Fe=async e=>new Promise(((a,l)=>{try{if(console.log("H5 Canvas方法读取图片:",e),e.startsWith("data:"))return console.log("已经是base64格式，直接返回"),void a(e);if(e.startsWith("blob:"))return console.log("处理blob URL"),void fetch(e).then((e=>e.blob())).then((e=>{const t=new FileReader;t.onload=e=>{a(e.target.result)},t.onerror=e=>{console.error("FileReader读取失败:",e),l(new Error("FileReader读取失败"))},t.readAsDataURL(e)})).catch((e=>{console.error("fetch blob失败:",e),l(e)}));const t=new Image;t.crossOrigin="anonymous",t.onload=()=>{try{const e=document.createElement("canvas"),l=e.getContext("2d");e.width=t.width,e.height=t.height,l.drawImage(t,0,0);const s=e.toDataURL("image/jpeg",.8);console.log("Canvas转换成功，数据长度:",s.length),a(s)}catch(e){console.error("Canvas转换失败:",e),l(e)}},t.onerror=e=>{console.error("图片加载失败:",e),l(new Error("图片加载失败"))},t.src=e}catch(t){console.error("H5图片读取异常:",t),l(t)}})),Re=(e,a)=>{const l=J.value.findIndex((a=>a.message_id===e));-1!==l&&(a&&0===a.code?J.value[l]={...J.value[l],message_id:a.data.messageId,send_time:a.data.sendTime,sending:!1,uploading:!1}:Ze(e))},Ze=e=>{const a=J.value.findIndex((a=>a.message_id===e));-1!==a&&(J.value[a]={...J.value[a],sending:!1,uploading:!1,sendError:!0},r({title:"发送失败",icon:"none"}))},ze=async()=>{try{const e=a("token"),l=await B.callFunction("chat",{action:"getGroupMembers",data:{groupId:$.value.id},token:e});l&&0===l.code&&(ee.value=l.data.length)}catch(e){console.error("获取群成员数量失败:",e)}},Be=async()=>{try{const e=a("token");if(!e)return void console.log("检查管理员权限失败: 缺少token");console.log("开始检查管理员权限");const l=await B.callFunction("user",{action:"checkAdminStatus",token:e});console.log("checkAdminStatus 结果:",l),l&&0===l.code?(U.value=l.is_admin,console.log("管理员权限设置为:",U.value)):console.log("checkAdminStatus 调用失败:",l)}catch(e){console.error("检查管理员权限失败:",e)}},We=async()=>{try{const e=a("token");if(!e||!$.value.id)return void console.log("检查群聊状态失败: 缺少token或chatInfo.id",{token:!!e,chatId:$.value.id});console.log("开始检查群聊状态, chatInfo.id:",$.value.id);const l=await B.callFunction("chat",{action:"getGroupInfo",data:{groupId:$.value.id},token:e});if(console.log("getGroupInfo 结果:",l),l&&0===l.code){const e=l.data;console.log("群聊信息:",e),N.value=e.is_muted||!1,console.log("群聊禁言状态设置为:",N.value,"原始值:",e.is_muted)}else console.log("getGroupInfo 调用失败:",l)}catch(e){console.error("检查群聊状态失败:",e)}},je=async()=>{try{const e=a("token");if(!e||!$.value.id)return void console.log("加载聊天室信息失败: 缺少token或chatInfo.id",{token:!!e,chatId:$.value.id});console.log("开始加载聊天室信息, chatInfo.id:",$.value.id);const l=await B.callFunction("chat",{action:"getRoomInfo",data:{roomId:$.value.id},token:e});if(console.log("getRoomInfo 结果:",l),l&&0===l.code&&l.room){const e=l.room;console.log("聊天室详细信息:",e),e.avatar&&($.value.avatar=e.avatar,console.log("更新聊天室头像:",e.avatar)),e.title&&($.value.title=e.title,console.log("更新聊天室标题:",e.title)),t("currentChatInfo",$.value)}else console.log("getRoomInfo 调用失败或无数据:",l)}catch(e){console.error("加载聊天室信息失败:",e)}},$e=async()=>{var e;try{const l=a("token")||a("userToken");if(!l)return void console.log("未找到token，跳过标记已读");console.log("标记消息已读，会话ID:",$.value.id);const t=await B.callFunction("chat",{action:"markAsRead",data:{conversationId:$.value.id},token:l});t&&0===t.code?console.log("标记已读成功，更新了",null==(e=t.data)?void 0:e.updatedCount,"条消息"):console.log("标记已读失败:",null==t?void 0:t.msg)}catch(l){console.error("标记已读失败:",l)}},He=()=>{X.value="message-bottom",setTimeout((()=>{X.value=""}),100)},Ee=()=>{console.log("输入框获得焦点"),setTimeout((()=>{He()}),300)},Le=()=>{console.log("输入框失去焦点")},Ge=()=>{},Ue=e=>{console.log("粘贴事件:",e)},Ne=()=>{const a=e().platform;if(console.log("当前平台:",a),"h5"===a||"undefined"!=typeof window)return console.log("H5环境：使用原生input选择图片"),void Ve();"function"==typeof uni.chooseMedia?(console.log("使用 chooseMedia API（手机端）"),uni.chooseMedia({count:9-ae.value.length,mediaType:["image"],sizeType:["original","compressed"],sourceType:["album","camera"],success:e=>{console.log("chooseMedia 选择图片成功:",e);(e.tempFiles||[]).forEach((e=>{ae.value.push({url:e.tempFilePath,isTemp:!0,size:e.size,type:e.fileType})})),I((()=>{He()}))},fail:e=>{console.error("chooseMedia 失败，尝试使用 chooseImage:",e),Je()}})):(console.log("chooseMedia 不可用，使用 chooseImage API（小程序端）"),Je())},Ve=()=>{const e=document.createElement("input");e.type="file",e.accept="image/*",e.multiple=!0,e.style.display="none",e.onchange=a=>{const l=a.target.files;if(!l||0===l.length)return void console.log("H5: 未选择文件");console.log("H5: 选择了",l.length,"个文件");const t=9-ae.value.length;Array.from(l).slice(0,t).forEach(((e,a)=>{const l=URL.createObjectURL(e);ae.value.push({url:l,isTemp:!0,size:e.size,type:e.type,file:e}),console.log(`H5: 添加图片${a+1}:`,{name:e.name,size:e.size,type:e.type,url:l.substring(0,50)+"..."})})),I((()=>{He()})),document.body.removeChild(e)},e.oncancel=()=>{console.log("H5: 用户取消选择"),document.body.removeChild(e)},document.body.appendChild(e),e.click()},Je=()=>{g({count:9-ae.value.length,sizeType:["original","compressed"],sourceType:["album","camera"],success:e=>{console.log("chooseImage 选择图片成功:",e);(e.tempFilePaths||[]).forEach((e=>{ae.value.push({url:e,isTemp:!0})})),I((()=>{He()}))},fail:e=>{console.error("选择图片失败:",e),r({title:"选择图片失败",icon:"none"})}})},Qe=e=>{le.value=e,te.value=!0},Ye=()=>{te.value=!1,le.value="",Xe()},Xe=()=>{se.value=1,oe.value=0,ne.value=0,de.value=!1},Ke=e=>{console.log("图片加载完成:",e),Xe()},Oe=(e,a)=>{const l=e.clientX-a.clientX,t=e.clientY-a.clientY;return Math.sqrt(l*l+t*t)},qe=e=>{const a=e.touches;ce.value=Date.now(),1===a.length?(de.value=!0,ge.value=a[0].clientX,me.value=a[0].clientY,ve.value=oe.value,pe.value=ne.value):2===a.length&&(de.value=!1,re.value=Oe(a[0],a[1]),ue.value=se.value)},ea=e=>{e.preventDefault();const a=e.touches;if(1===a.length&&de.value&&se.value>1){const e=a[0].clientX-ge.value,l=a[0].clientY-me.value;oe.value=ve.value+e/se.value,ne.value=pe.value+l/se.value;const t=150*(se.value-1),s=150*(se.value-1);oe.value=Math.max(-t,Math.min(t,oe.value)),ne.value=Math.max(-s,Math.min(s,ne.value))}else if(2===a.length){const e=Oe(a[0],a[1])/re.value;let l=ue.value*e;l=Math.max(.5,Math.min(5,l)),se.value=l,l<1.1&&(oe.value=0,ne.value=0)}},aa=e=>{const a=Date.now();a-ce.value<300&&1===e.changedTouches.length&&(a-ie.value<500&&(se.value>1.5?(se.value=1,oe.value=0,ne.value=0):(se.value=2,oe.value=0,ne.value=0)),ie.value=a),de.value=!1},la=e=>{se.value<=1.1&&setTimeout((()=>{Ye()}),100)},ta=e=>{var a,l,t;if(console.log("getImageSrc 处理消息:",{message_id:e.message_id,message_type:e.message_type,sender_id:e.sender_id,content:e.content,images:e.images,hasImages:e.images&&e.images.length>0,isMyMessage:e.sender_id===L.value}),e.images&&e.images.length>0){const l=e.images[0];return console.log("getImageSrc: 使用images字段的第一张图片:",typeof l,null==(a=null==l?void 0:l.substring)?void 0:a.call(l,0,50)),sa(l)}return"image"===e.message_type||"mixed"===e.message_type?(console.log("getImageSrc: 图片消息但无images字段，使用content:",typeof e.content,null==(t=null==(l=e.content)?void 0:l.substring)?void 0:t.call(l,0,50)),sa(e.content)):(console.log("getImageSrc: 使用默认content字段:",e.content),sa(e.content))},sa=e=>{if(!e)return console.warn("getImageUrl: 图片数据为空"),"";if(console.log("getImageUrl处理数据:",{type:typeof e,isString:"string"==typeof e,startsWith:"string"==typeof e?{http:e.startsWith("http"),data:e.startsWith("data:image/"),isPlaceholder:"[图片]"===e||e.includes("[图片]")}:null,preview:"string"==typeof e?e.substring(0,100)+"...":e}),"string"==typeof e)return e.startsWith("http")?(console.log("getImageUrl: 返回HTTP URL:",e.substring(0,50)+"..."),e):e.startsWith("data:image/")?(console.log("getImageUrl: 返回base64格式图片，长度:",e.length),e):"[图片]"===e||e.includes("[图片]")?(console.log("getImageUrl: 返回占位符图片"),"data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KICA8cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjZjBmMGYwIi8+CiAgPHRleHQgeD0iNTAlIiB5PSI1MCUiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIxNiIgZmlsbD0iIzk5OSIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9Ii4zZW0iPuWbvueJhzwvdGV4dD4KPC9zdmc+"):(console.log("getImageUrl: 返回原始数据（可能是本地路径）:",e),e);if("object"==typeof e){const a=e.url||e.base64||e.path||"";return console.log("getImageUrl: 从对象获取URL:",(null==a?void 0:a.substring(0,50))+"..."),a}return console.log("getImageUrl: 无法处理的数据格式，返回空"),""},oa=(e,a)=>{if(0===a)return!0;const l=J.value[a-1];return new Date(e.send_time).getTime()-new Date(l.send_time).getTime()>3e5},na=e=>{const a=new Date(e),l=new Date;if(a.toDateString()===l.toDateString())return a.toLocaleTimeString("zh-CN",{hour:"2-digit",minute:"2-digit"});const t=new Date(l);return t.setDate(l.getDate()-1),a.toDateString()===t.toDateString()?"昨天 "+a.toLocaleTimeString("zh-CN",{hour:"2-digit",minute:"2-digit"}):`${a.getMonth()+1}月${a.getDate()}日 ${a.toLocaleTimeString("zh-CN",{hour:"2-digit",minute:"2-digit"})}`},ca=()=>{Ie=setInterval((async()=>{await ia(),"group"===$.value.type&&await We()}),3e3)},ia=async()=>{try{if(0===J.value.length)return;const e=a("token");if(!e)return;const l=J.value[J.value.length-1].send_time;console.log("检查新消息，最后消息时间:",l);const s=await B.callFunction("chat",{action:"getMessages",data:{conversationId:$.value.id,page:1,pageSize:10,afterTime:l},token:e});if(s&&0===s.code){const e=(s.data||[]).filter((e=>!J.value.some((a=>a.message_id===e.message_id||a.content===e.content&&a.sender_id===e.sender_id&&Math.abs(new Date(a.send_time)-new Date(e.send_time))<5e3))));e.length>0&&(console.log("收到新消息:",e.length,"条",e),J.value.push(...e),t(`chat_messages_${$.value.id}`,{messages:J.value,cacheTime:Date.now()}),I((()=>{He()})),await $e())}}catch(e){console.log("检查新消息失败:",e)}},ra=["#FF6B6B","#4ECDC4","#45B7D1","#96CEB4","#FFEAA7","#DDA0DD","#98D8C8","#F7DC6F","#BB8FCE","#85C1E9","#F8C471","#82E0AA","#F1948A","#85C1E9","#D5A6BD"],ua=e=>{if(!e)return ra[0];let a=0;for(let t=0;t<e.length;t++)a=e.charCodeAt(t)+((a<<5)-a);const l=Math.abs(a)%ra.length;return ra[l]},da=()=>{const e=$.value.id||$.value.title||"default";let a=0;for(let t=0;t<e.length;t++)a=e.charCodeAt(t)+((a<<5)-a);const l=Math.abs(a)%ra.length;return ra[l]},ga=e=>e&&e.startsWith('【来自聊天室"')&&e.includes("】\n"),ma=e=>{if(!ga(e))return"";const a=e.match(/^【来自聊天室"(.+?)"】/);return a?`【来自聊天室"${a[1]}"】`:""},va=e=>{if(!ga(e))return e;const a=e.split("】\n");return a.length>1?a[1]:e},pa=()=>{console.log("[ChatRoom] 退出聊天室:",$.value.title),Ie&&(clearInterval(Ie),Ie=null),$.value.id&&(console.log("[ChatRoom] 确保会话已读:",$.value.id),j.markAsRead($.value.id)),m("chatRoomClosed",{conversationId:$.value.id}),v()};return(e,a)=>{const l=s,t=o,r=c,u=n,d=i;return b(),w(l,{class:"chat-room"},{default:k((()=>[C(l,{class:"page-background"}),C(l,{class:"nav-bar",style:D({paddingTop:H.value+"px",height:E.value+"px"})},{default:k((()=>[C(l,{class:"nav-content"},{default:k((()=>[C(l,{class:"nav-left",onClick:pa},{default:k((()=>[C(l,{class:"back-arrow"})])),_:1}),C(l,{class:"nav-center"},{default:k((()=>[C(t,{class:"chat-title"},{default:k((()=>[A(M($.value.title),1)])),_:1})])),_:1}),C(l,{class:"nav-right"})])),_:1})])),_:1},8,["style"]),C(u,{class:"message-list",style:D({paddingTop:H.value+E.value+"px",paddingBottom:"120rpx"}),"scroll-y":"true","scroll-top":Y.value,"scroll-into-view":X.value,onScrolltoupper:Ce,"show-scrollbar":!1,"enable-back-to-top":!1},{default:k((()=>[K.value?(b(),w(l,{key:0,class:"loading-more"},{default:k((()=>[C(t,null,{default:k((()=>[A("加载中...")])),_:1})])),_:1})):x("",!0),C(l,{class:"messages"},{default:k((()=>[(b(!0),P(S,null,T(J.value,((e,a)=>(b(),w(l,{key:e.message_id,id:`msg-${a}`,class:F(["message-item",{"is-mine":e.sender_id===L.value}])},{default:k((()=>[oa(e,a)?(b(),w(l,{key:0,class:"time-divider"},{default:k((()=>[C(t,{class:"time-text"},{default:k((()=>[A(M(na(e.send_time)),1)])),_:2},1024)])),_:2},1024)):x("",!0),C(l,{class:"message-content"},{default:k((()=>[e.sender_id!==L.value?(b(),w(l,{key:0,class:"message-left"},{default:k((()=>[C(l,{class:"sender-avatar"},{default:k((()=>[$.value.avatar?(b(),w(r,{key:0,class:"avatar-image",src:$.value.avatar,mode:"aspectFill"},null,8,["src"])):(b(),w(l,{key:1,class:"avatar-placeholder",style:D({background:da()})},{default:k((()=>[C(t,{class:"avatar-text"},{default:k((()=>{var e;return[A(M((null==(e=$.value.title)?void 0:e.charAt(0))||"聊"),1)]})),_:1})])),_:1},8,["style"]))])),_:1}),C(l,{class:"message-info"},{default:k((()=>[C(l,{class:"sender-name"},{default:k((()=>[A(M(e.sender_name),1)])),_:2},1024),C(l,{class:"message-bubble left-bubble"},{default:k((()=>["text"===e.message_type?(b(),w(l,{key:0,class:"message-text"},{default:k((()=>[ga(e.content)?(b(),w(l,{key:0,class:"sync-message"},{default:k((()=>[C(l,{class:"sync-source"},{default:k((()=>[A(M(ma(e.content)),1)])),_:2},1024),C(l,{class:"sync-content"},{default:k((()=>[A(M(va(e.content)),1)])),_:2},1024)])),_:2},1024)):(b(),w(t,{key:1},{default:k((()=>[A(M(e.content),1)])),_:2},1024))])),_:2},1024)):"image"===e.message_type?(b(),w(l,{key:1,class:"message-image-container"},{default:k((()=>[C(l,{class:F(["image-wrapper",{uploading:e.uploading}])},{default:k((()=>[C(r,{src:ta(e),class:"message-image",mode:"aspectFill",onClick:a=>Qe(ta(e))},null,8,["src","onClick"]),e.uploading?(b(),w(l,{key:0,class:"upload-mask"},{default:k((()=>[C(l,{class:"upload-spinner"}),C(t,{class:"upload-text"},{default:k((()=>[A("上传中...")])),_:1})])),_:1})):x("",!0)])),_:2},1032,["class"])])),_:2},1024)):"mixed"===e.message_type?(b(),w(l,{key:2,class:"message-mixed"},{default:k((()=>[e.text_content?(b(),w(l,{key:0,class:"message-text"},{default:k((()=>[A(M(e.text_content),1)])),_:2},1024)):x("",!0),e.images&&e.images.length>0?(b(),w(l,{key:1,class:"message-images"},{default:k((()=>[(b(!0),P(S,null,T(e.images,((a,t)=>(b(),w(l,{key:t,class:F(["image-wrapper",{uploading:e.uploading}])},{default:k((()=>[C(r,{src:sa(a),class:"message-image",mode:"aspectFill",onClick:e=>Qe(sa(a))},null,8,["src","onClick"]),e.uploading?(b(),w(l,{key:0,class:"upload-mask"},{default:k((()=>[C(l,{class:"upload-spinner"})])),_:1})):x("",!0)])),_:2},1032,["class"])))),128))])),_:2},1024)):x("",!0)])),_:2},1024)):x("",!0)])),_:2},1024)])),_:2},1024)])),_:2},1024)):(b(),w(l,{key:1,class:"message-right"},{default:k((()=>[C(l,{class:"message-bubble right-bubble"},{default:k((()=>["text"===e.message_type?(b(),w(l,{key:0,class:"message-text"},{default:k((()=>[ga(e.content)?(b(),w(l,{key:0,class:"sync-message"},{default:k((()=>[C(l,{class:"sync-source"},{default:k((()=>[A(M(ma(e.content)),1)])),_:2},1024),C(l,{class:"sync-content"},{default:k((()=>[A(M(va(e.content)),1)])),_:2},1024)])),_:2},1024)):(b(),w(t,{key:1},{default:k((()=>[A(M(e.content),1)])),_:2},1024))])),_:2},1024)):"image"===e.message_type?(b(),w(l,{key:1,class:"message-image-container"},{default:k((()=>[C(l,{class:F(["image-wrapper",{uploading:e.uploading}])},{default:k((()=>[C(r,{src:ta(e),class:"message-image",mode:"aspectFill",onClick:a=>Qe(ta(e))},null,8,["src","onClick"]),e.uploading?(b(),w(l,{key:0,class:"upload-mask"},{default:k((()=>[C(l,{class:"upload-spinner"}),C(t,{class:"upload-text"},{default:k((()=>[A("上传中...")])),_:1})])),_:1})):x("",!0)])),_:2},1032,["class"])])),_:2},1024)):"mixed"===e.message_type?(b(),w(l,{key:2,class:"message-mixed"},{default:k((()=>[e.text_content?(b(),w(l,{key:0,class:"message-text"},{default:k((()=>[A(M(e.text_content),1)])),_:2},1024)):x("",!0),e.images&&e.images.length>0?(b(),w(l,{key:1,class:"message-images"},{default:k((()=>[(b(!0),P(S,null,T(e.images,((a,t)=>(b(),w(l,{key:t,class:F(["image-wrapper",{uploading:e.uploading}])},{default:k((()=>[C(r,{src:sa(a),class:"message-image",mode:"aspectFill",onClick:e=>Qe(sa(a))},null,8,["src","onClick"]),e.uploading?(b(),w(l,{key:0,class:"upload-mask"},{default:k((()=>[C(l,{class:"upload-spinner"})])),_:1})):x("",!0)])),_:2},1032,["class"])))),128))])),_:2},1024)):x("",!0)])),_:2},1024)):x("",!0),e.sending||e.sendError?(b(),w(l,{key:3,class:"message-status"},{default:k((()=>[e.sending?(b(),w(l,{key:0,class:"sending-indicator"},{default:k((()=>[C(l,{class:"sending-spinner"})])),_:1})):x("",!0),e.sendError?(b(),w(l,{key:1,class:"error-indicator"},{default:k((()=>[C(t,{class:"error-icon"},{default:k((()=>[A("!")])),_:1})])),_:1})):x("",!0)])),_:2},1024)):x("",!0)])),_:2},1024),C(l,{class:"sender-avatar"},{default:k((()=>[C(l,{class:"avatar-placeholder",style:D({background:ua(L.value)})},{default:k((()=>[C(t,{class:"avatar-text"},{default:k((()=>{var e;return[A(M((null==(e=G.value.nickname||G.value.mobile||"我")?void 0:e.charAt(0))||"我"),1)]})),_:1})])),_:1},8,["style"])])),_:1})])),_:2},1024))])),_:2},1024)])),_:2},1032,["id","class"])))),128))])),_:1}),C(l,{class:"message-bottom",id:"message-bottom"})])),_:1},8,["style","scroll-top","scroll-into-view"]),V.value?(b(),w(l,{key:0,class:"loading-status"},{default:k((()=>[C(l,{class:"loading-container"},{default:k((()=>[C(l,{class:"loading-spinner"}),C(t,{class:"loading-text"},{default:k((()=>[A("正在加载聊天状态...")])),_:1})])),_:1})])),_:1})):x("",!0),_e.value?(b(),w(l,{key:1,class:"input-area"},{default:k((()=>[ae.value.length>0?(b(),w(l,{key:0,class:"image-preview-area"},{default:k((()=>[C(u,{class:"image-preview-scroll","scroll-x":"true","show-scrollbar":!1},{default:k((()=>[C(l,{class:"image-preview-list"},{default:k((()=>[(b(!0),P(S,null,T(ae.value,((e,a)=>(b(),w(l,{key:a,class:"preview-image-item"},{default:k((()=>[C(r,{src:e.url,class:"preview-image",mode:"aspectFill",onClick:a=>Qe(e.url)},null,8,["src","onClick"]),C(l,{class:"remove-image-btn",onClick:e=>(e=>{ae.value.splice(e,1)})(a)},{default:k((()=>[C(t,{class:"remove-text"},{default:k((()=>[A("×")])),_:1})])),_:2},1032,["onClick"])])),_:2},1024)))),128))])),_:1})])),_:1})])),_:1})):x("",!0),C(l,{class:"input-container"},{default:k((()=>[C(l,{class:"input-actions"},{default:k((()=>[C(l,{class:"action-btn camera-btn",onClick:Ne},{default:k((()=>[C(l,{class:"camera-icon"},{default:k((()=>[C(l,{class:"camera-body"},{default:k((()=>[C(l,{class:"camera-lens"},{default:k((()=>[C(l,{class:"camera-lens-inner"})])),_:1}),C(l,{class:"camera-flash"}),C(l,{class:"camera-viewfinder"})])),_:1})])),_:1})])),_:1})])),_:1}),C(l,{class:"input-wrapper"},{default:k((()=>[C(d,{class:"message-input",modelValue:Q.value,"onUpdate:modelValue":a[0]||(a[0]=e=>Q.value=e),placeholder:"输入消息,支持换行,支持图片","auto-height":!0,maxlength:500,"adjust-position":!0,"cursor-spacing":10,onFocus:Ee,onBlur:Le,onInput:Ge,onPaste:Ue,"confirm-type":"return"},null,8,["modelValue"])])),_:1}),C(l,{class:F(["send-btn",{disabled:!fe.value}]),onClick:xe},{default:k((()=>[C(t,{class:"send-text"},{default:k((()=>[A("发送")])),_:1})])),_:1},8,["class"])])),_:1})])),_:1})):x("",!0),ye.value?(b(),w(l,{key:2,class:"mute-notice"},{default:k((()=>[C(l,{class:"mute-container"},{default:k((()=>[C(l,{class:"mute-icon"},{default:k((()=>[A("🔇")])),_:1}),C(t,{class:"mute-text"},{default:k((()=>[A("群聊已被禁言，只有管理员可以发言")])),_:1})])),_:1})])),_:1})):x("",!0),te.value?(b(),w(l,{key:3,class:"image-preview-modal",onClick:Ye},{default:k((()=>[C(l,{class:"preview-modal-content",onClick:a[1]||(a[1]=R((()=>{}),["stop"]))},{default:k((()=>[C(l,{class:"preview-close-btn",onClick:Ye},{default:k((()=>[C(t,{class:"close-icon"},{default:k((()=>[A("×")])),_:1})])),_:1}),C(l,{class:"zoomable-image-container",onTouchstart:qe,onTouchmove:ea,onTouchend:aa,onClick:la},{default:k((()=>[C(r,{src:le.value,class:"preview-modal-image",mode:"aspectFit",style:D(he.value),onLoad:Ke},null,8,["src","style"])])),_:1}),C(l,{class:"preview-tips"},{default:k((()=>[C(t,{class:"tip-text"},{default:k((()=>[A("双击或双指缩放 • 拖拽移动 • 点击关闭")])),_:1})])),_:1})])),_:1})])),_:1})):x("",!0)])),_:1})}}}),[["__scopeId","data-v-881eecee"]]);export{H as default};
