import{t as e,k as a,z as l,l as t,I as s,K as o,S as n,J as c,P as i,c as r,h as u,Q as d,w as g,O as m,R as v}from"./uni.CnKTWU0K.js";import{d as p,b as h,c as f,R as _,Y as y,n as I,a6 as w,ad as k,a7 as b,M as C,aW as x,aP as D,_ as A,aY as M,aN as P,az as S,ak as T,aX as F,ai as R}from"./vendor.CqD9dFNX.js";import{o as Z,c as z,a as B}from"./index-C3v_m0JD.js";import{m as W,c as j}from"./messagePoller.DPVrTeWT.js";import{_ as $}from"./_plugin-vue_export-helper.BCo6x5W8.js";const H=$(p({__name:"room",setup(p){const $=h({}),H=h(20);h({});const E=h(44),L=h(""),G=h({}),U=h(!1),N=h(!1),V=h(!0),J=h([]),Q=h(""),Y=h(0),X=h(""),K=h(!1),O=h(1),q=h(!0),ee=h(0),ae=h([]),le=h(""),te=h(!1),se=h(1),oe=h(0),ne=h(0);h(0),h(0);const ce=h(0),ie=h(0),re=h(0),ue=h(1),de=h(!1),ge=h(0),me=h(0),ve=h(0),pe=h(0),he=f((()=>({transform:`scale(${se.value}) translate(${oe.value}px, ${ne.value}px)`,transition:de.value?"none":"transform 0.3s ease"}))),fe=f((()=>!(N.value&&!U.value)&&(Q.value.trim().length>0||ae.value.length>0))),_e=f((()=>{if(V.value)return!1;return!(N.value&&!U.value)})),ye=f((()=>!V.value&&(N.value&&!U.value)));let Ie=null;_((()=>{we(),$.value.room_id&&W.switchToSingleChatMode($.value.room_id)})),Z((()=>{console.log("[ChatRoom] é¡µé¢æ˜¾ç¤º"),$.value.room_id&&W.switchToSingleChatMode($.value.room_id)})),z((()=>{console.log("[ChatRoom] é¡µé¢éšè—"),W.pausePolling("ç”¨æˆ·ç¦»å¼€èŠå¤©æˆ¿é—´")})),y((()=>{console.log("[ChatRoom] é¡µé¢å¸è½½"),Ie&&(clearInterval(Ie),Ie=null),W.switchToChatListMode()}));const we=async()=>{try{const t=e();H.value=t.statusBarHeight||20,E.value=44;const s=a("userId");L.value=s;const o=a("userInfo");o&&(G.value=o);const n=l(),c=n[n.length-1].options||{};let i=a("currentChatInfo");i||(i={id:c.id,type:c.type,title:c.title||"èŠå¤©",avatar:c.avatar||""}),$.value=i,console.log("èŠå¤©å®¤ä¿¡æ¯:",$.value),console.log("èŠå¤©å®¤å¤´åƒ:",$.value.avatar),console.log("ä½¿ç”¨ç³»ç»ŸåŸç”Ÿé”®ç›˜å¤„ç†æœºåˆ¶ï¼Œæä¾›æ›´ä¸æ»‘çš„ä½“éªŒ"),await Be(),"group"===$.value.type&&(await ze(),await We()),await je(),V.value=!1,await ke(),ca(),setTimeout((async()=>{await $e()}),1e3)}catch(t){console.error("åˆå§‹åŒ–èŠå¤©å®¤å¤±è´¥:",t),V.value=!1}},ke=async()=>{try{const e=a("token");if(!e)return;if(console.log("åŠ è½½æ¶ˆæ¯ï¼Œä¼šè¯ID:",$.value.id),1===O.value){const e=a(`chat_messages_${$.value.id}`);if(e&&e.messages&&e.messages.length>0){if(Date.now()-e.cacheTime<3e5)return console.log("ä½¿ç”¨ç¼“å­˜æ¶ˆæ¯æ•°æ®"),J.value=e.messages,I((()=>{He()})),void be()}}const l=await B.callFunction("chat",{action:"getMessages",data:{conversationId:$.value.id,page:O.value,pageSize:20},token:e});if(l&&0===l.code){const e=l.data||[],a=e.filter((e=>"image"===e.message_type||"mixed"===e.message_type));a.length>0&&console.log("å‰ç«¯è·å–åˆ°çš„å›¾ç‰‡æ¶ˆæ¯:",a.map((e=>({message_id:e.message_id,message_type:e.message_type,content:e.content,images:e.images,text_content:e.text_content})))),1===O.value?(J.value=e,t(`chat_messages_${$.value.id}`,{messages:e,cacheTime:Date.now()}),I((()=>{He()}))):J.value=[...e,...J.value],q.value=e.length>=20,console.log("æ¶ˆæ¯åŠ è½½æˆåŠŸï¼Œæ•°é‡:",e.length),await $e()}else console.error("åŠ è½½æ¶ˆæ¯å¤±è´¥:",null==l?void 0:l.msg)}catch(e){console.error("åŠ è½½æ¶ˆæ¯å¼‚å¸¸:",e)}finally{K.value=!1}},be=async()=>{try{const e=a("token");if(!e)return;const l=await B.callFunction("chat",{action:"getMessages",data:{conversationId:$.value.id,page:1,pageSize:20},token:e});if(l&&0===l.code){const e=l.data||[];e.length>J.value.length&&(J.value=e,t(`chat_messages_${$.value.id}`,{messages:e,cacheTime:Date.now()}),I((()=>{He()}))),await $e()}}catch(e){console.log("å¼‚æ­¥åŠ è½½æœ€æ–°æ¶ˆæ¯å¤±è´¥:",e)}},Ce=async()=>{!K.value&&q.value&&(K.value=!0,O.value+=1,await ke())},xe=async()=>{var e;if(fe.value)if(!N.value||U.value)try{const l=Q.value,t=l.trim().length>0,s=ae.value.length>0,o=a("token");if(!t&&!s)return;let n="text",c={},i=[...ae.value];s&&t?n="mixed":s&&(n="image"),"text"===n?c.content=l:"image"===n?(c.content=null==(e=i[0])?void 0:e.url,c.images=i.map((e=>e.url))):"mixed"===n&&(c.text_content=l,c.images=i.map((e=>e.url)),c.content=l);const r={message_id:`temp_${Date.now()}`,conversation_id:$.value.id,sender_id:L.value,sender_name:"æˆ‘",message_type:n,send_time:new Date,sending:!0,uploading:s,...c};J.value.push(r),I((()=>{He()}));const u=()=>{Q.value="",ae.value=[]};u(),I((()=>{u()})),s?Ae(r,i,l,n,o):De(r,l,o)}catch(l){u(),console.error("å‘é€æ¶ˆæ¯å¤±è´¥:",l),r({title:"ç½‘ç»œå¼‚å¸¸",icon:"none"})}else r({title:"ç¾¤èŠå·²è¢«ç¦è¨€ï¼Œåªæœ‰ç®¡ç†å‘˜å¯ä»¥å‘è¨€",icon:"none"})},De=async(e,a,l)=>{try{const t=await B.callFunction("chat",{action:"sendMessage",data:{conversationId:$.value.id,content:a,messageType:"text",groupId:"group"===$.value.type?$.value.id:null},token:l});Re(e.message_id,t)}catch(t){console.error("å‘é€æ–‡å­—æ¶ˆæ¯å¤±è´¥:",t),Ze(e.message_id)}},Ae=async(e,a,l,t,s)=>{var o,n,c;try{console.log("å¼€å§‹ä¸Šä¼ å›¾ç‰‡å¹¶å‘é€æ¶ˆæ¯:",a.length,"å¼ å›¾ç‰‡");const i=await Me(a,e.message_id),r=J.value.findIndex((a=>a.message_id===e.message_id));-1!==r?(console.log("æ›´æ–°æœ¬åœ°æ¶ˆæ¯å›¾ç‰‡URL:",{messageType:t,uploadedImages:i.map((e=>{var a;return{url:(null==(a=e.url)?void 0:a.substring(0,50))+"...",originalPath:e.originalPath}})),tempIndex:r}),"image"===t?(J.value[r].content=(null==(o=i[0])?void 0:o.url)||"[å›¾ç‰‡]",J.value[r].images=i.map((e=>e.url))):"mixed"===t&&(J.value[r].images=i.map((e=>e.url))),J.value[r].uploading=!1,console.log("æœ¬åœ°æ¶ˆæ¯æ›´æ–°å®Œæˆ:",{content:null==(n=J.value[r].content)?void 0:n.substring(0,50),images:null==(c=J.value[r].images)?void 0:c.map((e=>(null==e?void 0:e.substring(0,50))+"...")),uploading:J.value[r].uploading})):console.error("æœªæ‰¾åˆ°è¦æ›´æ–°çš„ä¸´æ—¶æ¶ˆæ¯:",e.message_id);const u={conversationId:$.value.id,messageType:t,groupId:"group"===$.value.type?$.value.id:null};"image"===t?(u.content="[å›¾ç‰‡]",u.images=i.map((e=>e.url))):"mixed"===t&&(u.content=l,u.textContent=l,u.images=i.map((e=>e.url))),console.log("å‘é€å›¾ç‰‡æ¶ˆæ¯åˆ°æœåŠ¡å™¨ï¼ˆå«äº‘å­˜å‚¨URLï¼‰:",{...u,imagesCount:i.length});const d=await B.callFunction("chat",{action:"sendMessage",data:u,token:s});console.log("å›¾ç‰‡æ¶ˆæ¯å‘é€ç»“æœ:",d),Re(e.message_id,d)}catch(i){console.error("å‘é€å›¾ç‰‡æ¶ˆæ¯å¤±è´¥:",i),Ze(e.message_id)}},Me=async(e,l)=>{const t=[];for(let o=0;o<e.length;o++){const l=e[o];try{console.log(`å¼€å§‹ä¸Šä¼ ç¬¬${o+1}å¼ å›¾ç‰‡:`,l.url);const e=await Pe(l.url),s=await B.callFunction("upload",{action:"uploadImage",data:{base64Data:e,fileName:`chat_image_${Date.now()}_${o}.jpg`,type:"chat"},token:a("token")});s&&0===s.code?(t.push({url:s.data.url,fileID:s.data.fileID,originalPath:l.url}),console.log(`ç¬¬${o+1}å¼ å›¾ç‰‡ä¸Šä¼ æˆåŠŸ:`,s.data.url.substring(0,50)+"...")):(console.error(`ç¬¬${o+1}å¼ å›¾ç‰‡ä¸Šä¼ å¤±è´¥:`,s),r({title:`ç¬¬${o+1}å¼ å›¾ç‰‡ä¸Šä¼ å¤±è´¥`,icon:"none",duration:2e3}),t.push({url:"data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KICA8cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjZjBmMGYwIi8+CiAgPHRleHQgeD0iNTAlIiB5PSI1MCUiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIxNiIgZmlsbD0iIzk5OSIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9Ii4zZW0iPuS4iuS8oOWksei0pTwvdGV4dD4KPC9zdmc+",fileID:null,originalPath:l.url}))}catch(s){console.error(`ç¬¬${o+1}å¼ å›¾ç‰‡å¤„ç†å¤±è´¥:`,s);const e=s.message||s.errMsg||"æœªçŸ¥é”™è¯¯";r({title:`å›¾ç‰‡${o+1}å¤„ç†å¤±è´¥: ${e}`,icon:"none",duration:3e3}),t.push({url:"data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KICA8cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjZjBmMGYwIi8+CiAgPHRleHQgeD0iNTAlIiB5PSI1MCUiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIxNiIgZmlsbD0iIzk5OSIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9Ii4zZW0iPuWksei0pTwvdGV4dD4KPC9zdmc+",fileID:null,originalPath:l.url,error:e})}}return t},Pe=async a=>new Promise(((l,t)=>{try{if(console.log("å¼€å§‹è¯»å–å›¾ç‰‡æ–‡ä»¶:",a,"å½“å‰å¹³å°:",e().platform),!a||a.length<5)throw new Error("æ— æ•ˆçš„å›¾ç‰‡è·¯å¾„");const s=e();if("h5"===s.platform||"undefined"!=typeof window)return console.log("H5ç¯å¢ƒï¼šä½¿ç”¨Canvasæ–¹æ³•è¯»å–å›¾ç‰‡"),void Fe(a).then(l).catch(t);console.log("å°ç¨‹åº/Appç¯å¢ƒï¼šä½¿ç”¨æ–‡ä»¶ç³»ç»ŸAPI");if(("android"===s.platform||"ios"===s.platform)&&"undefined"!=typeof plus&&plus.io)return console.log("Appç¯å¢ƒï¼šå°è¯•ä½¿ç”¨plus.io API"),void Se(a).then(l).catch((e=>{console.warn("plus.ioå¤±è´¥ï¼Œå›é€€åˆ°æ–‡ä»¶ç³»ç»ŸAPI:",e),Te(a).then(l).catch(t)}));Te(a).then(l).catch(t)}catch(s){console.error("è¯»å–å›¾ç‰‡æ–‡ä»¶å¼‚å¸¸:",s),t(s)}})),Se=async e=>new Promise(((a,l)=>{try{console.log("ä½¿ç”¨plus.io APIè¯»å–å›¾ç‰‡:",e);let t=e;e.startsWith("file://")&&(t=e.replace("file://","")),plus.io.resolveLocalFileSystemURL(t,(e=>{e.file((e=>{const t=new plus.io.FileReader;t.onloadend=e=>{e.target&&e.target.result?(console.log("plus.ioè¯»å–æˆåŠŸï¼Œæ•°æ®é•¿åº¦:",e.target.result.length),a(e.target.result)):l(new Error("plus.ioè¯»å–ç»“æœä¸ºç©º"))},t.onerror=e=>{console.error("plus.io FileReaderé”™è¯¯:",e),l(new Error("plus.io FileReaderè¯»å–å¤±è´¥"))},t.readAsDataURL(e)}),(e=>{console.error("plus.ioè·å–æ–‡ä»¶å¯¹è±¡å¤±è´¥:",e),l(new Error(`plus.ioè·å–æ–‡ä»¶å¯¹è±¡å¤±è´¥: ${e.message||"æœªçŸ¥é”™è¯¯"}`))}))}),(e=>{console.error("plus.ioè§£ææ–‡ä»¶è·¯å¾„å¤±è´¥:",e),l(new Error(`plus.ioè§£ææ–‡ä»¶è·¯å¾„å¤±è´¥: ${e.message||"æœªçŸ¥é”™è¯¯"}`))}))}catch(t){console.error("plus.ioè¯»å–å¼‚å¸¸:",t),l(t)}})),Te=async e=>new Promise(((a,l)=>{try{const t=uni.getFileSystemManager();if(!t||"function"!=typeof t.readFile)return console.error("æ–‡ä»¶ç³»ç»Ÿç®¡ç†å™¨ä¸å¯ç”¨"),void l(new Error("æ–‡ä»¶ç³»ç»Ÿç®¡ç†å™¨ä¸å¯ç”¨"));t.readFile({filePath:e,encoding:"base64",success:t=>{if(t&&t.data){console.log("æ–‡ä»¶ç³»ç»ŸAPIè¯»å–æˆåŠŸï¼Œæ•°æ®é•¿åº¦:",t.data.length);let l="image/jpeg";e.toLowerCase().includes(".png")?l="image/png":e.toLowerCase().includes(".gif")?l="image/gif":e.toLowerCase().includes(".webp")&&(l="image/webp"),a(`data:${l};base64,${t.data}`)}else console.error("è¯»å–æ–‡ä»¶è¿”å›ç©ºæ•°æ®"),l(new Error("è¯»å–æ–‡ä»¶è¿”å›ç©ºæ•°æ®"))},fail:s=>{console.error("æ–‡ä»¶ç³»ç»ŸAPIç¬¬ä¸€æ¬¡è¯»å–å¤±è´¥:",s),t.readFile({filePath:e,success:e=>{if(e&&e.data)try{const l=d(e.data);console.log("ArrayBufferè½¬æ¢æˆåŠŸï¼Œæ•°æ®é•¿åº¦:",l.length),a(`data:image/jpeg;base64,${l}`)}catch(t){console.error("è½¬æ¢ArrayBufferå¤±è´¥:",t),l(new Error(`ArrayBufferè½¬æ¢å¤±è´¥: ${t.message}`))}else l(new Error("ç¬¬äºŒæ¬¡è¯»å–æ–‡ä»¶ä¹Ÿè¿”å›ç©ºæ•°æ®"))},fail:e=>{console.error("æ–‡ä»¶ç³»ç»ŸAPIç¬¬äºŒæ¬¡è¯»å–ä¹Ÿå¤±è´¥:",e),l(new Error(`æ–‡ä»¶ç³»ç»ŸAPIè¯»å–å¤±è´¥: ${e.errMsg||e.message||"æœªçŸ¥é”™è¯¯"}`))}})}})}catch(t){console.error("æ–‡ä»¶ç³»ç»ŸAPIè¯»å–å¼‚å¸¸:",t),l(t)}})),Fe=async e=>new Promise(((a,l)=>{try{if(console.log("H5 Canvasæ–¹æ³•è¯»å–å›¾ç‰‡:",e),e.startsWith("data:"))return console.log("å·²ç»æ˜¯base64æ ¼å¼ï¼Œç›´æ¥è¿”å›"),void a(e);if(e.startsWith("blob:"))return console.log("å¤„ç†blob URL"),void fetch(e).then((e=>e.blob())).then((e=>{const t=new FileReader;t.onload=e=>{a(e.target.result)},t.onerror=e=>{console.error("FileReaderè¯»å–å¤±è´¥:",e),l(new Error("FileReaderè¯»å–å¤±è´¥"))},t.readAsDataURL(e)})).catch((e=>{console.error("fetch blobå¤±è´¥:",e),l(e)}));const t=new Image;t.crossOrigin="anonymous",t.onload=()=>{try{const e=document.createElement("canvas"),l=e.getContext("2d");e.width=t.width,e.height=t.height,l.drawImage(t,0,0);const s=e.toDataURL("image/jpeg",.8);console.log("Canvasè½¬æ¢æˆåŠŸï¼Œæ•°æ®é•¿åº¦:",s.length),a(s)}catch(e){console.error("Canvasè½¬æ¢å¤±è´¥:",e),l(e)}},t.onerror=e=>{console.error("å›¾ç‰‡åŠ è½½å¤±è´¥:",e),l(new Error("å›¾ç‰‡åŠ è½½å¤±è´¥"))},t.src=e}catch(t){console.error("H5å›¾ç‰‡è¯»å–å¼‚å¸¸:",t),l(t)}})),Re=(e,a)=>{const l=J.value.findIndex((a=>a.message_id===e));-1!==l&&(a&&0===a.code?J.value[l]={...J.value[l],message_id:a.data.messageId,send_time:a.data.sendTime,sending:!1,uploading:!1}:Ze(e))},Ze=e=>{const a=J.value.findIndex((a=>a.message_id===e));-1!==a&&(J.value[a]={...J.value[a],sending:!1,uploading:!1,sendError:!0},r({title:"å‘é€å¤±è´¥",icon:"none"}))},ze=async()=>{try{const e=a("token"),l=await B.callFunction("chat",{action:"getGroupMembers",data:{groupId:$.value.id},token:e});l&&0===l.code&&(ee.value=l.data.length)}catch(e){console.error("è·å–ç¾¤æˆå‘˜æ•°é‡å¤±è´¥:",e)}},Be=async()=>{try{const e=a("token");if(!e)return void console.log("æ£€æŸ¥ç®¡ç†å‘˜æƒé™å¤±è´¥: ç¼ºå°‘token");console.log("å¼€å§‹æ£€æŸ¥ç®¡ç†å‘˜æƒé™");const l=await B.callFunction("user",{action:"checkAdminStatus",token:e});console.log("checkAdminStatus ç»“æœ:",l),l&&0===l.code?(U.value=l.is_admin,console.log("ç®¡ç†å‘˜æƒé™è®¾ç½®ä¸º:",U.value)):console.log("checkAdminStatus è°ƒç”¨å¤±è´¥:",l)}catch(e){console.error("æ£€æŸ¥ç®¡ç†å‘˜æƒé™å¤±è´¥:",e)}},We=async()=>{try{const e=a("token");if(!e||!$.value.id)return void console.log("æ£€æŸ¥ç¾¤èŠçŠ¶æ€å¤±è´¥: ç¼ºå°‘tokenæˆ–chatInfo.id",{token:!!e,chatId:$.value.id});console.log("å¼€å§‹æ£€æŸ¥ç¾¤èŠçŠ¶æ€, chatInfo.id:",$.value.id);const l=await B.callFunction("chat",{action:"getGroupInfo",data:{groupId:$.value.id},token:e});if(console.log("getGroupInfo ç»“æœ:",l),l&&0===l.code){const e=l.data;console.log("ç¾¤èŠä¿¡æ¯:",e),N.value=e.is_muted||!1,console.log("ç¾¤èŠç¦è¨€çŠ¶æ€è®¾ç½®ä¸º:",N.value,"åŸå§‹å€¼:",e.is_muted)}else console.log("getGroupInfo è°ƒç”¨å¤±è´¥:",l)}catch(e){console.error("æ£€æŸ¥ç¾¤èŠçŠ¶æ€å¤±è´¥:",e)}},je=async()=>{try{const e=a("token");if(!e||!$.value.id)return void console.log("åŠ è½½èŠå¤©å®¤ä¿¡æ¯å¤±è´¥: ç¼ºå°‘tokenæˆ–chatInfo.id",{token:!!e,chatId:$.value.id});console.log("å¼€å§‹åŠ è½½èŠå¤©å®¤ä¿¡æ¯, chatInfo.id:",$.value.id);const l=await B.callFunction("chat",{action:"getRoomInfo",data:{roomId:$.value.id},token:e});if(console.log("getRoomInfo ç»“æœ:",l),l&&0===l.code&&l.room){const e=l.room;console.log("èŠå¤©å®¤è¯¦ç»†ä¿¡æ¯:",e),e.avatar&&($.value.avatar=e.avatar,console.log("æ›´æ–°èŠå¤©å®¤å¤´åƒ:",e.avatar)),e.title&&($.value.title=e.title,console.log("æ›´æ–°èŠå¤©å®¤æ ‡é¢˜:",e.title)),t("currentChatInfo",$.value)}else console.log("getRoomInfo è°ƒç”¨å¤±è´¥æˆ–æ— æ•°æ®:",l)}catch(e){console.error("åŠ è½½èŠå¤©å®¤ä¿¡æ¯å¤±è´¥:",e)}},$e=async()=>{var e;try{const l=a("token")||a("userToken");if(!l)return void console.log("æœªæ‰¾åˆ°tokenï¼Œè·³è¿‡æ ‡è®°å·²è¯»");console.log("æ ‡è®°æ¶ˆæ¯å·²è¯»ï¼Œä¼šè¯ID:",$.value.id);const t=await B.callFunction("chat",{action:"markAsRead",data:{conversationId:$.value.id},token:l});t&&0===t.code?console.log("æ ‡è®°å·²è¯»æˆåŠŸï¼Œæ›´æ–°äº†",null==(e=t.data)?void 0:e.updatedCount,"æ¡æ¶ˆæ¯"):console.log("æ ‡è®°å·²è¯»å¤±è´¥:",null==t?void 0:t.msg)}catch(l){console.error("æ ‡è®°å·²è¯»å¤±è´¥:",l)}},He=()=>{X.value="message-bottom",setTimeout((()=>{X.value=""}),100)},Ee=()=>{console.log("è¾“å…¥æ¡†è·å¾—ç„¦ç‚¹"),setTimeout((()=>{He()}),300)},Le=()=>{console.log("è¾“å…¥æ¡†å¤±å»ç„¦ç‚¹")},Ge=()=>{},Ue=e=>{console.log("ç²˜è´´äº‹ä»¶:",e)},Ne=()=>{const a=e().platform;if(console.log("å½“å‰å¹³å°:",a),"h5"===a||"undefined"!=typeof window)return console.log("H5ç¯å¢ƒï¼šä½¿ç”¨åŸç”Ÿinputé€‰æ‹©å›¾ç‰‡"),void Ve();"function"==typeof uni.chooseMedia?(console.log("ä½¿ç”¨ chooseMedia APIï¼ˆæ‰‹æœºç«¯ï¼‰"),uni.chooseMedia({count:9-ae.value.length,mediaType:["image"],sizeType:["original","compressed"],sourceType:["album","camera"],success:e=>{console.log("chooseMedia é€‰æ‹©å›¾ç‰‡æˆåŠŸ:",e);(e.tempFiles||[]).forEach((e=>{ae.value.push({url:e.tempFilePath,isTemp:!0,size:e.size,type:e.fileType})})),I((()=>{He()}))},fail:e=>{console.error("chooseMedia å¤±è´¥ï¼Œå°è¯•ä½¿ç”¨ chooseImage:",e),Je()}})):(console.log("chooseMedia ä¸å¯ç”¨ï¼Œä½¿ç”¨ chooseImage APIï¼ˆå°ç¨‹åºç«¯ï¼‰"),Je())},Ve=()=>{const e=document.createElement("input");e.type="file",e.accept="image/*",e.multiple=!0,e.style.display="none",e.onchange=a=>{const l=a.target.files;if(!l||0===l.length)return void console.log("H5: æœªé€‰æ‹©æ–‡ä»¶");console.log("H5: é€‰æ‹©äº†",l.length,"ä¸ªæ–‡ä»¶");const t=9-ae.value.length;Array.from(l).slice(0,t).forEach(((e,a)=>{const l=URL.createObjectURL(e);ae.value.push({url:l,isTemp:!0,size:e.size,type:e.type,file:e}),console.log(`H5: æ·»åŠ å›¾ç‰‡${a+1}:`,{name:e.name,size:e.size,type:e.type,url:l.substring(0,50)+"..."})})),I((()=>{He()})),document.body.removeChild(e)},e.oncancel=()=>{console.log("H5: ç”¨æˆ·å–æ¶ˆé€‰æ‹©"),document.body.removeChild(e)},document.body.appendChild(e),e.click()},Je=()=>{g({count:9-ae.value.length,sizeType:["original","compressed"],sourceType:["album","camera"],success:e=>{console.log("chooseImage é€‰æ‹©å›¾ç‰‡æˆåŠŸ:",e);(e.tempFilePaths||[]).forEach((e=>{ae.value.push({url:e,isTemp:!0})})),I((()=>{He()}))},fail:e=>{console.error("é€‰æ‹©å›¾ç‰‡å¤±è´¥:",e),r({title:"é€‰æ‹©å›¾ç‰‡å¤±è´¥",icon:"none"})}})},Qe=e=>{le.value=e,te.value=!0},Ye=()=>{te.value=!1,le.value="",Xe()},Xe=()=>{se.value=1,oe.value=0,ne.value=0,de.value=!1},Ke=e=>{console.log("å›¾ç‰‡åŠ è½½å®Œæˆ:",e),Xe()},Oe=(e,a)=>{const l=e.clientX-a.clientX,t=e.clientY-a.clientY;return Math.sqrt(l*l+t*t)},qe=e=>{const a=e.touches;ce.value=Date.now(),1===a.length?(de.value=!0,ge.value=a[0].clientX,me.value=a[0].clientY,ve.value=oe.value,pe.value=ne.value):2===a.length&&(de.value=!1,re.value=Oe(a[0],a[1]),ue.value=se.value)},ea=e=>{e.preventDefault();const a=e.touches;if(1===a.length&&de.value&&se.value>1){const e=a[0].clientX-ge.value,l=a[0].clientY-me.value;oe.value=ve.value+e/se.value,ne.value=pe.value+l/se.value;const t=150*(se.value-1),s=150*(se.value-1);oe.value=Math.max(-t,Math.min(t,oe.value)),ne.value=Math.max(-s,Math.min(s,ne.value))}else if(2===a.length){const e=Oe(a[0],a[1])/re.value;let l=ue.value*e;l=Math.max(.5,Math.min(5,l)),se.value=l,l<1.1&&(oe.value=0,ne.value=0)}},aa=e=>{const a=Date.now();a-ce.value<300&&1===e.changedTouches.length&&(a-ie.value<500&&(se.value>1.5?(se.value=1,oe.value=0,ne.value=0):(se.value=2,oe.value=0,ne.value=0)),ie.value=a),de.value=!1},la=e=>{se.value<=1.1&&setTimeout((()=>{Ye()}),100)},ta=e=>{var a,l,t;if(console.log("getImageSrc å¤„ç†æ¶ˆæ¯:",{message_id:e.message_id,message_type:e.message_type,sender_id:e.sender_id,content:e.content,images:e.images,hasImages:e.images&&e.images.length>0,isMyMessage:e.sender_id===L.value}),e.images&&e.images.length>0){const l=e.images[0];return console.log("getImageSrc: ä½¿ç”¨imageså­—æ®µçš„ç¬¬ä¸€å¼ å›¾ç‰‡:",typeof l,null==(a=null==l?void 0:l.substring)?void 0:a.call(l,0,50)),sa(l)}return"image"===e.message_type||"mixed"===e.message_type?(console.log("getImageSrc: å›¾ç‰‡æ¶ˆæ¯ä½†æ— imageså­—æ®µï¼Œä½¿ç”¨content:",typeof e.content,null==(t=null==(l=e.content)?void 0:l.substring)?void 0:t.call(l,0,50)),sa(e.content)):(console.log("getImageSrc: ä½¿ç”¨é»˜è®¤contentå­—æ®µ:",e.content),sa(e.content))},sa=e=>{if(!e)return console.warn("getImageUrl: å›¾ç‰‡æ•°æ®ä¸ºç©º"),"";if(console.log("getImageUrlå¤„ç†æ•°æ®:",{type:typeof e,isString:"string"==typeof e,startsWith:"string"==typeof e?{http:e.startsWith("http"),data:e.startsWith("data:image/"),isPlaceholder:"[å›¾ç‰‡]"===e||e.includes("[å›¾ç‰‡]")}:null,preview:"string"==typeof e?e.substring(0,100)+"...":e}),"string"==typeof e)return e.startsWith("http")?(console.log("getImageUrl: è¿”å›HTTP URL:",e.substring(0,50)+"..."),e):e.startsWith("data:image/")?(console.log("getImageUrl: è¿”å›base64æ ¼å¼å›¾ç‰‡ï¼Œé•¿åº¦:",e.length),e):"[å›¾ç‰‡]"===e||e.includes("[å›¾ç‰‡]")?(console.log("getImageUrl: è¿”å›å ä½ç¬¦å›¾ç‰‡"),"data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KICA8cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjZjBmMGYwIi8+CiAgPHRleHQgeD0iNTAlIiB5PSI1MCUiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIxNiIgZmlsbD0iIzk5OSIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9Ii4zZW0iPuWbvueJhzwvdGV4dD4KPC9zdmc+"):(console.log("getImageUrl: è¿”å›åŸå§‹æ•°æ®ï¼ˆå¯èƒ½æ˜¯æœ¬åœ°è·¯å¾„ï¼‰:",e),e);if("object"==typeof e){const a=e.url||e.base64||e.path||"";return console.log("getImageUrl: ä»å¯¹è±¡è·å–URL:",(null==a?void 0:a.substring(0,50))+"..."),a}return console.log("getImageUrl: æ— æ³•å¤„ç†çš„æ•°æ®æ ¼å¼ï¼Œè¿”å›ç©º"),""},oa=(e,a)=>{if(0===a)return!0;const l=J.value[a-1];return new Date(e.send_time).getTime()-new Date(l.send_time).getTime()>3e5},na=e=>{const a=new Date(e),l=new Date;if(a.toDateString()===l.toDateString())return a.toLocaleTimeString("zh-CN",{hour:"2-digit",minute:"2-digit"});const t=new Date(l);return t.setDate(l.getDate()-1),a.toDateString()===t.toDateString()?"æ˜¨å¤© "+a.toLocaleTimeString("zh-CN",{hour:"2-digit",minute:"2-digit"}):`${a.getMonth()+1}æœˆ${a.getDate()}æ—¥ ${a.toLocaleTimeString("zh-CN",{hour:"2-digit",minute:"2-digit"})}`},ca=()=>{Ie=setInterval((async()=>{await ia(),"group"===$.value.type&&await We()}),3e3)},ia=async()=>{try{if(0===J.value.length)return;const e=a("token");if(!e)return;const l=J.value[J.value.length-1].send_time;console.log("æ£€æŸ¥æ–°æ¶ˆæ¯ï¼Œæœ€åæ¶ˆæ¯æ—¶é—´:",l);const s=await B.callFunction("chat",{action:"getMessages",data:{conversationId:$.value.id,page:1,pageSize:10,afterTime:l},token:e});if(s&&0===s.code){const e=(s.data||[]).filter((e=>!J.value.some((a=>a.message_id===e.message_id||a.content===e.content&&a.sender_id===e.sender_id&&Math.abs(new Date(a.send_time)-new Date(e.send_time))<5e3))));e.length>0&&(console.log("æ”¶åˆ°æ–°æ¶ˆæ¯:",e.length,"æ¡",e),J.value.push(...e),t(`chat_messages_${$.value.id}`,{messages:J.value,cacheTime:Date.now()}),I((()=>{He()})),await $e())}}catch(e){console.log("æ£€æŸ¥æ–°æ¶ˆæ¯å¤±è´¥:",e)}},ra=["#FF6B6B","#4ECDC4","#45B7D1","#96CEB4","#FFEAA7","#DDA0DD","#98D8C8","#F7DC6F","#BB8FCE","#85C1E9","#F8C471","#82E0AA","#F1948A","#85C1E9","#D5A6BD"],ua=e=>{if(!e)return ra[0];let a=0;for(let t=0;t<e.length;t++)a=e.charCodeAt(t)+((a<<5)-a);const l=Math.abs(a)%ra.length;return ra[l]},da=()=>{const e=$.value.id||$.value.title||"default";let a=0;for(let t=0;t<e.length;t++)a=e.charCodeAt(t)+((a<<5)-a);const l=Math.abs(a)%ra.length;return ra[l]},ga=e=>e&&e.startsWith('ã€æ¥è‡ªèŠå¤©å®¤"')&&e.includes("ã€‘\n"),ma=e=>{if(!ga(e))return"";const a=e.match(/^ã€æ¥è‡ªèŠå¤©å®¤"(.+?)"ã€‘/);return a?`ã€æ¥è‡ªèŠå¤©å®¤"${a[1]}"ã€‘`:""},va=e=>{if(!ga(e))return e;const a=e.split("ã€‘\n");return a.length>1?a[1]:e},pa=()=>{console.log("[ChatRoom] é€€å‡ºèŠå¤©å®¤:",$.value.title),Ie&&(clearInterval(Ie),Ie=null),$.value.id&&(console.log("[ChatRoom] ç¡®ä¿ä¼šè¯å·²è¯»:",$.value.id),j.markAsRead($.value.id)),m("chatRoomClosed",{conversationId:$.value.id}),v()};return(e,a)=>{const l=s,t=o,r=c,u=n,d=i;return b(),w(l,{class:"chat-room"},{default:k((()=>[C(l,{class:"page-background"}),C(l,{class:"nav-bar",style:D({paddingTop:H.value+"px",height:E.value+"px"})},{default:k((()=>[C(l,{class:"nav-content"},{default:k((()=>[C(l,{class:"nav-left",onClick:pa},{default:k((()=>[C(l,{class:"back-arrow"})])),_:1}),C(l,{class:"nav-center"},{default:k((()=>[C(t,{class:"chat-title"},{default:k((()=>[A(M($.value.title),1)])),_:1})])),_:1}),C(l,{class:"nav-right"})])),_:1})])),_:1},8,["style"]),C(u,{class:"message-list",style:D({paddingTop:H.value+E.value+"px",paddingBottom:"120rpx"}),"scroll-y":"true","scroll-top":Y.value,"scroll-into-view":X.value,onScrolltoupper:Ce,"show-scrollbar":!1,"enable-back-to-top":!1},{default:k((()=>[K.value?(b(),w(l,{key:0,class:"loading-more"},{default:k((()=>[C(t,null,{default:k((()=>[A("åŠ è½½ä¸­...")])),_:1})])),_:1})):x("",!0),C(l,{class:"messages"},{default:k((()=>[(b(!0),P(S,null,T(J.value,((e,a)=>(b(),w(l,{key:e.message_id,id:`msg-${a}`,class:F(["message-item",{"is-mine":e.sender_id===L.value}])},{default:k((()=>[oa(e,a)?(b(),w(l,{key:0,class:"time-divider"},{default:k((()=>[C(t,{class:"time-text"},{default:k((()=>[A(M(na(e.send_time)),1)])),_:2},1024)])),_:2},1024)):x("",!0),C(l,{class:"message-content"},{default:k((()=>[e.sender_id!==L.value?(b(),w(l,{key:0,class:"message-left"},{default:k((()=>[C(l,{class:"sender-avatar"},{default:k((()=>[$.value.avatar?(b(),w(r,{key:0,class:"avatar-image",src:$.value.avatar,mode:"aspectFill"},null,8,["src"])):(b(),w(l,{key:1,class:"avatar-placeholder",style:D({background:da()})},{default:k((()=>[C(t,{class:"avatar-text"},{default:k((()=>{var e;return[A(M((null==(e=$.value.title)?void 0:e.charAt(0))||"èŠ"),1)]})),_:1})])),_:1},8,["style"]))])),_:1}),C(l,{class:"message-info"},{default:k((()=>[C(l,{class:"sender-name"},{default:k((()=>[A(M(e.sender_name),1)])),_:2},1024),C(l,{class:"message-bubble left-bubble"},{default:k((()=>["text"===e.message_type?(b(),w(l,{key:0,class:"message-text"},{default:k((()=>[ga(e.content)?(b(),w(l,{key:0,class:"sync-message"},{default:k((()=>[C(l,{class:"sync-source"},{default:k((()=>[A(M(ma(e.content)),1)])),_:2},1024),C(l,{class:"sync-content"},{default:k((()=>[A(M(va(e.content)),1)])),_:2},1024)])),_:2},1024)):(b(),w(t,{key:1},{default:k((()=>[A(M(e.content),1)])),_:2},1024))])),_:2},1024)):"image"===e.message_type?(b(),w(l,{key:1,class:"message-image-container"},{default:k((()=>[C(l,{class:F(["image-wrapper",{uploading:e.uploading}])},{default:k((()=>[C(r,{src:ta(e),class:"message-image",mode:"aspectFill",onClick:a=>Qe(ta(e))},null,8,["src","onClick"]),e.uploading?(b(),w(l,{key:0,class:"upload-mask"},{default:k((()=>[C(l,{class:"upload-spinner"}),C(t,{class:"upload-text"},{default:k((()=>[A("ä¸Šä¼ ä¸­...")])),_:1})])),_:1})):x("",!0)])),_:2},1032,["class"])])),_:2},1024)):"mixed"===e.message_type?(b(),w(l,{key:2,class:"message-mixed"},{default:k((()=>[e.text_content?(b(),w(l,{key:0,class:"message-text"},{default:k((()=>[A(M(e.text_content),1)])),_:2},1024)):x("",!0),e.images&&e.images.length>0?(b(),w(l,{key:1,class:"message-images"},{default:k((()=>[(b(!0),P(S,null,T(e.images,((a,t)=>(b(),w(l,{key:t,class:F(["image-wrapper",{uploading:e.uploading}])},{default:k((()=>[C(r,{src:sa(a),class:"message-image",mode:"aspectFill",onClick:e=>Qe(sa(a))},null,8,["src","onClick"]),e.uploading?(b(),w(l,{key:0,class:"upload-mask"},{default:k((()=>[C(l,{class:"upload-spinner"})])),_:1})):x("",!0)])),_:2},1032,["class"])))),128))])),_:2},1024)):x("",!0)])),_:2},1024)):x("",!0)])),_:2},1024)])),_:2},1024)])),_:2},1024)):(b(),w(l,{key:1,class:"message-right"},{default:k((()=>[C(l,{class:"message-bubble right-bubble"},{default:k((()=>["text"===e.message_type?(b(),w(l,{key:0,class:"message-text"},{default:k((()=>[ga(e.content)?(b(),w(l,{key:0,class:"sync-message"},{default:k((()=>[C(l,{class:"sync-source"},{default:k((()=>[A(M(ma(e.content)),1)])),_:2},1024),C(l,{class:"sync-content"},{default:k((()=>[A(M(va(e.content)),1)])),_:2},1024)])),_:2},1024)):(b(),w(t,{key:1},{default:k((()=>[A(M(e.content),1)])),_:2},1024))])),_:2},1024)):"image"===e.message_type?(b(),w(l,{key:1,class:"message-image-container"},{default:k((()=>[C(l,{class:F(["image-wrapper",{uploading:e.uploading}])},{default:k((()=>[C(r,{src:ta(e),class:"message-image",mode:"aspectFill",onClick:a=>Qe(ta(e))},null,8,["src","onClick"]),e.uploading?(b(),w(l,{key:0,class:"upload-mask"},{default:k((()=>[C(l,{class:"upload-spinner"}),C(t,{class:"upload-text"},{default:k((()=>[A("ä¸Šä¼ ä¸­...")])),_:1})])),_:1})):x("",!0)])),_:2},1032,["class"])])),_:2},1024)):"mixed"===e.message_type?(b(),w(l,{key:2,class:"message-mixed"},{default:k((()=>[e.text_content?(b(),w(l,{key:0,class:"message-text"},{default:k((()=>[A(M(e.text_content),1)])),_:2},1024)):x("",!0),e.images&&e.images.length>0?(b(),w(l,{key:1,class:"message-images"},{default:k((()=>[(b(!0),P(S,null,T(e.images,((a,t)=>(b(),w(l,{key:t,class:F(["image-wrapper",{uploading:e.uploading}])},{default:k((()=>[C(r,{src:sa(a),class:"message-image",mode:"aspectFill",onClick:e=>Qe(sa(a))},null,8,["src","onClick"]),e.uploading?(b(),w(l,{key:0,class:"upload-mask"},{default:k((()=>[C(l,{class:"upload-spinner"})])),_:1})):x("",!0)])),_:2},1032,["class"])))),128))])),_:2},1024)):x("",!0)])),_:2},1024)):x("",!0),e.sending||e.sendError?(b(),w(l,{key:3,class:"message-status"},{default:k((()=>[e.sending?(b(),w(l,{key:0,class:"sending-indicator"},{default:k((()=>[C(l,{class:"sending-spinner"})])),_:1})):x("",!0),e.sendError?(b(),w(l,{key:1,class:"error-indicator"},{default:k((()=>[C(t,{class:"error-icon"},{default:k((()=>[A("!")])),_:1})])),_:1})):x("",!0)])),_:2},1024)):x("",!0)])),_:2},1024),C(l,{class:"sender-avatar"},{default:k((()=>[C(l,{class:"avatar-placeholder",style:D({background:ua(L.value)})},{default:k((()=>[C(t,{class:"avatar-text"},{default:k((()=>{var e;return[A(M((null==(e=G.value.nickname||G.value.mobile||"æˆ‘")?void 0:e.charAt(0))||"æˆ‘"),1)]})),_:1})])),_:1},8,["style"])])),_:1})])),_:2},1024))])),_:2},1024)])),_:2},1032,["id","class"])))),128))])),_:1}),C(l,{class:"message-bottom",id:"message-bottom"})])),_:1},8,["style","scroll-top","scroll-into-view"]),V.value?(b(),w(l,{key:0,class:"loading-status"},{default:k((()=>[C(l,{class:"loading-container"},{default:k((()=>[C(l,{class:"loading-spinner"}),C(t,{class:"loading-text"},{default:k((()=>[A("æ­£åœ¨åŠ è½½èŠå¤©çŠ¶æ€...")])),_:1})])),_:1})])),_:1})):x("",!0),_e.value?(b(),w(l,{key:1,class:"input-area"},{default:k((()=>[ae.value.length>0?(b(),w(l,{key:0,class:"image-preview-area"},{default:k((()=>[C(u,{class:"image-preview-scroll","scroll-x":"true","show-scrollbar":!1},{default:k((()=>[C(l,{class:"image-preview-list"},{default:k((()=>[(b(!0),P(S,null,T(ae.value,((e,a)=>(b(),w(l,{key:a,class:"preview-image-item"},{default:k((()=>[C(r,{src:e.url,class:"preview-image",mode:"aspectFill",onClick:a=>Qe(e.url)},null,8,["src","onClick"]),C(l,{class:"remove-image-btn",onClick:e=>(e=>{ae.value.splice(e,1)})(a)},{default:k((()=>[C(t,{class:"remove-text"},{default:k((()=>[A("Ã—")])),_:1})])),_:2},1032,["onClick"])])),_:2},1024)))),128))])),_:1})])),_:1})])),_:1})):x("",!0),C(l,{class:"input-container"},{default:k((()=>[C(l,{class:"input-actions"},{default:k((()=>[C(l,{class:"action-btn camera-btn",onClick:Ne},{default:k((()=>[C(l,{class:"camera-icon"},{default:k((()=>[C(l,{class:"camera-body"},{default:k((()=>[C(l,{class:"camera-lens"},{default:k((()=>[C(l,{class:"camera-lens-inner"})])),_:1}),C(l,{class:"camera-flash"}),C(l,{class:"camera-viewfinder"})])),_:1})])),_:1})])),_:1})])),_:1}),C(l,{class:"input-wrapper"},{default:k((()=>[C(d,{class:"message-input",modelValue:Q.value,"onUpdate:modelValue":a[0]||(a[0]=e=>Q.value=e),placeholder:"è¾“å…¥æ¶ˆæ¯,æ”¯æŒæ¢è¡Œ,æ”¯æŒå›¾ç‰‡","auto-height":!0,maxlength:500,"adjust-position":!0,"cursor-spacing":10,onFocus:Ee,onBlur:Le,onInput:Ge,onPaste:Ue,"confirm-type":"return"},null,8,["modelValue"])])),_:1}),C(l,{class:F(["send-btn",{disabled:!fe.value}]),onClick:xe},{default:k((()=>[C(t,{class:"send-text"},{default:k((()=>[A("å‘é€")])),_:1})])),_:1},8,["class"])])),_:1})])),_:1})):x("",!0),ye.value?(b(),w(l,{key:2,class:"mute-notice"},{default:k((()=>[C(l,{class:"mute-container"},{default:k((()=>[C(l,{class:"mute-icon"},{default:k((()=>[A("ğŸ”‡")])),_:1}),C(t,{class:"mute-text"},{default:k((()=>[A("ç¾¤èŠå·²è¢«ç¦è¨€ï¼Œåªæœ‰ç®¡ç†å‘˜å¯ä»¥å‘è¨€")])),_:1})])),_:1})])),_:1})):x("",!0),te.value?(b(),w(l,{key:3,class:"image-preview-modal",onClick:Ye},{default:k((()=>[C(l,{class:"preview-modal-content",onClick:a[1]||(a[1]=R((()=>{}),["stop"]))},{default:k((()=>[C(l,{class:"preview-close-btn",onClick:Ye},{default:k((()=>[C(t,{class:"close-icon"},{default:k((()=>[A("Ã—")])),_:1})])),_:1}),C(l,{class:"zoomable-image-container",onTouchstart:qe,onTouchmove:ea,onTouchend:aa,onClick:la},{default:k((()=>[C(r,{src:le.value,class:"preview-modal-image",mode:"aspectFit",style:D(he.value),onLoad:Ke},null,8,["src","style"])])),_:1}),C(l,{class:"preview-tips"},{default:k((()=>[C(t,{class:"tip-text"},{default:k((()=>[A("åŒå‡»æˆ–åŒæŒ‡ç¼©æ”¾ â€¢ æ‹–æ‹½ç§»åŠ¨ â€¢ ç‚¹å‡»å…³é—­")])),_:1})])),_:1})])),_:1})])),_:1})):x("",!0)])),_:1})}}}),[["__scopeId","data-v-881eecee"]]);export{H as default};
