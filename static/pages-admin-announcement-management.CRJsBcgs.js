import{t as e,k as a,c as t,R as l,I as n,S as s,K as o,P as c,L as u,l as i,d as r,b as d,h as v}from"./uni.CnKTWU0K.js";import{d as f,b as _,R as m,a6 as g,ad as y,a7 as h,M as p,aW as k,aP as w,_ as S,aY as x,aX as b,aN as C,az as T,ak as $,ai as I}from"./vendor.CqD9dFNX.js";import{a as O}from"./index-C3v_m0JD.js";import{_ as A}from"./_plugin-vue_export-helper.BCo6x5W8.js";const D=A(f({__name:"announcement-management",setup(f){const A=_(20),D=_(null),F=_([]),N=_(!1),j=_(""),J=_(!1),E=_(!1);m((()=>{M()}));const M=async()=>{try{const a=e();A.value=a.statusBarHeight||20}catch(a){console.warn("获取系统信息失败，使用默认值:",a),A.value=20}await V(),await B()},V=async()=>{try{if(!a("token"))return t({title:"请先登录",icon:"none"}),void setTimeout((()=>{l()}),1500);console.log("已登录，允许访问公告管理页面")}catch(e){console.error("检查管理员权限失败:",e),console.log("权限检查失败，但允许继续访问")}},B=async()=>{try{console.log("开始加载公告数据...");try{const e=a("token"),t=await O.callFunction("announcement",{action:"getAllAnnouncements",token:e});if(console.log("云函数返回结果:",t),t&&0===t.code){const e=t.data||[],a=e.find((e=>e.is_active));return D.value=a||null,F.value=e,void console.log("从云函数加载公告数据成功:",{current:D.value,total:F.value.length})}}catch(e){console.log("云函数调用失败，尝试本地存储:",e);const l=a("local_announcements");if(l)try{const e=JSON.parse(l);return D.value=e.current||null,F.value=e.history||[],void console.log("从本地存储加载公告数据")}catch(t){console.error("解析本地公告数据失败:",t)}}D.value=null,F.value=[],console.log("使用默认空状态")}catch(l){console.error("加载公告异常:",l),D.value=null,F.value=[]}},H=()=>{var e;j.value=(null==(e=D.value)?void 0:e.content)||"",N.value=!0},P=()=>{N.value=!1,j.value=""},R=()=>{},Y=async()=>{var e,l;if(j.value.trim()){J.value=!0;try{console.log("开始保存公告...");try{const e=a("token"),l=D.value&&D.value._id,n=l?"updateAnnouncement":"createAnnouncement",s={content:j.value.trim(),is_active:!0};l&&(s.id=D.value._id),console.log("调用云函数:",n,s);const o=await O.callFunction("announcement",{action:n,data:s,token:e});if(console.log("云函数保存结果:",o),o&&0===o.code)return t({title:"保存成功",icon:"success"}),P(),void setTimeout((async()=>{await B()}),500);throw new Error((null==o?void 0:o.msg)||"保存失败")}catch(n){console.log("云函数保存失败，使用本地存储:",n);const a=new Date,s={_id:(null==(e=D.value)?void 0:e._id)||Date.now().toString(),content:j.value.trim(),is_active:!0,create_time:(null==(l=D.value)?void 0:l.create_time)||a.toISOString(),update_time:a.toISOString()};if(D.value){D.value={...D.value,...s};const e=F.value.findIndex((e=>e._id===D.value._id));-1!==e&&(F.value[e]=D.value)}else D.value=s,F.value.unshift(s);const o={current:D.value,history:F.value};i("local_announcements",JSON.stringify(o)),t({title:"保存成功（本地）",icon:"success"}),P()}}catch(s){console.error("保存公告失败:",s),t({title:"保存失败",icon:"none"})}finally{J.value=!1}}else t({title:"请输入公告内容",icon:"none"})},z=async()=>{if(!D.value||E.value)return;const e=D.value.is_active?"停用":"启用";try{if(!(await r({title:"确认操作",content:`确定要${e}当前公告吗？`})).confirm)return;E.value=!0;try{const l=a("token"),n=await O.callFunction("announcement",{action:"toggleAnnouncementStatus",data:{id:D.value._id},token:l});if(console.log("切换状态云函数结果:",n),n&&0===n.code)return t({title:`${e}成功`,icon:"success"}),void setTimeout((async()=>{await B()}),500);throw new Error((null==n?void 0:n.msg)||`${e}失败`)}catch(l){console.log("云函数切换状态失败，使用本地存储:",l),D.value.is_active=!D.value.is_active,D.value.update_time=(new Date).toISOString();const a=F.value.findIndex((e=>e._id===D.value._id));-1!==a&&(F.value[a]={...D.value});const n={current:D.value,history:F.value};i("local_announcements",JSON.stringify(n)),t({title:`${e}成功（本地）`,icon:"success"})}}catch(n){console.error("切换状态失败:",n),n.message&&n.message.includes("404")?t({title:"公告功能暂未开放",icon:"none",duration:2e3}):t({title:"网络异常",icon:"none"})}finally{E.value=!1}},K=async()=>{if(D.value)try{if(!(await r({title:"确认删除",content:"确定要删除当前公告吗？删除后无法恢复。",confirmColor:"#ff4757"})).confirm)return;d({title:"删除中..."});try{const e=a("token"),l=await O.callFunction("announcement",{action:"deleteAnnouncement",data:{id:D.value._id},token:e});if(console.log("删除公告云函数结果:",l),l&&0===l.code)return v(),t({title:"删除成功",icon:"success"}),void setTimeout((async()=>{await B()}),500);throw new Error((null==l?void 0:l.msg)||"删除失败")}catch(e){console.log("云函数删除失败，使用本地存储:",e);const a=D.value._id;F.value=F.value.filter((e=>e._id!==a)),D.value=null;const l={current:null,history:F.value};i("local_announcements",JSON.stringify(l)),v(),t({title:"删除成功（本地）",icon:"success"})}}catch(l){v(),console.error("删除公告失败:",l),l.message&&l.message.includes("404")?t({title:"公告功能暂未开放",icon:"none",duration:2e3}):t({title:"网络异常",icon:"none"})}},L=e=>{if(!e)return"";const a=new Date(e);return`${a.getFullYear()}-${String(a.getMonth()+1).padStart(2,"0")}-${String(a.getDate()).padStart(2,"0")} ${String(a.getHours()).padStart(2,"0")}:${String(a.getMinutes()).padStart(2,"0")}`},U=()=>{l()};return(e,a)=>{const t=n,l=o,i=s,r=c,d=u;return h(),g(t,{class:"announcement-management"},{default:y((()=>[p(t,{class:"page-background"}),p(t,{class:"nav-bar",style:w({paddingTop:A.value+"px",height:A.value+"px"})},{default:y((()=>[p(t,{class:"nav-content"},{default:y((()=>[p(t,{class:"nav-left",onClick:U},{default:y((()=>[p(t,{class:"back-arrow"})])),_:1}),p(t,{class:"nav-center"},{default:y((()=>[S("公告管理")])),_:1}),p(t,{class:"nav-right"})])),_:1})])),_:1},8,["style"]),p(i,{class:"content","scroll-y":"true",style:w({paddingTop:58+A.value+"px",paddingBottom:"120rpx"})},{default:y((()=>[p(t,{class:"current-announcement-section"},{default:y((()=>[p(t,{class:"section-header"},{default:y((()=>[p(l,{class:"section-title"},{default:y((()=>[S("当前公告")])),_:1}),p(t,{class:"edit-btn",onClick:H},{default:y((()=>[p(l,null,{default:y((()=>[S(x(D.value?"编辑":"创建"),1)])),_:1})])),_:1})])),_:1}),D.value?(h(),g(t,{key:0,class:"announcement-display"},{default:y((()=>[p(t,{class:"announcement-content"},{default:y((()=>[p(l,{class:"content-text"},{default:y((()=>[S(x(D.value.content),1)])),_:1})])),_:1}),p(t,{class:"announcement-meta"},{default:y((()=>[p(l,{class:"meta-text"},{default:y((()=>[S("发布时间："+x(L(D.value.createTime)),1)])),_:1}),p(l,{class:"meta-text"},{default:y((()=>[S("更新时间："+x(L(D.value.updateTime)),1)])),_:1})])),_:1}),p(t,{class:"announcement-actions"},{default:y((()=>[p(t,{class:"action-btn danger",onClick:K},{default:y((()=>[S("删除公告")])),_:1}),p(t,{class:b(["action-btn",{disabled:E.value}]),onClick:z},{default:y((()=>[E.value?(h(),g(l,{key:0},{default:y((()=>[S("处理中...")])),_:1})):(h(),g(l,{key:1},{default:y((()=>[S(x(D.value.is_active?"停用":"启用"),1)])),_:1}))])),_:1},8,["class"])])),_:1})])),_:1})):(h(),g(t,{key:1,class:"empty-announcement"},{default:y((()=>[p(t,{class:"empty-icon"},{default:y((()=>[S("📢")])),_:1}),p(l,{class:"empty-text"},{default:y((()=>[S("暂无公告")])),_:1}),p(l,{class:"empty-hint"},{default:y((()=>[S('点击右上角"创建"按钮发布公告')])),_:1})])),_:1}))])),_:1}),p(t,{class:"history-section"},{default:y((()=>[p(t,{class:"section-header"},{default:y((()=>[p(l,{class:"section-title"},{default:y((()=>[S("历史公告")])),_:1}),p(l,{class:"history-count"},{default:y((()=>[S("共 "+x(F.value.length)+" 条",1)])),_:1})])),_:1}),F.value.length>0?(h(),g(t,{key:0,class:"history-list"},{default:y((()=>[(h(!0),C(T,null,$(F.value,((e,a)=>(h(),g(t,{key:e._id,class:"history-item"},{default:y((()=>[p(t,{class:"history-content"},{default:y((()=>[p(l,{class:"history-text"},{default:y((()=>[S(x(e.content),1)])),_:2},1024)])),_:2},1024),p(t,{class:"history-meta"},{default:y((()=>[p(l,{class:"meta-text"},{default:y((()=>[S(x(L(e.createTime)),1)])),_:2},1024),p(t,{class:b(["status-tag",{active:e.is_active}])},{default:y((()=>[S(x(e.is_active?"已启用":"已停用"),1)])),_:2},1032,["class"])])),_:2},1024)])),_:2},1024)))),128))])),_:1})):(h(),g(t,{key:1,class:"empty-history"},{default:y((()=>[p(l,{class:"empty-text"},{default:y((()=>[S("暂无历史公告")])),_:1})])),_:1}))])),_:1})])),_:1},8,["style"]),N.value?(h(),g(t,{key:0,class:"modal",onClick:P},{default:y((()=>[p(t,{class:"modal-content",onClick:a[1]||(a[1]=I((()=>{}),["stop"]))},{default:y((()=>[p(t,{class:"modal-header"},{default:y((()=>[p(l,{class:"modal-title"},{default:y((()=>[S(x(D.value?"编辑公告":"创建公告"),1)])),_:1}),p(t,{class:"modal-close",onClick:P},{default:y((()=>[p(l,{class:"close-icon"},{default:y((()=>[S("✕")])),_:1})])),_:1})])),_:1}),p(t,{class:"modal-body"},{default:y((()=>[p(t,{class:"form-item"},{default:y((()=>[p(l,{class:"form-label"},{default:y((()=>[S("公告内容")])),_:1}),p(r,{class:"form-textarea",modelValue:j.value,"onUpdate:modelValue":a[0]||(a[0]=e=>j.value=e),placeholder:"请输入公告内容，支持换行...",maxlength:1e3,"auto-height":"",onInput:R},null,8,["modelValue"]),p(t,{class:"char-count"},{default:y((()=>[S(x(j.value.length)+"/1000",1)])),_:1})])),_:1}),p(t,{class:"preview-section"},{default:y((()=>[p(l,{class:"preview-label"},{default:y((()=>[S("预览效果：")])),_:1}),p(t,{class:"preview-content"},{default:y((()=>[p(l,{class:"preview-text"},{default:y((()=>[S(x(j.value||"暂无内容"),1)])),_:1})])),_:1})])),_:1})])),_:1}),p(t,{class:"modal-footer"},{default:y((()=>[p(d,{class:"cancel-btn",onClick:P},{default:y((()=>[S("取消")])),_:1}),p(d,{class:"confirm-btn",onClick:Y,disabled:!j.value.trim()||J.value},{default:y((()=>[J.value?(h(),g(l,{key:0},{default:y((()=>[S("保存中...")])),_:1})):(h(),g(l,{key:1},{default:y((()=>[S(x(D.value?"更新":"发布"),1)])),_:1}))])),_:1},8,["disabled"])])),_:1})])),_:1})])),_:1})):k("",!0)])),_:1})}}}),[["__scopeId","data-v-deb86ecc"]]);export{D as default};
