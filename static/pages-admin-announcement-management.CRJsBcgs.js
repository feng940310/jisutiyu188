import{t as e,k as a,c as t,R as l,I as n,S as s,K as o,P as c,L as u,l as i,d as r,b as d,h as v}from"./uni.CnKTWU0K.js";import{d as f,b as _,R as m,a6 as g,ad as y,a7 as h,M as p,aW as k,aP as w,_ as S,aY as x,aX as b,aN as C,az as T,ak as $,ai as I}from"./vendor.CqD9dFNX.js";import{a as O}from"./index-C3v_m0JD.js";import{_ as A}from"./_plugin-vue_export-helper.BCo6x5W8.js";const D=A(f({__name:"announcement-management",setup(f){const A=_(20),D=_(null),F=_([]),N=_(!1),j=_(""),J=_(!1),E=_(!1);m((()=>{M()}));const M=async()=>{try{const a=e();A.value=a.statusBarHeight||20}catch(a){console.warn("è·å–ç³»ç»Ÿä¿¡æ¯å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤å€¼:",a),A.value=20}await V(),await B()},V=async()=>{try{if(!a("token"))return t({title:"è¯·å…ˆç™»å½•",icon:"none"}),void setTimeout((()=>{l()}),1500);console.log("å·²ç™»å½•ï¼Œå…è®¸è®¿é—®å…¬å‘Šç®¡ç†é¡µé¢")}catch(e){console.error("æ£€æŸ¥ç®¡ç†å‘˜æƒé™å¤±è´¥:",e),console.log("æƒé™æ£€æŸ¥å¤±è´¥ï¼Œä½†å…è®¸ç»§ç»­è®¿é—®")}},B=async()=>{try{console.log("å¼€å§‹åŠ è½½å…¬å‘Šæ•°æ®...");try{const e=a("token"),t=await O.callFunction("announcement",{action:"getAllAnnouncements",token:e});if(console.log("äº‘å‡½æ•°è¿”å›ç»“æœ:",t),t&&0===t.code){const e=t.data||[],a=e.find((e=>e.is_active));return D.value=a||null,F.value=e,void console.log("ä»äº‘å‡½æ•°åŠ è½½å…¬å‘Šæ•°æ®æˆåŠŸ:",{current:D.value,total:F.value.length})}}catch(e){console.log("äº‘å‡½æ•°è°ƒç”¨å¤±è´¥ï¼Œå°è¯•æœ¬åœ°å­˜å‚¨:",e);const l=a("local_announcements");if(l)try{const e=JSON.parse(l);return D.value=e.current||null,F.value=e.history||[],void console.log("ä»æœ¬åœ°å­˜å‚¨åŠ è½½å…¬å‘Šæ•°æ®")}catch(t){console.error("è§£ææœ¬åœ°å…¬å‘Šæ•°æ®å¤±è´¥:",t)}}D.value=null,F.value=[],console.log("ä½¿ç”¨é»˜è®¤ç©ºçŠ¶æ€")}catch(l){console.error("åŠ è½½å…¬å‘Šå¼‚å¸¸:",l),D.value=null,F.value=[]}},H=()=>{var e;j.value=(null==(e=D.value)?void 0:e.content)||"",N.value=!0},P=()=>{N.value=!1,j.value=""},R=()=>{},Y=async()=>{var e,l;if(j.value.trim()){J.value=!0;try{console.log("å¼€å§‹ä¿å­˜å…¬å‘Š...");try{const e=a("token"),l=D.value&&D.value._id,n=l?"updateAnnouncement":"createAnnouncement",s={content:j.value.trim(),is_active:!0};l&&(s.id=D.value._id),console.log("è°ƒç”¨äº‘å‡½æ•°:",n,s);const o=await O.callFunction("announcement",{action:n,data:s,token:e});if(console.log("äº‘å‡½æ•°ä¿å­˜ç»“æœ:",o),o&&0===o.code)return t({title:"ä¿å­˜æˆåŠŸ",icon:"success"}),P(),void setTimeout((async()=>{await B()}),500);throw new Error((null==o?void 0:o.msg)||"ä¿å­˜å¤±è´¥")}catch(n){console.log("äº‘å‡½æ•°ä¿å­˜å¤±è´¥ï¼Œä½¿ç”¨æœ¬åœ°å­˜å‚¨:",n);const a=new Date,s={_id:(null==(e=D.value)?void 0:e._id)||Date.now().toString(),content:j.value.trim(),is_active:!0,create_time:(null==(l=D.value)?void 0:l.create_time)||a.toISOString(),update_time:a.toISOString()};if(D.value){D.value={...D.value,...s};const e=F.value.findIndex((e=>e._id===D.value._id));-1!==e&&(F.value[e]=D.value)}else D.value=s,F.value.unshift(s);const o={current:D.value,history:F.value};i("local_announcements",JSON.stringify(o)),t({title:"ä¿å­˜æˆåŠŸï¼ˆæœ¬åœ°ï¼‰",icon:"success"}),P()}}catch(s){console.error("ä¿å­˜å…¬å‘Šå¤±è´¥:",s),t({title:"ä¿å­˜å¤±è´¥",icon:"none"})}finally{J.value=!1}}else t({title:"è¯·è¾“å…¥å…¬å‘Šå†…å®¹",icon:"none"})},z=async()=>{if(!D.value||E.value)return;const e=D.value.is_active?"åœç”¨":"å¯ç”¨";try{if(!(await r({title:"ç¡®è®¤æ“ä½œ",content:`ç¡®å®šè¦${e}å½“å‰å…¬å‘Šå—ï¼Ÿ`})).confirm)return;E.value=!0;try{const l=a("token"),n=await O.callFunction("announcement",{action:"toggleAnnouncementStatus",data:{id:D.value._id},token:l});if(console.log("åˆ‡æ¢çŠ¶æ€äº‘å‡½æ•°ç»“æœ:",n),n&&0===n.code)return t({title:`${e}æˆåŠŸ`,icon:"success"}),void setTimeout((async()=>{await B()}),500);throw new Error((null==n?void 0:n.msg)||`${e}å¤±è´¥`)}catch(l){console.log("äº‘å‡½æ•°åˆ‡æ¢çŠ¶æ€å¤±è´¥ï¼Œä½¿ç”¨æœ¬åœ°å­˜å‚¨:",l),D.value.is_active=!D.value.is_active,D.value.update_time=(new Date).toISOString();const a=F.value.findIndex((e=>e._id===D.value._id));-1!==a&&(F.value[a]={...D.value});const n={current:D.value,history:F.value};i("local_announcements",JSON.stringify(n)),t({title:`${e}æˆåŠŸï¼ˆæœ¬åœ°ï¼‰`,icon:"success"})}}catch(n){console.error("åˆ‡æ¢çŠ¶æ€å¤±è´¥:",n),n.message&&n.message.includes("404")?t({title:"å…¬å‘ŠåŠŸèƒ½æš‚æœªå¼€æ”¾",icon:"none",duration:2e3}):t({title:"ç½‘ç»œå¼‚å¸¸",icon:"none"})}finally{E.value=!1}},K=async()=>{if(D.value)try{if(!(await r({title:"ç¡®è®¤åˆ é™¤",content:"ç¡®å®šè¦åˆ é™¤å½“å‰å…¬å‘Šå—ï¼Ÿåˆ é™¤åæ— æ³•æ¢å¤ã€‚",confirmColor:"#ff4757"})).confirm)return;d({title:"åˆ é™¤ä¸­..."});try{const e=a("token"),l=await O.callFunction("announcement",{action:"deleteAnnouncement",data:{id:D.value._id},token:e});if(console.log("åˆ é™¤å…¬å‘Šäº‘å‡½æ•°ç»“æœ:",l),l&&0===l.code)return v(),t({title:"åˆ é™¤æˆåŠŸ",icon:"success"}),void setTimeout((async()=>{await B()}),500);throw new Error((null==l?void 0:l.msg)||"åˆ é™¤å¤±è´¥")}catch(e){console.log("äº‘å‡½æ•°åˆ é™¤å¤±è´¥ï¼Œä½¿ç”¨æœ¬åœ°å­˜å‚¨:",e);const a=D.value._id;F.value=F.value.filter((e=>e._id!==a)),D.value=null;const l={current:null,history:F.value};i("local_announcements",JSON.stringify(l)),v(),t({title:"åˆ é™¤æˆåŠŸï¼ˆæœ¬åœ°ï¼‰",icon:"success"})}}catch(l){v(),console.error("åˆ é™¤å…¬å‘Šå¤±è´¥:",l),l.message&&l.message.includes("404")?t({title:"å…¬å‘ŠåŠŸèƒ½æš‚æœªå¼€æ”¾",icon:"none",duration:2e3}):t({title:"ç½‘ç»œå¼‚å¸¸",icon:"none"})}},L=e=>{if(!e)return"";const a=new Date(e);return`${a.getFullYear()}-${String(a.getMonth()+1).padStart(2,"0")}-${String(a.getDate()).padStart(2,"0")} ${String(a.getHours()).padStart(2,"0")}:${String(a.getMinutes()).padStart(2,"0")}`},U=()=>{l()};return(e,a)=>{const t=n,l=o,i=s,r=c,d=u;return h(),g(t,{class:"announcement-management"},{default:y((()=>[p(t,{class:"page-background"}),p(t,{class:"nav-bar",style:w({paddingTop:A.value+"px",height:A.value+"px"})},{default:y((()=>[p(t,{class:"nav-content"},{default:y((()=>[p(t,{class:"nav-left",onClick:U},{default:y((()=>[p(t,{class:"back-arrow"})])),_:1}),p(t,{class:"nav-center"},{default:y((()=>[S("å…¬å‘Šç®¡ç†")])),_:1}),p(t,{class:"nav-right"})])),_:1})])),_:1},8,["style"]),p(i,{class:"content","scroll-y":"true",style:w({paddingTop:58+A.value+"px",paddingBottom:"120rpx"})},{default:y((()=>[p(t,{class:"current-announcement-section"},{default:y((()=>[p(t,{class:"section-header"},{default:y((()=>[p(l,{class:"section-title"},{default:y((()=>[S("å½“å‰å…¬å‘Š")])),_:1}),p(t,{class:"edit-btn",onClick:H},{default:y((()=>[p(l,null,{default:y((()=>[S(x(D.value?"ç¼–è¾‘":"åˆ›å»º"),1)])),_:1})])),_:1})])),_:1}),D.value?(h(),g(t,{key:0,class:"announcement-display"},{default:y((()=>[p(t,{class:"announcement-content"},{default:y((()=>[p(l,{class:"content-text"},{default:y((()=>[S(x(D.value.content),1)])),_:1})])),_:1}),p(t,{class:"announcement-meta"},{default:y((()=>[p(l,{class:"meta-text"},{default:y((()=>[S("å‘å¸ƒæ—¶é—´ï¼š"+x(L(D.value.createTime)),1)])),_:1}),p(l,{class:"meta-text"},{default:y((()=>[S("æ›´æ–°æ—¶é—´ï¼š"+x(L(D.value.updateTime)),1)])),_:1})])),_:1}),p(t,{class:"announcement-actions"},{default:y((()=>[p(t,{class:"action-btn danger",onClick:K},{default:y((()=>[S("åˆ é™¤å…¬å‘Š")])),_:1}),p(t,{class:b(["action-btn",{disabled:E.value}]),onClick:z},{default:y((()=>[E.value?(h(),g(l,{key:0},{default:y((()=>[S("å¤„ç†ä¸­...")])),_:1})):(h(),g(l,{key:1},{default:y((()=>[S(x(D.value.is_active?"åœç”¨":"å¯ç”¨"),1)])),_:1}))])),_:1},8,["class"])])),_:1})])),_:1})):(h(),g(t,{key:1,class:"empty-announcement"},{default:y((()=>[p(t,{class:"empty-icon"},{default:y((()=>[S("ğŸ“¢")])),_:1}),p(l,{class:"empty-text"},{default:y((()=>[S("æš‚æ— å…¬å‘Š")])),_:1}),p(l,{class:"empty-hint"},{default:y((()=>[S('ç‚¹å‡»å³ä¸Šè§’"åˆ›å»º"æŒ‰é’®å‘å¸ƒå…¬å‘Š')])),_:1})])),_:1}))])),_:1}),p(t,{class:"history-section"},{default:y((()=>[p(t,{class:"section-header"},{default:y((()=>[p(l,{class:"section-title"},{default:y((()=>[S("å†å²å…¬å‘Š")])),_:1}),p(l,{class:"history-count"},{default:y((()=>[S("å…± "+x(F.value.length)+" æ¡",1)])),_:1})])),_:1}),F.value.length>0?(h(),g(t,{key:0,class:"history-list"},{default:y((()=>[(h(!0),C(T,null,$(F.value,((e,a)=>(h(),g(t,{key:e._id,class:"history-item"},{default:y((()=>[p(t,{class:"history-content"},{default:y((()=>[p(l,{class:"history-text"},{default:y((()=>[S(x(e.content),1)])),_:2},1024)])),_:2},1024),p(t,{class:"history-meta"},{default:y((()=>[p(l,{class:"meta-text"},{default:y((()=>[S(x(L(e.createTime)),1)])),_:2},1024),p(t,{class:b(["status-tag",{active:e.is_active}])},{default:y((()=>[S(x(e.is_active?"å·²å¯ç”¨":"å·²åœç”¨"),1)])),_:2},1032,["class"])])),_:2},1024)])),_:2},1024)))),128))])),_:1})):(h(),g(t,{key:1,class:"empty-history"},{default:y((()=>[p(l,{class:"empty-text"},{default:y((()=>[S("æš‚æ— å†å²å…¬å‘Š")])),_:1})])),_:1}))])),_:1})])),_:1},8,["style"]),N.value?(h(),g(t,{key:0,class:"modal",onClick:P},{default:y((()=>[p(t,{class:"modal-content",onClick:a[1]||(a[1]=I((()=>{}),["stop"]))},{default:y((()=>[p(t,{class:"modal-header"},{default:y((()=>[p(l,{class:"modal-title"},{default:y((()=>[S(x(D.value?"ç¼–è¾‘å…¬å‘Š":"åˆ›å»ºå…¬å‘Š"),1)])),_:1}),p(t,{class:"modal-close",onClick:P},{default:y((()=>[p(l,{class:"close-icon"},{default:y((()=>[S("âœ•")])),_:1})])),_:1})])),_:1}),p(t,{class:"modal-body"},{default:y((()=>[p(t,{class:"form-item"},{default:y((()=>[p(l,{class:"form-label"},{default:y((()=>[S("å…¬å‘Šå†…å®¹")])),_:1}),p(r,{class:"form-textarea",modelValue:j.value,"onUpdate:modelValue":a[0]||(a[0]=e=>j.value=e),placeholder:"è¯·è¾“å…¥å…¬å‘Šå†…å®¹ï¼Œæ”¯æŒæ¢è¡Œ...",maxlength:1e3,"auto-height":"",onInput:R},null,8,["modelValue"]),p(t,{class:"char-count"},{default:y((()=>[S(x(j.value.length)+"/1000",1)])),_:1})])),_:1}),p(t,{class:"preview-section"},{default:y((()=>[p(l,{class:"preview-label"},{default:y((()=>[S("é¢„è§ˆæ•ˆæœï¼š")])),_:1}),p(t,{class:"preview-content"},{default:y((()=>[p(l,{class:"preview-text"},{default:y((()=>[S(x(j.value||"æš‚æ— å†…å®¹"),1)])),_:1})])),_:1})])),_:1})])),_:1}),p(t,{class:"modal-footer"},{default:y((()=>[p(d,{class:"cancel-btn",onClick:P},{default:y((()=>[S("å–æ¶ˆ")])),_:1}),p(d,{class:"confirm-btn",onClick:Y,disabled:!j.value.trim()||J.value},{default:y((()=>[J.value?(h(),g(l,{key:0},{default:y((()=>[S("ä¿å­˜ä¸­...")])),_:1})):(h(),g(l,{key:1},{default:y((()=>[S(x(D.value?"æ›´æ–°":"å‘å¸ƒ"),1)])),_:1}))])),_:1},8,["disabled"])])),_:1})])),_:1})])),_:1})):k("",!0)])),_:1})}}}),[["__scopeId","data-v-deb86ecc"]]);export{D as default};
