import{p as a,k as e,c as l,R as t,I as s,K as u,S as n,J as c,M as o,L as i,d,b as r,h as v}from"./uni.CnKTWU0K.js";import{Z as f}from"./index-C3v_m0JD.js";import{d as _,b as m,c as p,R as k,a6 as h,ad as y,aP as g,a7 as b,M as x,_ as w,aX as C,aW as T,aY as I,aN as j,az as F,ak as S}from"./vendor.CqD9dFNX.js";import{_ as M}from"./_plugin-vue_export-helper.BCo6x5W8.js";const V=M(_({__name:"coupon-management",setup(_){const M=m(20),V=m([]),z=m([]),A=m(!1),L=m(!1),P=m(!0),R=m(1),U=[5,10,20,50,100],$=m(null),B=m(""),D=p((()=>B.value?parseFloat(B.value)||0:$.value||0)),H=p((()=>z.value.length>0&&D.value>0));k((async()=>{a({success:a=>{M.value=a.statusBarHeight||20},fail:()=>{M.value=20}}),await J(),K()}));const J=async()=>{try{const a=e("token");if(!a)return l({title:"请先登录",icon:"none"}),void setTimeout((()=>{t()}),1500);const{result:s}=await f.callFunction({name:"user",data:{action:"checkAdminStatus",token:a}});if(!s||0!==s.code||!s.is_admin)return l({title:"无管理员权限",icon:"none"}),void setTimeout((()=>{t()}),1500)}catch(a){console.error("检查管理员权限失败:",a),l({title:"权限检查失败",icon:"none"}),setTimeout((()=>{t()}),1500)}},K=async()=>{if(!L.value&&P.value){L.value=!0;try{const a=e("token");if(!a)return l({title:"请先登录",icon:"none"}),void setTimeout((()=>{t()}),1500);const{result:s}=await f.callFunction({name:"coupon",data:{action:"getUserList",page:R.value,pageSize:20,token:a}});s&&0===s.code?(1===R.value?V.value=s.data.users||[]:V.value.push(...s.data.users||[]),P.value=s.data.hasMore||!1,P.value&&R.value++):l({title:(null==s?void 0:s.message)||"加载用户失败",icon:"none"})}catch(a){console.error("加载用户列表失败:",a),l({title:"加载用户失败",icon:"none"})}finally{L.value=!1}}},N=()=>{K()},O=()=>{A.value=!A.value,A.value?z.value=V.value.map((a=>a._id)):z.value=[]},W=a=>z.value.includes(a),X=()=>{B.value&&($.value=null)},Y=async()=>{if(!H.value)return void l({title:"请选择用户和设置金额",icon:"none"});if(await new Promise((a=>{d({title:"确认发放",content:`确定向 ${z.value.length} 个用户发放 ${D.value} 元优惠券吗？`,success:e=>{a(e.confirm)},fail:()=>{a(!1)}})}))){r({title:"发放中...",mask:!0});try{const a=e("token");if(!a)return v(),void l({title:"请先登录",icon:"none"});const{result:t}=await f.callFunction({name:"coupon",data:{action:"distributeCoupons",userIds:z.value,amount:D.value,type:"no_threshold",token:a}});v(),t&&0===t.code?(l({title:"发放成功",icon:"success"}),z.value=[],A.value=!1,$.value=null,B.value=""):l({title:(null==t?void 0:t.message)||"发放失败",icon:"none"})}catch(a){v(),console.error("发放优惠券失败:",a),l({title:"发放失败",icon:"none"})}}},Z=()=>{t()};return(a,e)=>{const l=s,t=u,d=c,r=n,v=o,f=i;return b(),h(l,{class:"coupon-management",style:g({paddingTop:M.value+"px"})},{default:y((()=>[x(l,{class:"status-bar",style:g({height:M.value+"px"})},null,8,["style"]),x(l,{class:"nav-bar",style:g({marginTop:M.value+"px"})},{default:y((()=>[x(l,{class:"nav-left",onClick:Z},{default:y((()=>[x(l,{class:"back-arrow"})])),_:1}),x(l,{class:"nav-center"},{default:y((()=>[x(t,{class:"nav-title"},{default:y((()=>[w("优惠券管理")])),_:1})])),_:1}),x(l,{class:"nav-right"})])),_:1},8,["style"]),x(l,{class:"content"},{default:y((()=>[x(l,{class:"section"},{default:y((()=>[x(l,{class:"section-content"},{default:y((()=>[x(l,{class:"section-title"},{default:y((()=>[w("选择用户")])),_:1}),x(l,{class:"select-all-section"},{default:y((()=>[x(l,{class:"select-all-btn",onClick:O},{default:y((()=>[x(l,{class:C(["checkbox",{checked:A.value}])},{default:y((()=>[A.value?(b(),h(t,{key:0,class:"check-icon"},{default:y((()=>[w("✓")])),_:1})):T("",!0)])),_:1},8,["class"]),x(t,{class:"select-all-text"},{default:y((()=>[w("全选所有用户")])),_:1})])),_:1}),x(t,{class:"selected-count"},{default:y((()=>[w("已选择 "+I(z.value.length)+" 个用户",1)])),_:1})])),_:1}),x(r,{class:"user-list","scroll-y":"true",onScrolltolower:N,"lower-threshold":"100"},{default:y((()=>[(b(!0),j(F,null,S(V.value,(a=>(b(),h(l,{class:"user-item",key:a._id,onClick:e=>(a=>{const e=a._id,l=z.value.indexOf(e);l>-1?z.value.splice(l,1):z.value.push(e),A.value=z.value.length===V.value.length})(a)},{default:y((()=>[x(l,{class:"user-info"},{default:y((()=>[x(l,{class:"user-avatar"},{default:y((()=>[a.avatar?(b(),h(d,{key:0,src:a.avatar,class:"avatar-img"},null,8,["src"])):(b(),h(t,{key:1,class:"avatar-text"},{default:y((()=>[w(I(a.nickname?a.nickname.charAt(0):"用"),1)])),_:2},1024))])),_:2},1024),x(l,{class:"user-details"},{default:y((()=>[x(t,{class:"user-nickname"},{default:y((()=>[w(I(a.nickname||"未设置昵称"),1)])),_:2},1024),x(t,{class:"user-id"},{default:y((()=>[w("ID: "+I(a._id),1)])),_:2},1024)])),_:2},1024)])),_:2},1024),x(l,{class:C(["checkbox",{checked:W(a._id)}])},{default:y((()=>[W(a._id)?(b(),h(t,{key:0,class:"check-icon"},{default:y((()=>[w("✓")])),_:1})):T("",!0)])),_:2},1032,["class"])])),_:2},1032,["onClick"])))),128)),L.value?(b(),h(l,{key:0,class:"loading-tip"},{default:y((()=>[x(t,null,{default:y((()=>[w("加载中...")])),_:1})])),_:1})):P.value?T("",!0):(b(),h(l,{key:1,class:"no-more-tip"},{default:y((()=>[x(t,null,{default:y((()=>[w("没有更多用户了")])),_:1})])),_:1}))])),_:1})])),_:1})])),_:1}),x(l,{class:"section"},{default:y((()=>[x(l,{class:"section-content"},{default:y((()=>[x(l,{class:"section-title"},{default:y((()=>[w("设置优惠券金额")])),_:1}),x(l,{class:"preset-amounts"},{default:y((()=>[(b(),j(F,null,S(U,(a=>x(l,{key:a,class:C(["amount-btn",{active:$.value===a}]),onClick:e=>(a=>{$.value=a,B.value=""})(a)},{default:y((()=>[x(t,null,{default:y((()=>[w(I(a)+"元",1)])),_:2},1024)])),_:2},1032,["class","onClick"]))),64))])),_:1}),x(l,{class:"custom-amount"},{default:y((()=>[x(l,{class:"input-label"},{default:y((()=>[w("自定义金额：")])),_:1}),x(v,{class:"amount-input",type:"digit",placeholder:"请输入金额",modelValue:B.value,"onUpdate:modelValue":e[0]||(e[0]=a=>B.value=a),onInput:X},null,8,["modelValue"]),x(t,{class:"input-unit"},{default:y((()=>[w("元")])),_:1})])),_:1}),x(l,{class:"selected-amount-display"},{default:y((()=>[x(t,null,{default:y((()=>[w("当前选择金额：")])),_:1}),x(t,{class:"amount-value"},{default:y((()=>[w(I(D.value)+"元",1)])),_:1})])),_:1})])),_:1})])),_:1}),x(l,{class:"action-section"},{default:y((()=>[x(f,{class:"distribute-btn",disabled:!H.value,onClick:Y},{default:y((()=>[w(" 发放优惠券 ")])),_:1},8,["disabled"])])),_:1})])),_:1})])),_:1},8,["style"])}}}),[["__scopeId","data-v-4716b266"]]);export{V as default};
